<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4bc12c1be68739c7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4bc12c1be68739c7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8d58b9228ffac9a6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8d58b9228ffac9a6.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a602b05d6a5b45c.js" defer=""></script><script src="/_next/static/chunks/451-8446afed8f2a81ca.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-7b5e07e6b1c54b77.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_buildManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_ssgManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style data-emotion="css a6by8m">.css-a6by8m{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;margin:auto;}</style><div class="MuiGrid-root MuiGrid-container css-a6by8m"><style data-emotion="css d0aeej">.css-d0aeej{background-color:#FFF;color:#222;margin:30px auto;padding:36px;}.css-d0aeej h1,.css-d0aeej h2,.css-d0aeej h3{font-weight:550;}</style><style data-emotion="css vx8k43">.css-vx8k43{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;background-color:#FFF;color:#222;margin:30px auto;padding:36px;}@media (min-width:600px){.css-vx8k43{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:900px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1200px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1536px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}.css-vx8k43 h1,.css-vx8k43 h2,.css-vx8k43 h3{font-weight:550;}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-11 MuiGrid-grid-md-9 css-vx8k43"><style data-emotion="css tph460">.css-tph460{padding:15px 0px;border-bottom:1px solid #4682B4;}</style><div class="css-tph460"><style data-emotion="css 1x4m838">.css-1x4m838{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:26px;font-weight:540;padding-bottom:16px;}</style><p class="MuiTypography-root MuiTypography-body1 css-1x4m838">【Laravel × Next.js】Axiosを使ってCSVファイルをダウンロードする</p><style data-emotion="css q5vujz">.css-q5vujz{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:32px;}</style><p class="MuiTypography-root MuiTypography-body2 css-q5vujz"><style data-emotion="css 1eipbkb">.css-1eipbkb{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;font-size:15px;margin-right:4px;vertical-align:middle;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="AccessTimeIcon"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg>投稿日 <!-- -->2022/3/3</p><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LocalOfferIcon"><path d="m21.41 11.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"></path></svg><style data-emotion="css 1lc4u9f">.css-1lc4u9f{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:8px;}</style><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->Laravel</p><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->PHP</p><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->Next.js</p><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->React</p><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->JavaScript</p></div><style data-emotion="css il3arz">.css-il3arz{margin-top:40px;}.css-il3arz a{color:#639bb7;}.css-il3arz a:hover{color:#0b7eb8;-webkit-text-decoration:underline;text-decoration:underline;}</style><div class="css-il3arz"><html><head></head><body><h2 id="h9707d3a59a">概要</h2><p>フロント<code>next.js</code>&nbsp;× API&nbsp;<code>Laravel</code>&nbsp;の構成で作成しているアプリケーションにおいて、<br>「フロント側でとあるボタンをクリックしたら、API側で生成した<strong>CSVファイル</strong>をダウンロードする」<br>という機能を業務で実装する機会があったので、実装方法や勉強になったことをまとめておきます。<br><br>全体の流れは以下の通りです。<br><br>1.　フロント側から<code>Axios</code>を使ってAPIへリクエストを飛ばす。<br>2.　API側（<code>Laravel</code>）でCSVファイルを生成し、レスポンスとして返す。<br>3.　フロント側でレスポンスを受け取り、CSVファイルをダウンロードする。<br></p><h1 id="he52b44f87d">API側の実装</h1><p>API側から実装していきます。<br>※本来はサービスクラスなどへ処理を切り分けるべきではありますが、ここではコントローラーに全ての処理を書くものとします。<br></p><h2 id="hf64c7c1253">ルーティング</h2><p>フロント側（<code>Next.js</code>）から<code>Axios</code>で送られてくるリクエストに対するルーティングを定義します。</p><pre><code class="hljs"><span class="hljs-comment">// routes/api.php</span>

Route::<span class="hljs-keyword">get</span>(<span class="hljs-string">'/download/csv'</span>, [DownloadCsvController::<span class="hljs-keyword">class</span>, <span class="hljs-string">'downloadCsv'</span>]);</code></pre><p>ここで定義した通り、<code>DownloadCsvController</code>の<code>downloadCsv</code>メソッドにCSVファイルを生成してレスポンスとして返す処理をかいていきます。<br></p><h2 id="h2171e4cd81">コントローラー</h2><h3 id="h50212800e7">コードの概要</h3><p>先に概要だけざっくり説明すると、以下の通りです。<br></p><ul><li>Laravelの<code>streamDownload</code>メソッドを使って、CSVファイルをレスポンスとして返す。</li><li><code>streamDownload</code>メソッドは引数を3つ取るので、各引数を用意する。</li></ul><p>・第1引数：エクスポートするファイルを生成するコールバック関数<br>・第2引数：ファイル名<br>・第3引数：レスポンスヘッダーの配列<br><br>※<code>streamDownload</code>メソッドについてはReadoubleの以下の箇所を参照ください。<br><a href="https://readouble.com/laravel/8.x/ja/responses.html?header=%25E3%2582%25B9%25E3%2583%2588%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25A0%25E3%2583%2580%25E3%2582%25A6%25E3%2583%25B3%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%2589#:~:text=%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89,-%E7%89%B9%E5%AE%9A%E3%81%AE%E6%93%8D%E4%BD%9C" target="_blank" rel="noopener noreferrer">HTTPレスポンス 8.x Laravel</a><br></p><h3 id="h2faa5e3f79">コードの全文</h3><p>詳しい解説は後にして、コードの全文を載せます。</p><pre><code class="hljs"><span class="hljs-regexp">//</span> DownloadCsvController.php

/**
 * CSVダウンロード
 * @return StreamedResponse
 */
public <span class="hljs-keyword">function</span> downloadCsv(): StreamedResponse
{
  <span class="hljs-regexp">//</span> CSVファイル作成コールバック
  <span class="hljs-variable">$downloadCsvCallback</span> = <span class="hljs-keyword">function</span> () {
    <span class="hljs-regexp">//</span> CSVファイル作成
    <span class="hljs-variable">$csv</span> = fopen(<span class="hljs-string">'php://output'</span>, <span class="hljs-string">'w'</span>);

    <span class="hljs-regexp">//</span> CSVの<span class="hljs-number">1</span>行目
    <span class="hljs-variable">$colums</span> = [
      <span class="hljs-string">'id'</span> =&gt; <span class="hljs-string">'ユーザーID'</span>,
      <span class="hljs-string">'name'</span> =&gt; <span class="hljs-string">'ユーザー名'</span>,
      <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'メールアドレス'</span>
    ];
    <span class="hljs-regexp">//</span> 文字化け対策
    mb_convert_variables(<span class="hljs-string">'SJIS-win'</span>, <span class="hljs-string">'UTF-8'</span>, <span class="hljs-variable">$colums</span>);
    <span class="hljs-regexp">//</span> CSVの<span class="hljs-number">1</span>行目を記入
    fputcsv(<span class="hljs-variable">$csv</span>, <span class="hljs-variable">$colums</span>);

    <span class="hljs-regexp">//</span> CSVの<span class="hljs-number">2</span>行目以降
    <span class="hljs-variable">$users</span> = User::all();
    foreach (<span class="hljs-variable">$users</span> as <span class="hljs-variable">$user</span>) {
      <span class="hljs-variable">$userData</span> = [
        <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$user</span>-&gt;id,
        <span class="hljs-string">'name'</span> =&gt; <span class="hljs-variable">$user</span>-&gt;name,
        <span class="hljs-string">'email'</span> =&gt; <span class="hljs-variable">$user</span>-&gt;email
      ];
      <span class="hljs-regexp">//</span> 文字化け対策
      mb_convert_variables(<span class="hljs-string">'SJIS-win'</span>, <span class="hljs-string">'UTF-8'</span>, <span class="hljs-variable">$userData</span> );
      <span class="hljs-regexp">//</span> CSVファイルの<span class="hljs-number">2</span>行目以降にユーザー情報を記入
      fputcsv(<span class="hljs-variable">$csv</span>, <span class="hljs-variable">$userData</span>);
    }

    <span class="hljs-regexp">//</span> CSVファイルを閉じる
    fclose(<span class="hljs-variable">$csv</span>);
  }

  <span class="hljs-regexp">//</span> ファイル名
  <span class="hljs-variable">$fileName</span> = <span class="hljs-string">'ユーザー情報.csv'</span>;

  <span class="hljs-regexp">//</span> レスポンスヘッダー情報
  <span class="hljs-variable">$responseHeader</span> = [
    <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'text/csv'</span>,
    <span class="hljs-string">'Access-Control-Expose-Headers'</span> =&gt; <span class="hljs-string">'Content-Disposition'</span>
  ],

  return response()-&gt;streamDownload(<span class="hljs-variable">$downloadCsvCallback</span>, <span class="hljs-variable">$fileName</span>, <span class="hljs-variable">$responseHeader</span>);
}</code></pre><p>ここから上記のコードのポイントを解説していきます。<br></p><h3 id="h3693827ec3">steramDownloadメソッド</h3><ul><li><strong>引数と返り値について</strong></li></ul><p>先述の通り、&nbsp;<code>steramDownload</code>メソッドは以下の3つの引数を取り、返り値は&nbsp;<code>Symfony\Component\HttpFoundation\StreamedResponse</code>となります。<br>　・第1引数：エクスポートするファイルを生成するコールバック関数<br>　・第2引数：ファイル名<br>　・第3引数：レスポンスヘッダーの配列<br><br>今回の構成では、フロント側（<code>Next.js</code>）からAPIリクエストを受け取って<code>StreamedResponse</code>の形式でレスポンスを返すことになります。<br></p><ul><li><strong>レスポンスヘッダーについて</strong></li></ul><p>HTTPレスポンスの際に、ブラウザで表示するのではなくファイルをブラウザでダウンロードさせたい場合は、レスポンスヘッダーに<code>Content-Disposition</code>を持たせる必要があります。<br><a style="color:#4aac00" href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition#:~:text=Content%2DDisposition%3A%20attachment%3B%20filename%3D%22filename.jpg%22" target="_blank" rel="noopener noreferrer">Content-Disposition - HTTP | MDN</a></p><pre><code class="hljs"><span class="hljs-regexp">//</span> レスポンスヘッダーに以下の記述が必要
Content-Disposition: attachment

<span class="hljs-regexp">//</span> ファイル名を指定する場合
Content-Disposition: attachment; filename=<span class="hljs-string">"filename.jpg"</span>

<span class="hljs-regexp">//</span> ファイル名をエンコードする場合
Content-Disposition: attachment; filename*=UTF-<span class="hljs-number">8</span><span class="hljs-string">''</span>URLエンコーディングされたファイル名</code></pre><p>そこで<code>streamDownload</code>メソッドは、この<code>Content-Disposition</code>をよしなにレスポンスヘッダーに加えてくれます。<br><br>以下の画像は、第2引数に<code>'ファイル.csv'</code>と指定してレスポンスを返した際のレスポンスヘッダーを、検証ツールで確認したものです。<br><img src="https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6a50ee5392784850a2205c44dc23d633/%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%83%98%E3%83%83%E3%83%80%E3%83%BC.jpg" alt=""><br>ファイル名に日本語を指定すると、URLエンコーディングされた状態でレスポンスヘッダーに付与されています。<br></p><h3 id="he1a46ab77a">CSVファイル作成コールバック</h3><ul><li><strong>CSVファイルの作成</strong></li></ul><p>コールバック関数内で行う処理の大まかな流れは以下の通りで、<br><code>CSVファイルを作成→中身を書き込む→ファイルを閉じる</code><br>というものです。</p><pre><code class="hljs"><span class="hljs-regexp">//</span> ファイルを作成する
fopen(<span class="hljs-string">'php://output'</span>, <span class="hljs-string">'w'</span>);  

<span class="hljs-regexp">//</span> CSVの<span class="hljs-number">1</span>行目のカラムを記入する
fputcsv(<span class="hljs-variable">$csv</span>, <span class="hljs-variable">$colums</span>);

<span class="hljs-regexp">//</span> CSVの<span class="hljs-number">2</span>行目以降に企業情報を記入する
fputcsv(<span class="hljs-variable">$csv</span>, <span class="hljs-variable">$userData</span>); 

<span class="hljs-regexp">//</span> ファイルを閉じる
fclose(<span class="hljs-variable">$csv</span>);  </code></pre><p><br></p><ul><li><strong>文字化け対策について</strong></li></ul><p>デフォルトの文字コードは、<br>・Excel：<code>SJIS</code><br>・PHP：<code>UTF-8</code>（<code>php.ini</code>で設定されている）<br>という違いがあります。</p><pre><code class="hljs"><span class="hljs-regexp">//</span> php.ini
default_charset = <span class="hljs-string">"UTF-8"</span></code></pre><p>なのでPHPの文字コードが<code>UTF-8</code>のままCSVファイルを生成すると、Excelで開いたときに文字化けしてしまいます。<br><br>これを防ぐため、PHPの<code>mb_convert_variables</code>関数を使って文字コードを<code>UTF-8</code>から<code>SJIS-win</code>に変換します。<br>PHPドキュメント：<a style="color:#4aac00" href="https://www.php.net/manual/ja/function.mb-convert-variables.php" target="_blank" rel="noopener noreferrer">mb_convert_variables</a></p><pre><code class="hljs">mb_convert_variables(<span class="hljs-string">'SJIS-win'</span>, <span class="hljs-string">'UTF-8'</span>, <span class="hljs-symbol">$colums</span>);</code></pre><p>※<code>SJIS-win</code>はWindows向けに使われる<code>Shift-JIS</code>で、通常の<code>SJIS</code>よりも対応している文字が多いようです。<br></p><h3 id="h13b0fcb7b2">レスポンスヘッダーについて</h3><p>先述の通り、<code>streamDownload</code>メソッドがレスポンスヘッダーに<code>Content-Disposition</code>を自動で含めてくれます。<br><br>レスポンスヘッダーの要素はフロント側で&nbsp;<code>AxiosResponse</code>&nbsp;から受け取ることが出来るので、後ほどフロント側でレスポンスヘッダーからファイル名を取得することになります。<br>但し今回のような&nbsp;<code>CORS</code>&nbsp;の通信の場合、標準的なレスポンスヘッダー以外の場合はAPIから返すレスポンスヘッダーに</p><pre><code class="hljs"><span class="hljs-keyword">Access</span>-Control-Expose-Headers: {レスポンスヘッダ名}</code></pre><p>を追加しておかないと、<code>AxiosResponse</code>&nbsp;からレスポンス情報を受け取ることが出来ないので、<code>Content-Disposition</code>については上記の記述が必要です。<br><a style="color:#4aac00" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers" target="_blank" rel="noopener noreferrer">Access-Control-Expose-Headers - HTTP | MDN</a><br>参考記事：<a style="color:#4aac00" href="https://note.kiriukun.com/entry/20200303-axios-response-header-could-not-get" target="_blank" rel="noopener noreferrer">Axiosでレスポンスヘッダが取得できなかった (CORSなAPI)</a><br><br>よって<code>streamDownload</code>メソッドの第3引数には、以下のレスポンスヘッダー情報を渡します。</p><pre><code class="hljs"><span class="hljs-regexp">//</span> レスポンスヘッダー情報
<span class="hljs-variable">$responseHeader</span> = [
  <span class="hljs-string">'Content-type'</span> =&gt; <span class="hljs-string">'text/csv'</span>,
  <span class="hljs-string">'Access-Control-Expose-Headers'</span> =&gt; <span class="hljs-string">'Content-Disposition'</span> 
],</code></pre><p>API（<code>Laravel</code>）側の実装は以上です。<br><br>ここまでの実装で、直接APIのURLをブラウザのURLに入れてアクセスすればCSVファイルをダウンロードできるはずです。<br>ただしフロント側にレスポンスとして返すだけではフロント側ではファイルダウンロードは行われないので、続けてフロント側も実装していきます。<br></p><h1 id="h5a8452001c">フロント側の実装</h1><p>フロント側の実装方法は2通り紹介させていただきたいと思います。<br></p><h2 id="h16c6498226">実装方法①</h2><p><code>file-saver</code>&nbsp;というライブラリを使ってファイル保存を行います。<br>ライブラリ：<a style="color:#4aac00" href="https://www.npmjs.com/package/file-saver" target="_blank" rel="noopener noreferrer">file-saver</a><br><br>このライブラリの&nbsp;<code>saveAs</code>&nbsp;メソッドに、<br><br>・第1引数：&nbsp;<code>blob</code>&nbsp;オブジェクト<br>・第2引数：ファイル名<br><br>を渡すだけで、指定したファイル名でファイルを保存することができます。<br><br>実装したコードは以下の通りです。</p><pre><code class="hljs">import { saveAs } from 'file-saver'

<span class="hljs-comment">// 中略</span>

axiosApi
  .get('/download/csv', {
    responseType: 'blob',
  })
  .<span class="hljs-keyword">then</span>((res: AxiosResponse) =&gt; {
    const blob = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Blob([<span class="hljs-params">res</span>.<span class="hljs-params">data</span>], { <span class="hljs-params">type</span>: <span class="hljs-params">res</span>.<span class="hljs-params">data</span>.<span class="hljs-params">type</span> })</span>
    const fileName = get<span class="hljs-constructor">FileName(<span class="hljs-params">res</span>.<span class="hljs-params">headers</span>['<span class="hljs-params">content</span>-<span class="hljs-params">disposition</span>'])</span>
    save<span class="hljs-constructor">As(<span class="hljs-params">blob</span>, <span class="hljs-params">fileName</span>)</span>
  })

const getFileName =<span class="hljs-function"> (<span class="hljs-params">contentDisposition</span>: <span class="hljs-params">string</span>) =&gt;</span> {
  return decode<span class="hljs-constructor">URI(<span class="hljs-params">contentDisposition</span>)</span>.substring(
    contentDisposition.index<span class="hljs-constructor">Of(<span class="hljs-string">"''"</span>)</span> + <span class="hljs-number">2</span>,
    contentDisposition.length,
  )
}</code></pre><h3 id="h598587f39e"><br>ポイント</h3><ul><li><strong><code>responseType: 'blob'</code></strong></li></ul><p>この指定をしないと文字化けしてしまいます。<br></p><ul><li><strong>ファイル名の取得</strong></li></ul><p>レスポンスヘッダーの情報は、<code>AxiosResponse</code>&nbsp;の&nbsp;<code>res</code>&nbsp;から、<br></p><pre><code class="hljs">res<span class="hljs-selector-class">.headers</span><span class="hljs-selector-attr">[<span class="hljs-string">'content-disposition'</span>]</span></code></pre><p>のように書くと取り出すことができます。<br><br>レスポンスヘッダーの<code>Content-Disposition</code>をフロント側で受け取り、出力してみると、以下のようにエンコードされた状態です。</p><pre><code class="hljs">axiosApi
  <span class="hljs-selector-class">.get</span>(`/download/csv/${entryType}`, {
    responseType: <span class="hljs-string">'blob'</span>,
  })
  <span class="hljs-selector-class">.then</span>((res: AxiosResponse) =&gt; {
    console<span class="hljs-selector-class">.log</span>(res<span class="hljs-selector-class">.headers</span><span class="hljs-selector-attr">[<span class="hljs-string">'content-disposition'</span>]</span>)    <span class="hljs-comment">// 出力する</span>
    const blob = new <span class="hljs-built_in">Blob</span>(<span class="hljs-selector-attr">[res.data]</span>, { type: res<span class="hljs-selector-class">.data</span><span class="hljs-selector-class">.type</span> })
    const fileName = <span class="hljs-built_in">getFileName</span>(res<span class="hljs-selector-class">.headers</span><span class="hljs-selector-attr">[<span class="hljs-string">'content-disposition'</span>]</span>)
    <span class="hljs-built_in">saveAs</span>(blob, fileName)
  })</code></pre><p>出力結果</p><pre><code class="hljs">attachment; filename=___20220301173602.csv; filename*=utf<span class="hljs-number">-8</span><span class="hljs-string">''</span>%E9%A1%A7%E5%AE%A2%E6%83%85%E5%A0%B1_%E3%82%82%E3%81%AE%E3%81%A5%E3%81%8F%E3%82%8A%E8%A3%.csv</code></pre><p><br>なので上記の状態からデコードを行い、さらに<code>filename*=utf-8''</code>以降のファイル名の部分のみを切り取ります。</p><pre><code class="hljs">const getFileName = <span class="hljs-function">(<span class="hljs-params">contentDisposition: string</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> decodeURI(contentDisposition).substring(
    contentDisposition.<span class="hljs-built_in">indexOf</span>(<span class="hljs-string">"''"</span>) + <span class="hljs-number">2</span>,
    contentDisposition.<span class="hljs-built_in">length</span>,
  )
}</code></pre><h2 id="he028bf746e"><br>実装方法②</h2><p><code>HTML</code>&nbsp;の&nbsp;<code>a</code>&nbsp;タグに<code>download</code>&nbsp;属性を設定すると、&nbsp;<code>a</code>&nbsp;タグをクリックした場合、ブラウザはユーザーをそのURLへ遷移させるのではなくそのコンテンツを保存させます。<br><a style="color:#4aac00" href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/a#:~:text=%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82-,download,HTML5,-%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C" target="_blank" rel="noopener noreferrer">: アンカー要素 - HTML: HyperText Markup Language | MDN</a><br><br>この機能を使ってファイル保存を行います。</p><pre><code class="hljs">axiosApi
  <span class="hljs-selector-class">.get</span>(<span class="hljs-string">'/download/csv'</span>, {
    responseType: <span class="hljs-string">'blob'</span>,
  })
  <span class="hljs-selector-class">.then</span>((res: AxiosResponse) =&gt; {
    <span class="hljs-comment">// Blobを参照するための一時的なURLを生成</span>
    const url = window<span class="hljs-selector-class">.URL</span><span class="hljs-selector-class">.createObjectURL</span>(new <span class="hljs-built_in">Blob</span>(<span class="hljs-selector-attr">[res.data]</span>))
    <span class="hljs-comment">// HTML要素のaタグを生成</span>
    const link = document<span class="hljs-selector-class">.createElement</span>(<span class="hljs-string">'a'</span>)
    link<span class="hljs-selector-class">.href</span> = url
    <span class="hljs-comment">// aタグのdownload属性を設定</span>
    link<span class="hljs-selector-class">.setAttribute</span>(<span class="hljs-string">'download'</span>, `顧客情報_ものづくり補助金_全件_${<span class="hljs-built_in">getTimestamp</span>()}.csv`)
    <span class="hljs-comment">// 生成したaタグを設置し、クリックさせる</span>
    document<span class="hljs-selector-class">.body</span><span class="hljs-selector-class">.appendChild</span>(link)
    link<span class="hljs-selector-class">.click</span>()
    <span class="hljs-comment">// URLを削除</span>
    window<span class="hljs-selector-class">.URL</span><span class="hljs-selector-class">.revokeObjectURL</span>(url)
  }</code></pre><h2 id="h1afe451c43"><br>さいごに</h2><p>自分で実装して検証ツールで確認しながら進めることで、レスポンスヘッダーの働きやレスポンスヘッダーが違えば挙動も変わることを実感できたので良かったと思います。<br><br>またLaravelの&nbsp;<code>steramDownload</code>メソッドがレスポンスヘッダーをよしなに生成してくれていることに気付いたとき、フレームワークってすごい…と感動してしまいました！<br></p><h2 id="he45680f0bc">参考記事</h2><p><br><a href="https://coinbaby8.com/php-csv-export.html" target="_blank" rel="noopener noreferrer">【PHP】【Laravel】CSVエクスポートの方法〜5つのポイント〜</a><br><br><a href="https://www.wakuwakubank.com/posts/799-it-content-type-content-disposition/" target="_blank" rel="noopener noreferrer">Content-Type, Content-Dispositionの役割 - わくわくBank</a><br><br><a href="https://qiita.com/koushisa/items/ac908d81361534264d35" target="_blank" rel="noopener noreferrer">axiosでファイルダウンロード処理を実装(IEにも対応) - Qiita</a><br><br><a href="https://jpdebug.com/p/978039" target="_blank" rel="noopener noreferrer">Springboot+Vue+axios excelのエクスポートダウンロードを実現 - JPDEBUG.COM</a><br><br><a href="https://javascript.keicode.com/newjs/download-files.php#1-1" target="_blank" rel="noopener noreferrer">ファイルをダウンロード保存する方法 - JavaScript 入門</a><br><br><a href="https://tkkm.tokyo/post-177/" target="_blank" rel="noopener noreferrer">【JavaScript】Axiosを使ってCSVをダウンロードしたい | ゆとって生きたい。【JavaScript】Axiosを使ってCSV...</a><br><br><a href="https://helloworld-blog.tech/javascript/axios%E3%81%8B%E3%82%89csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">axiosからCSVファイルをダウンロードさせる方法 | &lt;HelloWorld/&gt;</a><br></p></body></html></div></div></div><style data-emotion="css 2sbw87">.css-2sbw87{background-color:#494949;margin:0 auto;padding-top:30px;padding-bottom:30px;color:#f2f2f2;letter-spacing:0.08rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-around;-ms-flex-pack:space-around;-webkit-justify-content:space-around;justify-content:space-around;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="css-2sbw87"><style data-emotion="css kta5xp">.css-kta5xp{box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}@media (min-width:600px){.css-kta5xp{-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}}@media (min-width:900px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1200px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1536px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}</style><div class="MuiGrid-root MuiGrid-grid-xs-10 MuiGrid-grid-md-8 css-kta5xp"><style data-emotion="css 1lx0lai">.css-1lx0lai{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;text-align:center;}</style><div class="MuiGrid-root MuiGrid-item css-1lx0lai"><a href="https://twitter.com/napi_nami"><style data-emotion="css 1ea777n">.css-1ea777n{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;margin:8px;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TwitterIcon"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a href="https://github.com/hinakonagao"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></div><style data-emotion="css 198jr53">.css-198jr53{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;text-align:center;font-weight:200;}</style><p class="MuiTypography-root MuiTypography-body2 css-198jr53">© 2022 hinako blog</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"id":"csv-laravel-nextjs","createdAt":"2022-03-02T23:59:40.487Z","updatedAt":"2022-03-02T23:59:40.487Z","publishedAt":"2022-03-02T23:59:40.487Z","revisedAt":"2022-03-02T23:59:40.487Z","title":"【Laravel × Next.js】Axiosを使ってCSVファイルをダウンロードする","body":"\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eフロント\u003ccode\u003enext.js\u003c/code\u003e\u0026nbsp;× API\u0026nbsp;\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;の構成で作成しているアプリケーションにおいて、\u003cbr\u003e「フロント側でとあるボタンをクリックしたら、API側で生成した\u003cstrong\u003eCSVファイル\u003c/strong\u003eをダウンロードする」\u003cbr\u003eという機能を業務で実装する機会があったので、実装方法や勉強になったことをまとめておきます。\u003cbr\u003e\u003cbr\u003e全体の流れは以下の通りです。\u003cbr\u003e\u003cbr\u003e1.　フロント側から\u003ccode\u003eAxios\u003c/code\u003eを使ってAPIへリクエストを飛ばす。\u003cbr\u003e2.　API側（\u003ccode\u003eLaravel\u003c/code\u003e）でCSVファイルを生成し、レスポンスとして返す。\u003cbr\u003e3.　フロント側でレスポンスを受け取り、CSVファイルをダウンロードする。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"he52b44f87d\"\u003eAPI側の実装\u003c/h1\u003e\u003cp\u003eAPI側から実装していきます。\u003cbr\u003e※本来はサービスクラスなどへ処理を切り分けるべきではありますが、ここではコントローラーに全ての処理を書くものとします。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf64c7c1253\"\u003eルーティング\u003c/h2\u003e\u003cp\u003eフロント側（\u003ccode\u003eNext.js\u003c/code\u003e）から\u003ccode\u003eAxios\u003c/code\u003eで送られてくるリクエストに対するルーティングを定義します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// routes/api.php\n\nRoute::get('/download/csv', [DownloadCsvController::class, 'downloadCsv']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここで定義した通り、\u003ccode\u003eDownloadCsvController\u003c/code\u003eの\u003ccode\u003edownloadCsv\u003c/code\u003eメソッドにCSVファイルを生成してレスポンスとして返す処理をかいていきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2171e4cd81\"\u003eコントローラー\u003c/h2\u003e\u003ch3 id=\"h50212800e7\"\u003eコードの概要\u003c/h3\u003e\u003cp\u003e先に概要だけざっくり説明すると、以下の通りです。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eLaravelの\u003ccode\u003estreamDownload\u003c/code\u003eメソッドを使って、CSVファイルをレスポンスとして返す。\u003c/li\u003e\u003cli\u003e\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは引数を3つ取るので、各引数を用意する。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e※\u003ccode\u003estreamDownload\u003c/code\u003eメソッドについてはReadoubleの以下の箇所を参照ください。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/responses.html?header=%25E3%2582%25B9%25E3%2583%2588%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25A0%25E3%2583%2580%25E3%2582%25A6%25E3%2583%25B3%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%2589#:~:text=%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89,-%E7%89%B9%E5%AE%9A%E3%81%AE%E6%93%8D%E4%BD%9C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHTTPレスポンス 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2faa5e3f79\"\u003eコードの全文\u003c/h3\u003e\u003cp\u003e詳しい解説は後にして、コードの全文を載せます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// DownloadCsvController.php\n\n/**\n * CSVダウンロード\n * @return StreamedResponse\n */\npublic function downloadCsv(): StreamedResponse\n{\n  // CSVファイル作成コールバック\n  $downloadCsvCallback = function () {\n    // CSVファイル作成\n    $csv = fopen('php://output', 'w');\n\n    // CSVの1行目\n    $colums = [\n      'id' =\u0026gt; 'ユーザーID',\n      'name' =\u0026gt; 'ユーザー名',\n      'email' =\u0026gt; 'メールアドレス'\n    ];\n    // 文字化け対策\n    mb_convert_variables('SJIS-win', 'UTF-8', $colums);\n    // CSVの1行目を記入\n    fputcsv($csv, $colums);\n\n    // CSVの2行目以降\n    $users = User::all();\n    foreach ($users as $user) {\n      $userData = [\n        'id' =\u0026gt; $user-\u0026gt;id,\n        'name' =\u0026gt; $user-\u0026gt;name,\n        'email' =\u0026gt; $user-\u0026gt;email\n      ];\n      // 文字化け対策\n      mb_convert_variables('SJIS-win', 'UTF-8', $userData );\n      // CSVファイルの2行目以降にユーザー情報を記入\n      fputcsv($csv, $userData);\n    }\n\n    // CSVファイルを閉じる\n    fclose($csv);\n  }\n\n  // ファイル名\n  $fileName = 'ユーザー情報.csv';\n\n  // レスポンスヘッダー情報\n  $responseHeader = [\n    'Content-type' =\u0026gt; 'text/csv',\n    'Access-Control-Expose-Headers' =\u0026gt; 'Content-Disposition'\n  ],\n\n  return response()-\u0026gt;streamDownload($downloadCsvCallback, $fileName, $responseHeader);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここから上記のコードのポイントを解説していきます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h3693827ec3\"\u003esteramDownloadメソッド\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e引数と返り値について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e先述の通り、\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドは以下の3つの引数を取り、返り値は\u0026nbsp;\u003ccode\u003eSymfony\\Component\\HttpFoundation\\StreamedResponse\u003c/code\u003eとなります。\u003cbr\u003e　・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e　・第2引数：ファイル名\u003cbr\u003e　・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e今回の構成では、フロント側（\u003ccode\u003eNext.js\u003c/code\u003e）からAPIリクエストを受け取って\u003ccode\u003eStreamedResponse\u003c/code\u003eの形式でレスポンスを返すことになります。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eレスポンスヘッダーについて\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eHTTPレスポンスの際に、ブラウザで表示するのではなくファイルをブラウザでダウンロードさせたい場合は、レスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを持たせる必要があります。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition#:~:text=Content%2DDisposition%3A%20attachment%3B%20filename%3D%22filename.jpg%22\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Disposition - HTTP | MDN\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// レスポンスヘッダーに以下の記述が必要\nContent-Disposition: attachment\n\n// ファイル名を指定する場合\nContent-Disposition: attachment; filename=\"filename.jpg\"\n\n// ファイル名をエンコードする場合\nContent-Disposition: attachment; filename*=UTF-8''URLエンコーディングされたファイル名\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eそこで\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは、この\u003ccode\u003eContent-Disposition\u003c/code\u003eをよしなにレスポンスヘッダーに加えてくれます。\u003cbr\u003e\u003cbr\u003e以下の画像は、第2引数に\u003ccode\u003e'ファイル.csv'\u003c/code\u003eと指定してレスポンスを返した際のレスポンスヘッダーを、検証ツールで確認したものです。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6a50ee5392784850a2205c44dc23d633/%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%83%98%E3%83%83%E3%83%80%E3%83%BC.jpg\" alt=\"\"\u003e\u003cbr\u003eファイル名に日本語を指定すると、URLエンコーディングされた状態でレスポンスヘッダーに付与されています。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"he1a46ab77a\"\u003eCSVファイル作成コールバック\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eCSVファイルの作成\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eコールバック関数内で行う処理の大まかな流れは以下の通りで、\u003cbr\u003e\u003ccode\u003eCSVファイルを作成→中身を書き込む→ファイルを閉じる\u003c/code\u003e\u003cbr\u003eというものです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// ファイルを作成する\nfopen('php://output', 'w');  \n\n// CSVの1行目のカラムを記入する\nfputcsv($csv, $colums);\n\n// CSVの2行目以降に企業情報を記入する\nfputcsv($csv, $userData); \n\n// ファイルを閉じる\nfclose($csv);  \u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e文字化け対策について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eデフォルトの文字コードは、\u003cbr\u003e・Excel：\u003ccode\u003eSJIS\u003c/code\u003e\u003cbr\u003e・PHP：\u003ccode\u003eUTF-8\u003c/code\u003e（\u003ccode\u003ephp.ini\u003c/code\u003eで設定されている）\u003cbr\u003eという違いがあります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// php.ini\ndefault_charset = \"UTF-8\"\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eなのでPHPの文字コードが\u003ccode\u003eUTF-8\u003c/code\u003eのままCSVファイルを生成すると、Excelで開いたときに文字化けしてしまいます。\u003cbr\u003e\u003cbr\u003eこれを防ぐため、PHPの\u003ccode\u003emb_convert_variables\u003c/code\u003e関数を使って文字コードを\u003ccode\u003eUTF-8\u003c/code\u003eから\u003ccode\u003eSJIS-win\u003c/code\u003eに変換します。\u003cbr\u003ePHPドキュメント：\u003ca style=\"color:#4aac00\" href=\"https://www.php.net/manual/ja/function.mb-convert-variables.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emb_convert_variables\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003emb_convert_variables('SJIS-win', 'UTF-8', $colums);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e※\u003ccode\u003eSJIS-win\u003c/code\u003eはWindows向けに使われる\u003ccode\u003eShift-JIS\u003c/code\u003eで、通常の\u003ccode\u003eSJIS\u003c/code\u003eよりも対応している文字が多いようです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h13b0fcb7b2\"\u003eレスポンスヘッダーについて\u003c/h3\u003e\u003cp\u003e先述の通り、\u003ccode\u003estreamDownload\u003c/code\u003eメソッドがレスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを自動で含めてくれます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの要素はフロント側で\u0026nbsp;\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;から受け取ることが出来るので、後ほどフロント側でレスポンスヘッダーからファイル名を取得することになります。\u003cbr\u003e但し今回のような\u0026nbsp;\u003ccode\u003eCORS\u003c/code\u003e\u0026nbsp;の通信の場合、標準的なレスポンスヘッダー以外の場合はAPIから返すレスポンスヘッダーに\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eAccess-Control-Expose-Headers: {レスポンスヘッダ名}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eを追加しておかないと、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;からレスポンス情報を受け取ることが出来ないので、\u003ccode\u003eContent-Disposition\u003c/code\u003eについては上記の記述が必要です。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAccess-Control-Expose-Headers - HTTP | MDN\u003c/a\u003e\u003cbr\u003e参考記事：\u003ca style=\"color:#4aac00\" href=\"https://note.kiriukun.com/entry/20200303-axios-response-header-could-not-get\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAxiosでレスポンスヘッダが取得できなかった (CORSなAPI)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eよって\u003ccode\u003estreamDownload\u003c/code\u003eメソッドの第3引数には、以下のレスポンスヘッダー情報を渡します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// レスポンスヘッダー情報\n$responseHeader = [\n  'Content-type' =\u0026gt; 'text/csv',\n  'Access-Control-Expose-Headers' =\u0026gt; 'Content-Disposition' \n],\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAPI（\u003ccode\u003eLaravel\u003c/code\u003e）側の実装は以上です。\u003cbr\u003e\u003cbr\u003eここまでの実装で、直接APIのURLをブラウザのURLに入れてアクセスすればCSVファイルをダウンロードできるはずです。\u003cbr\u003eただしフロント側にレスポンスとして返すだけではフロント側ではファイルダウンロードは行われないので、続けてフロント側も実装していきます。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h5a8452001c\"\u003eフロント側の実装\u003c/h1\u003e\u003cp\u003eフロント側の実装方法は2通り紹介させていただきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h16c6498226\"\u003e実装方法①\u003c/h2\u003e\u003cp\u003e\u003ccode\u003efile-saver\u003c/code\u003e\u0026nbsp;というライブラリを使ってファイル保存を行います。\u003cbr\u003eライブラリ：\u003ca style=\"color:#4aac00\" href=\"https://www.npmjs.com/package/file-saver\" target=\"_blank\" rel=\"noopener noreferrer\"\u003efile-saver\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこのライブラリの\u0026nbsp;\u003ccode\u003esaveAs\u003c/code\u003e\u0026nbsp;メソッドに、\u003cbr\u003e\u003cbr\u003e・第1引数：\u0026nbsp;\u003ccode\u003eblob\u003c/code\u003e\u0026nbsp;オブジェクト\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e\u003cbr\u003eを渡すだけで、指定したファイル名でファイルを保存することができます。\u003cbr\u003e\u003cbr\u003e実装したコードは以下の通りです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eimport { saveAs } from 'file-saver'\n\n// 中略\n\naxiosApi\n  .get('/download/csv', {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    const blob = new Blob([res.data], { type: res.data.type })\n    const fileName = getFileName(res.headers['content-disposition'])\n    saveAs(blob, fileName)\n  })\n\nconst getFileName = (contentDisposition: string) =\u0026gt; {\n  return decodeURI(contentDisposition).substring(\n    contentDisposition.indexOf(\"''\") + 2,\n    contentDisposition.length,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h598587f39e\"\u003e\u003cbr\u003eポイント\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eresponseType: 'blob'\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eこの指定をしないと文字化けしてしまいます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eファイル名の取得\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレスポンスヘッダーの情報は、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003eres\u003c/code\u003e\u0026nbsp;から、\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eres.headers['content-disposition']\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eのように書くと取り出すことができます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの\u003ccode\u003eContent-Disposition\u003c/code\u003eをフロント側で受け取り、出力してみると、以下のようにエンコードされた状態です。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eaxiosApi\n  .get(`/download/csv/${entryType}`, {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    console.log(res.headers['content-disposition'])    // 出力する\n    const blob = new Blob([res.data], { type: res.data.type })\n    const fileName = getFileName(res.headers['content-disposition'])\n    saveAs(blob, fileName)\n  })\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e出力結果\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eattachment; filename=___20220301173602.csv; filename*=utf-8''%E9%A1%A7%E5%AE%A2%E6%83%85%E5%A0%B1_%E3%82%82%E3%81%AE%E3%81%A5%E3%81%8F%E3%82%8A%E8%A3%.csv\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eなので上記の状態からデコードを行い、さらに\u003ccode\u003efilename*=utf-8''\u003c/code\u003e以降のファイル名の部分のみを切り取ります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst getFileName = (contentDisposition: string) =\u0026gt; {\n  return decodeURI(contentDisposition).substring(\n    contentDisposition.indexOf(\"''\") + 2,\n    contentDisposition.length,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"he028bf746e\"\u003e\u003cbr\u003e実装方法②\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eHTML\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグに\u003ccode\u003edownload\u003c/code\u003e\u0026nbsp;属性を設定すると、\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグをクリックした場合、ブラウザはユーザーをそのURLへ遷移させるのではなくそのコンテンツを保存させます。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTML/Element/a#:~:text=%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82-,download,HTML5,-%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e: アンカー要素 - HTML: HyperText Markup Language | MDN\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこの機能を使ってファイル保存を行います。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eaxiosApi\n  .get('/download/csv', {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    // Blobを参照するための一時的なURLを生成\n    const url = window.URL.createObjectURL(new Blob([res.data]))\n    // HTML要素のaタグを生成\n    const link = document.createElement('a')\n    link.href = url\n    // aタグのdownload属性を設定\n    link.setAttribute('download', `顧客情報_ものづくり補助金_全件_${getTimestamp()}.csv`)\n    // 生成したaタグを設置し、クリックさせる\n    document.body.appendChild(link)\n    link.click()\n    // URLを削除\n    window.URL.revokeObjectURL(url)\n  }\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h1afe451c43\"\u003e\u003cbr\u003eさいごに\u003c/h2\u003e\u003cp\u003e自分で実装して検証ツールで確認しながら進めることで、レスポンスヘッダーの働きやレスポンスヘッダーが違えば挙動も変わることを実感できたので良かったと思います。\u003cbr\u003e\u003cbr\u003eまたLaravelの\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドがレスポンスヘッダーをよしなに生成してくれていることに気付いたとき、フレームワークってすごい…と感動してしまいました！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://coinbaby8.com/php-csv-export.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【PHP】【Laravel】CSVエクスポートの方法〜5つのポイント〜\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://www.wakuwakubank.com/posts/799-it-content-type-content-disposition/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Type, Content-Dispositionの役割 - わくわくBank\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/koushisa/items/ac908d81361534264d35\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosでファイルダウンロード処理を実装(IEにも対応) - Qiita\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://jpdebug.com/p/978039\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eSpringboot+Vue+axios excelのエクスポートダウンロードを実現 - JPDEBUG.COM\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://javascript.keicode.com/newjs/download-files.php#1-1\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eファイルをダウンロード保存する方法 - JavaScript 入門\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://tkkm.tokyo/post-177/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【JavaScript】Axiosを使ってCSVをダウンロードしたい | ゆとって生きたい。【JavaScript】Axiosを使ってCSV...\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://helloworld-blog.tech/javascript/axios%E3%81%8B%E3%82%89csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosからCSVファイルをダウンロードさせる方法 | \u0026lt;HelloWorld/\u0026gt;\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"},{"id":"php","createdAt":"2022-01-07T13:16:36.618Z","updatedAt":"2022-02-12T02:31:46.498Z","publishedAt":"2022-01-07T13:16:36.618Z","revisedAt":"2022-01-07T13:16:36.618Z","tag":"PHP"},{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"},{"id":"javascript","createdAt":"2022-01-07T13:18:33.680Z","updatedAt":"2022-01-07T13:18:33.680Z","publishedAt":"2022-01-07T13:18:33.680Z","revisedAt":"2022-01-07T13:18:33.680Z","tag":"JavaScript"}],"image":"laravel"},"highlightedBody":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eフロント\u003ccode\u003enext.js\u003c/code\u003e\u0026nbsp;× API\u0026nbsp;\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;の構成で作成しているアプリケーションにおいて、\u003cbr\u003e「フロント側でとあるボタンをクリックしたら、API側で生成した\u003cstrong\u003eCSVファイル\u003c/strong\u003eをダウンロードする」\u003cbr\u003eという機能を業務で実装する機会があったので、実装方法や勉強になったことをまとめておきます。\u003cbr\u003e\u003cbr\u003e全体の流れは以下の通りです。\u003cbr\u003e\u003cbr\u003e1.　フロント側から\u003ccode\u003eAxios\u003c/code\u003eを使ってAPIへリクエストを飛ばす。\u003cbr\u003e2.　API側（\u003ccode\u003eLaravel\u003c/code\u003e）でCSVファイルを生成し、レスポンスとして返す。\u003cbr\u003e3.　フロント側でレスポンスを受け取り、CSVファイルをダウンロードする。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"he52b44f87d\"\u003eAPI側の実装\u003c/h1\u003e\u003cp\u003eAPI側から実装していきます。\u003cbr\u003e※本来はサービスクラスなどへ処理を切り分けるべきではありますが、ここではコントローラーに全ての処理を書くものとします。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf64c7c1253\"\u003eルーティング\u003c/h2\u003e\u003cp\u003eフロント側（\u003ccode\u003eNext.js\u003c/code\u003e）から\u003ccode\u003eAxios\u003c/code\u003eで送られてくるリクエストに対するルーティングを定義します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-comment\"\u003e// routes/api.php\u003c/span\u003e\n\nRoute::\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'/download/csv'\u003c/span\u003e, [DownloadCsvController::\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'downloadCsv'\u003c/span\u003e]);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここで定義した通り、\u003ccode\u003eDownloadCsvController\u003c/code\u003eの\u003ccode\u003edownloadCsv\u003c/code\u003eメソッドにCSVファイルを生成してレスポンスとして返す処理をかいていきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2171e4cd81\"\u003eコントローラー\u003c/h2\u003e\u003ch3 id=\"h50212800e7\"\u003eコードの概要\u003c/h3\u003e\u003cp\u003e先に概要だけざっくり説明すると、以下の通りです。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eLaravelの\u003ccode\u003estreamDownload\u003c/code\u003eメソッドを使って、CSVファイルをレスポンスとして返す。\u003c/li\u003e\u003cli\u003e\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは引数を3つ取るので、各引数を用意する。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e※\u003ccode\u003estreamDownload\u003c/code\u003eメソッドについてはReadoubleの以下の箇所を参照ください。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/responses.html?header=%25E3%2582%25B9%25E3%2583%2588%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25A0%25E3%2583%2580%25E3%2582%25A6%25E3%2583%25B3%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%2589#:~:text=%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89,-%E7%89%B9%E5%AE%9A%E3%81%AE%E6%93%8D%E4%BD%9C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHTTPレスポンス 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2faa5e3f79\"\u003eコードの全文\u003c/h3\u003e\u003cp\u003e詳しい解説は後にして、コードの全文を載せます。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e DownloadCsvController.php\n\n/**\n * CSVダウンロード\n * @return StreamedResponse\n */\npublic \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e downloadCsv(): StreamedResponse\n{\n  \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVファイル作成コールバック\n  \u003cspan class=\"hljs-variable\"\u003e$downloadCsvCallback\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e () {\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVファイル作成\n    \u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e = fopen(\u003cspan class=\"hljs-string\"\u003e'php://output'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'w'\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVの\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e行目\n    \u003cspan class=\"hljs-variable\"\u003e$colums\u003c/span\u003e = [\n      \u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'ユーザーID'\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'ユーザー名'\u003c/span\u003e,\n      \u003cspan class=\"hljs-string\"\u003e'email'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'メールアドレス'\u003c/span\u003e\n    ];\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e 文字化け対策\n    mb_convert_variables(\u003cspan class=\"hljs-string\"\u003e'SJIS-win'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'UTF-8'\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$colums\u003c/span\u003e);\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVの\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e行目を記入\n    fputcsv(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$colums\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVの\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e行目以降\n    \u003cspan class=\"hljs-variable\"\u003e$users\u003c/span\u003e = User::all();\n    foreach (\u003cspan class=\"hljs-variable\"\u003e$users\u003c/span\u003e as \u003cspan class=\"hljs-variable\"\u003e$user\u003c/span\u003e) {\n      \u003cspan class=\"hljs-variable\"\u003e$userData\u003c/span\u003e = [\n        \u003cspan class=\"hljs-string\"\u003e'id'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$user\u003c/span\u003e-\u0026gt;id,\n        \u003cspan class=\"hljs-string\"\u003e'name'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$user\u003c/span\u003e-\u0026gt;name,\n        \u003cspan class=\"hljs-string\"\u003e'email'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-variable\"\u003e$user\u003c/span\u003e-\u0026gt;email\n      ];\n      \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e 文字化け対策\n      mb_convert_variables(\u003cspan class=\"hljs-string\"\u003e'SJIS-win'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'UTF-8'\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$userData\u003c/span\u003e );\n      \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVファイルの\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e行目以降にユーザー情報を記入\n      fputcsv(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$userData\u003c/span\u003e);\n    }\n\n    \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVファイルを閉じる\n    fclose(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e);\n  }\n\n  \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e ファイル名\n  \u003cspan class=\"hljs-variable\"\u003e$fileName\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'ユーザー情報.csv'\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e レスポンスヘッダー情報\n  \u003cspan class=\"hljs-variable\"\u003e$responseHeader\u003c/span\u003e = [\n    \u003cspan class=\"hljs-string\"\u003e'Content-type'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'text/csv'\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e'Access-Control-Expose-Headers'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'Content-Disposition'\u003c/span\u003e\n  ],\n\n  return response()-\u0026gt;streamDownload(\u003cspan class=\"hljs-variable\"\u003e$downloadCsvCallback\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$fileName\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$responseHeader\u003c/span\u003e);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここから上記のコードのポイントを解説していきます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h3693827ec3\"\u003esteramDownloadメソッド\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e引数と返り値について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e先述の通り、\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドは以下の3つの引数を取り、返り値は\u0026nbsp;\u003ccode\u003eSymfony\\Component\\HttpFoundation\\StreamedResponse\u003c/code\u003eとなります。\u003cbr\u003e　・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e　・第2引数：ファイル名\u003cbr\u003e　・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e今回の構成では、フロント側（\u003ccode\u003eNext.js\u003c/code\u003e）からAPIリクエストを受け取って\u003ccode\u003eStreamedResponse\u003c/code\u003eの形式でレスポンスを返すことになります。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eレスポンスヘッダーについて\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eHTTPレスポンスの際に、ブラウザで表示するのではなくファイルをブラウザでダウンロードさせたい場合は、レスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを持たせる必要があります。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition#:~:text=Content%2DDisposition%3A%20attachment%3B%20filename%3D%22filename.jpg%22\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Disposition - HTTP | MDN\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e レスポンスヘッダーに以下の記述が必要\nContent-Disposition: attachment\n\n\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e ファイル名を指定する場合\nContent-Disposition: attachment; filename=\u003cspan class=\"hljs-string\"\u003e\"filename.jpg\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e ファイル名をエンコードする場合\nContent-Disposition: attachment; filename*=UTF-\u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003eURLエンコーディングされたファイル名\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eそこで\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは、この\u003ccode\u003eContent-Disposition\u003c/code\u003eをよしなにレスポンスヘッダーに加えてくれます。\u003cbr\u003e\u003cbr\u003e以下の画像は、第2引数に\u003ccode\u003e'ファイル.csv'\u003c/code\u003eと指定してレスポンスを返した際のレスポンスヘッダーを、検証ツールで確認したものです。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6a50ee5392784850a2205c44dc23d633/%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%83%98%E3%83%83%E3%83%80%E3%83%BC.jpg\" alt=\"\"\u003e\u003cbr\u003eファイル名に日本語を指定すると、URLエンコーディングされた状態でレスポンスヘッダーに付与されています。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"he1a46ab77a\"\u003eCSVファイル作成コールバック\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eCSVファイルの作成\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eコールバック関数内で行う処理の大まかな流れは以下の通りで、\u003cbr\u003e\u003ccode\u003eCSVファイルを作成→中身を書き込む→ファイルを閉じる\u003c/code\u003e\u003cbr\u003eというものです。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e ファイルを作成する\nfopen(\u003cspan class=\"hljs-string\"\u003e'php://output'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'w'\u003c/span\u003e);  \n\n\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVの\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e行目のカラムを記入する\nfputcsv(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$colums\u003c/span\u003e);\n\n\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e CSVの\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e行目以降に企業情報を記入する\nfputcsv(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$userData\u003c/span\u003e); \n\n\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e ファイルを閉じる\nfclose(\u003cspan class=\"hljs-variable\"\u003e$csv\u003c/span\u003e);  \u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e文字化け対策について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eデフォルトの文字コードは、\u003cbr\u003e・Excel：\u003ccode\u003eSJIS\u003c/code\u003e\u003cbr\u003e・PHP：\u003ccode\u003eUTF-8\u003c/code\u003e（\u003ccode\u003ephp.ini\u003c/code\u003eで設定されている）\u003cbr\u003eという違いがあります。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e php.ini\ndefault_charset = \u003cspan class=\"hljs-string\"\u003e\"UTF-8\"\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eなのでPHPの文字コードが\u003ccode\u003eUTF-8\u003c/code\u003eのままCSVファイルを生成すると、Excelで開いたときに文字化けしてしまいます。\u003cbr\u003e\u003cbr\u003eこれを防ぐため、PHPの\u003ccode\u003emb_convert_variables\u003c/code\u003e関数を使って文字コードを\u003ccode\u003eUTF-8\u003c/code\u003eから\u003ccode\u003eSJIS-win\u003c/code\u003eに変換します。\u003cbr\u003ePHPドキュメント：\u003ca style=\"color:#4aac00\" href=\"https://www.php.net/manual/ja/function.mb-convert-variables.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emb_convert_variables\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003emb_convert_variables(\u003cspan class=\"hljs-string\"\u003e'SJIS-win'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'UTF-8'\u003c/span\u003e, \u003cspan class=\"hljs-symbol\"\u003e$colums\u003c/span\u003e);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e※\u003ccode\u003eSJIS-win\u003c/code\u003eはWindows向けに使われる\u003ccode\u003eShift-JIS\u003c/code\u003eで、通常の\u003ccode\u003eSJIS\u003c/code\u003eよりも対応している文字が多いようです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h13b0fcb7b2\"\u003eレスポンスヘッダーについて\u003c/h3\u003e\u003cp\u003e先述の通り、\u003ccode\u003estreamDownload\u003c/code\u003eメソッドがレスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを自動で含めてくれます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの要素はフロント側で\u0026nbsp;\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;から受け取ることが出来るので、後ほどフロント側でレスポンスヘッダーからファイル名を取得することになります。\u003cbr\u003e但し今回のような\u0026nbsp;\u003ccode\u003eCORS\u003c/code\u003e\u0026nbsp;の通信の場合、標準的なレスポンスヘッダー以外の場合はAPIから返すレスポンスヘッダーに\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-keyword\"\u003eAccess\u003c/span\u003e-Control-Expose-Headers: {レスポンスヘッダ名}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eを追加しておかないと、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;からレスポンス情報を受け取ることが出来ないので、\u003ccode\u003eContent-Disposition\u003c/code\u003eについては上記の記述が必要です。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAccess-Control-Expose-Headers - HTTP | MDN\u003c/a\u003e\u003cbr\u003e参考記事：\u003ca style=\"color:#4aac00\" href=\"https://note.kiriukun.com/entry/20200303-axios-response-header-could-not-get\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAxiosでレスポンスヘッダが取得できなかった (CORSなAPI)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eよって\u003ccode\u003estreamDownload\u003c/code\u003eメソッドの第3引数には、以下のレスポンスヘッダー情報を渡します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-regexp\"\u003e//\u003c/span\u003e レスポンスヘッダー情報\n\u003cspan class=\"hljs-variable\"\u003e$responseHeader\u003c/span\u003e = [\n  \u003cspan class=\"hljs-string\"\u003e'Content-type'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'text/csv'\u003c/span\u003e,\n  \u003cspan class=\"hljs-string\"\u003e'Access-Control-Expose-Headers'\u003c/span\u003e =\u0026gt; \u003cspan class=\"hljs-string\"\u003e'Content-Disposition'\u003c/span\u003e \n],\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAPI（\u003ccode\u003eLaravel\u003c/code\u003e）側の実装は以上です。\u003cbr\u003e\u003cbr\u003eここまでの実装で、直接APIのURLをブラウザのURLに入れてアクセスすればCSVファイルをダウンロードできるはずです。\u003cbr\u003eただしフロント側にレスポンスとして返すだけではフロント側ではファイルダウンロードは行われないので、続けてフロント側も実装していきます。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h5a8452001c\"\u003eフロント側の実装\u003c/h1\u003e\u003cp\u003eフロント側の実装方法は2通り紹介させていただきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h16c6498226\"\u003e実装方法①\u003c/h2\u003e\u003cp\u003e\u003ccode\u003efile-saver\u003c/code\u003e\u0026nbsp;というライブラリを使ってファイル保存を行います。\u003cbr\u003eライブラリ：\u003ca style=\"color:#4aac00\" href=\"https://www.npmjs.com/package/file-saver\" target=\"_blank\" rel=\"noopener noreferrer\"\u003efile-saver\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこのライブラリの\u0026nbsp;\u003ccode\u003esaveAs\u003c/code\u003e\u0026nbsp;メソッドに、\u003cbr\u003e\u003cbr\u003e・第1引数：\u0026nbsp;\u003ccode\u003eblob\u003c/code\u003e\u0026nbsp;オブジェクト\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e\u003cbr\u003eを渡すだけで、指定したファイル名でファイルを保存することができます。\u003cbr\u003e\u003cbr\u003e実装したコードは以下の通りです。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eimport { saveAs } from 'file-saver'\n\n\u003cspan class=\"hljs-comment\"\u003e// 中略\u003c/span\u003e\n\naxiosApi\n  .get('/download/csv', {\n    responseType: 'blob',\n  })\n  .\u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e((res: AxiosResponse) =\u0026gt; {\n    const blob = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-constructor\"\u003eBlob([\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e.\u003cspan class=\"hljs-params\"\u003edata\u003c/span\u003e], { \u003cspan class=\"hljs-params\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e.\u003cspan class=\"hljs-params\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-params\"\u003etype\u003c/span\u003e })\u003c/span\u003e\n    const fileName = get\u003cspan class=\"hljs-constructor\"\u003eFileName(\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e.\u003cspan class=\"hljs-params\"\u003eheaders\u003c/span\u003e['\u003cspan class=\"hljs-params\"\u003econtent\u003c/span\u003e-\u003cspan class=\"hljs-params\"\u003edisposition\u003c/span\u003e'])\u003c/span\u003e\n    save\u003cspan class=\"hljs-constructor\"\u003eAs(\u003cspan class=\"hljs-params\"\u003eblob\u003c/span\u003e, \u003cspan class=\"hljs-params\"\u003efileName\u003c/span\u003e)\u003c/span\u003e\n  })\n\nconst getFileName =\u003cspan class=\"hljs-function\"\u003e (\u003cspan class=\"hljs-params\"\u003econtentDisposition\u003c/span\u003e: \u003cspan class=\"hljs-params\"\u003estring\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  return decode\u003cspan class=\"hljs-constructor\"\u003eURI(\u003cspan class=\"hljs-params\"\u003econtentDisposition\u003c/span\u003e)\u003c/span\u003e.substring(\n    contentDisposition.index\u003cspan class=\"hljs-constructor\"\u003eOf(\u003cspan class=\"hljs-string\"\u003e\"''\"\u003c/span\u003e)\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\n    contentDisposition.length,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h598587f39e\"\u003e\u003cbr\u003eポイント\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eresponseType: 'blob'\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eこの指定をしないと文字化けしてしまいます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eファイル名の取得\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレスポンスヘッダーの情報は、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003eres\u003c/code\u003e\u0026nbsp;から、\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eres\u003cspan class=\"hljs-selector-class\"\u003e.headers\u003c/span\u003e\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'content-disposition'\u003c/span\u003e]\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eのように書くと取り出すことができます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの\u003ccode\u003eContent-Disposition\u003c/code\u003eをフロント側で受け取り、出力してみると、以下のようにエンコードされた状態です。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eaxiosApi\n  \u003cspan class=\"hljs-selector-class\"\u003e.get\u003c/span\u003e(`/download/csv/${entryType}`, {\n    responseType: \u003cspan class=\"hljs-string\"\u003e'blob'\u003c/span\u003e,\n  })\n  \u003cspan class=\"hljs-selector-class\"\u003e.then\u003c/span\u003e((res: AxiosResponse) =\u0026gt; {\n    console\u003cspan class=\"hljs-selector-class\"\u003e.log\u003c/span\u003e(res\u003cspan class=\"hljs-selector-class\"\u003e.headers\u003c/span\u003e\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'content-disposition'\u003c/span\u003e]\u003c/span\u003e)    \u003cspan class=\"hljs-comment\"\u003e// 出力する\u003c/span\u003e\n    const blob = new \u003cspan class=\"hljs-built_in\"\u003eBlob\u003c/span\u003e(\u003cspan class=\"hljs-selector-attr\"\u003e[res.data]\u003c/span\u003e, { type: res\u003cspan class=\"hljs-selector-class\"\u003e.data\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.type\u003c/span\u003e })\n    const fileName = \u003cspan class=\"hljs-built_in\"\u003egetFileName\u003c/span\u003e(res\u003cspan class=\"hljs-selector-class\"\u003e.headers\u003c/span\u003e\u003cspan class=\"hljs-selector-attr\"\u003e[\u003cspan class=\"hljs-string\"\u003e'content-disposition'\u003c/span\u003e]\u003c/span\u003e)\n    \u003cspan class=\"hljs-built_in\"\u003esaveAs\u003c/span\u003e(blob, fileName)\n  })\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e出力結果\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eattachment; filename=___20220301173602.csv; filename*=utf\u003cspan class=\"hljs-number\"\u003e-8\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e%E9%A1%A7%E5%AE%A2%E6%83%85%E5%A0%B1_%E3%82%82%E3%81%AE%E3%81%A5%E3%81%8F%E3%82%8A%E8%A3%.csv\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eなので上記の状態からデコードを行い、さらに\u003ccode\u003efilename*=utf-8''\u003c/code\u003e以降のファイル名の部分のみを切り取ります。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003econst getFileName = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003econtentDisposition: string\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e decodeURI(contentDisposition).substring(\n    contentDisposition.\u003cspan class=\"hljs-built_in\"\u003eindexOf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"''\"\u003c/span\u003e) + \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\n    contentDisposition.\u003cspan class=\"hljs-built_in\"\u003elength\u003c/span\u003e,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"he028bf746e\"\u003e\u003cbr\u003e実装方法②\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eHTML\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグに\u003ccode\u003edownload\u003c/code\u003e\u0026nbsp;属性を設定すると、\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグをクリックした場合、ブラウザはユーザーをそのURLへ遷移させるのではなくそのコンテンツを保存させます。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTML/Element/a#:~:text=%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82-,download,HTML5,-%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e: アンカー要素 - HTML: HyperText Markup Language | MDN\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこの機能を使ってファイル保存を行います。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003eaxiosApi\n  \u003cspan class=\"hljs-selector-class\"\u003e.get\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'/download/csv'\u003c/span\u003e, {\n    responseType: \u003cspan class=\"hljs-string\"\u003e'blob'\u003c/span\u003e,\n  })\n  \u003cspan class=\"hljs-selector-class\"\u003e.then\u003c/span\u003e((res: AxiosResponse) =\u0026gt; {\n    \u003cspan class=\"hljs-comment\"\u003e// Blobを参照するための一時的なURLを生成\u003c/span\u003e\n    const url = window\u003cspan class=\"hljs-selector-class\"\u003e.URL\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.createObjectURL\u003c/span\u003e(new \u003cspan class=\"hljs-built_in\"\u003eBlob\u003c/span\u003e(\u003cspan class=\"hljs-selector-attr\"\u003e[res.data]\u003c/span\u003e))\n    \u003cspan class=\"hljs-comment\"\u003e// HTML要素のaタグを生成\u003c/span\u003e\n    const link = document\u003cspan class=\"hljs-selector-class\"\u003e.createElement\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'a'\u003c/span\u003e)\n    link\u003cspan class=\"hljs-selector-class\"\u003e.href\u003c/span\u003e = url\n    \u003cspan class=\"hljs-comment\"\u003e// aタグのdownload属性を設定\u003c/span\u003e\n    link\u003cspan class=\"hljs-selector-class\"\u003e.setAttribute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'download'\u003c/span\u003e, `顧客情報_ものづくり補助金_全件_${\u003cspan class=\"hljs-built_in\"\u003egetTimestamp\u003c/span\u003e()}.csv`)\n    \u003cspan class=\"hljs-comment\"\u003e// 生成したaタグを設置し、クリックさせる\u003c/span\u003e\n    document\u003cspan class=\"hljs-selector-class\"\u003e.body\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.appendChild\u003c/span\u003e(link)\n    link\u003cspan class=\"hljs-selector-class\"\u003e.click\u003c/span\u003e()\n    \u003cspan class=\"hljs-comment\"\u003e// URLを削除\u003c/span\u003e\n    window\u003cspan class=\"hljs-selector-class\"\u003e.URL\u003c/span\u003e\u003cspan class=\"hljs-selector-class\"\u003e.revokeObjectURL\u003c/span\u003e(url)\n  }\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h1afe451c43\"\u003e\u003cbr\u003eさいごに\u003c/h2\u003e\u003cp\u003e自分で実装して検証ツールで確認しながら進めることで、レスポンスヘッダーの働きやレスポンスヘッダーが違えば挙動も変わることを実感できたので良かったと思います。\u003cbr\u003e\u003cbr\u003eまたLaravelの\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドがレスポンスヘッダーをよしなに生成してくれていることに気付いたとき、フレームワークってすごい…と感動してしまいました！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://coinbaby8.com/php-csv-export.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【PHP】【Laravel】CSVエクスポートの方法〜5つのポイント〜\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://www.wakuwakubank.com/posts/799-it-content-type-content-disposition/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Type, Content-Dispositionの役割 - わくわくBank\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/koushisa/items/ac908d81361534264d35\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosでファイルダウンロード処理を実装(IEにも対応) - Qiita\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://jpdebug.com/p/978039\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eSpringboot+Vue+axios excelのエクスポートダウンロードを実現 - JPDEBUG.COM\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://javascript.keicode.com/newjs/download-files.php#1-1\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eファイルをダウンロード保存する方法 - JavaScript 入門\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://tkkm.tokyo/post-177/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【JavaScript】Axiosを使ってCSVをダウンロードしたい | ゆとって生きたい。【JavaScript】Axiosを使ってCSV...\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://helloworld-blog.tech/javascript/axios%E3%81%8B%E3%82%89csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosからCSVファイルをダウンロードさせる方法 | \u0026lt;HelloWorld/\u0026gt;\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003c/body\u003e\u003c/html\u003e"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"csv-laravel-nextjs"},"buildId":"EwuWiZmkeG3lYlO_XC9fM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>