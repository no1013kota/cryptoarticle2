<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4bc12c1be68739c7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4bc12c1be68739c7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/8d58b9228ffac9a6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8d58b9228ffac9a6.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a602b05d6a5b45c.js" defer=""></script><script src="/_next/static/chunks/451-8446afed8f2a81ca.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-7b5e07e6b1c54b77.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_buildManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_ssgManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style data-emotion="css a6by8m">.css-a6by8m{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;margin:auto;}</style><div class="MuiGrid-root MuiGrid-container css-a6by8m"><style data-emotion="css d0aeej">.css-d0aeej{background-color:#FFF;color:#222;margin:30px auto;padding:36px;}.css-d0aeej h1,.css-d0aeej h2,.css-d0aeej h3{font-weight:550;}</style><style data-emotion="css vx8k43">.css-vx8k43{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;background-color:#FFF;color:#222;margin:30px auto;padding:36px;}@media (min-width:600px){.css-vx8k43{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:900px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1200px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1536px){.css-vx8k43{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}.css-vx8k43 h1,.css-vx8k43 h2,.css-vx8k43 h3{font-weight:550;}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-11 MuiGrid-grid-md-9 css-vx8k43"><style data-emotion="css tph460">.css-tph460{padding:15px 0px;border-bottom:1px solid #4682B4;}</style><div class="css-tph460"><style data-emotion="css 1x4m838">.css-1x4m838{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:26px;font-weight:540;padding-bottom:16px;}</style><p class="MuiTypography-root MuiTypography-body1 css-1x4m838">【Laravel】論理削除（softDelete）するときにリレーション先のデータも削除する方法</p><style data-emotion="css q5vujz">.css-q5vujz{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:32px;}</style><p class="MuiTypography-root MuiTypography-body2 css-q5vujz"><style data-emotion="css 1eipbkb">.css-1eipbkb{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;font-size:15px;margin-right:4px;vertical-align:middle;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="AccessTimeIcon"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path><path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"></path></svg>投稿日 <!-- -->2022/2/24</p><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1eipbkb" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LocalOfferIcon"><path d="m21.41 11.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"></path></svg><style data-emotion="css 1lc4u9f">.css-1lc4u9f{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;display:inline-block;padding-right:8px;}</style><p class="MuiTypography-root MuiTypography-body2 css-1lc4u9f">#<!-- -->Laravel</p></div><style data-emotion="css il3arz">.css-il3arz{margin-top:40px;}.css-il3arz a{color:#639bb7;}.css-il3arz a:hover{color:#0b7eb8;-webkit-text-decoration:underline;text-decoration:underline;}</style><div class="css-il3arz"><html><head></head><body><h2 id="h9707d3a59a">概要</h2><p>Laravelでは、マイグレーションファイルに外部キー制約の設定を記述しておくと、親テーブルのデータを削除したときに子テーブルのデータも同時に削除することができます。<br><br>但しこれは、DBから実際にデータを削除する「<strong>物理削除</strong>」の場合の話です。<br>DBからレコードを削除するわけではなく削除フラグを立てて削除したとみなす「<strong>論理削除</strong>」の場合は、マイグレーションファイルへの記述だけではリレーション先のデータを一緒に削除してくれません。<br>このような場合に、&nbsp;<strong>モデルの&nbsp;</strong><strong><code>boot</code></strong><strong>&nbsp;メソッド（もしくは&nbsp;</strong><strong><code>booted</code></strong><strong>&nbsp;メソッド）を使って初期設定を行えば</strong>、あるテーブルのデータを論理削除したときにリレーション先のテーブルのデータも削除することができます。<br>業務でこの方法を使う機会があったので、 モデル&nbsp;<code>boot</code>&nbsp;メソッドについて勉強したこととあわせて、備忘録を書いておきたいと思います。<br></p><h2 id="hafc8e872cc">論理削除（softDelete）の設定方法</h2><p>まず事前準備としてソフトデリートの設定をします。<br><br>ソフトデリート機能を組み込む手順は以下の2つです。<br><br>1.　マイグレーションファイルにソフトデリートの設定を記述する<br>2.　EloquentモデルにSoftDeletesトレイトを組み込む<br><br>例として&nbsp;<code>users</code>&nbsp;テーブルにソフトデリート機能を設定してみます。<br></p><h3 id="hb5391332f6">1. マイグレーションファイルにソフトデリートの設定を記述する</h3><p>Laravelの論理削除ではテーブルの&nbsp;<code>deleted_at</code>カラムに値が入っている場合はデータは削除されたとみなすので、&nbsp;<code>deleted_at</code>カラムを追加する必要があります。<br><br><code>deleted_at</code>カラムを追加するため、マイグレーションファイルに以下の1行を追記します。</p><pre><code class="hljs">publicfunction <span class="hljs-built_in">up</span>()
{
    Schema::table(<span class="hljs-string">'user'</span>,function (Blueprint <span class="hljs-variable">$table</span>) {
        <span class="hljs-variable">$table</span>-&gt;<span class="hljs-built_in">softDeletes</span>();    <span class="hljs-comment">// 追記</span>
    });
}</code></pre><p>これでマイグレーションを実行すると、DBのテーブルに&nbsp;<code>deleted_at</code>カラムが作成されていることが確認できます。<br></p><h3 id="h4383fed8c3">2. EloquentモデルにSoftDeletesトレイトを組み込む</h3><p><code>User</code>&nbsp;モデルファイルに以下のように追記します。</p><pre><code class="hljs">use <span class="hljs-type">Illuminate</span>\<span class="hljs-type">Database</span>\<span class="hljs-type">Eloquent</span>\<span class="hljs-type">SoftDeletes</span>;    <span class="hljs-comment">// 追記</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span>
{
    use <span class="hljs-type">SoftDeletes</span>;    <span class="hljs-comment">// 追記</span>
}</code></pre><p>この記述により、deleteメソッドでモデルを削除した際はソフトデリートが実行されるようになります。<br><br>Laravelでソフトデリートを行うための設定は以上です。<br></p><h2 id="h10178e1c1c">モデルのbootedメソッドとは</h2><p>本題の「ソフトデリートするときにリレーション先のデータも削除する」ための実装にあたり、先に今回使用する&nbsp;<code>boooted</code>&nbsp;メソッドについて少し勉強しておきます。<br><br><code>Laravel</code>&nbsp;のモデルでは、初期起動時に&nbsp;<code>boot</code>&nbsp;メソッドを走らせて初期設定をしています。<br><code>booted</code>&nbsp;メソッドはモデルの初期起動後に実行されるメソッドで、モデルに対して行いたい初期設定は&nbsp;<code>booted</code>&nbsp;メソッドに書くよう&nbsp;<code>readouble</code>&nbsp;にも説明があります。</p><h3 id="he23cb179bf">【補足】bootedメソッドとbootメソッドについて</h3><p>今回実装方法をググっていると<code>boot</code>メソッドを使っている記事が見つかり、自分としても初期起動時のメソッドといえば<code>boot</code>メソッドのイメージがあったので、<code>booted</code>メソッドと<code>boot</code>メソッドについて少し調べてみました。<br><br><code>readouble</code>&nbsp;の説明では、モデルの初期設定を行う方法としてLaravel6までは&nbsp;<code>boot</code>&nbsp;メソッドが使われていますが、Laravel7以降では&nbsp;<code>booted</code>&nbsp;メソッドが使われていました。<br>・Laravel8の該当箇所<br><a href="https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%97%E3%81%AA%E3%81%84%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82-,%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E4%BD%BF%E7%94%A8,-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%AF%E3%83%A9%E3%82%B9" target="_blank" rel="noopener noreferrer">Eloquentの準備 8.x Laravel</a><br>・Laravel6の該当箇所<br><a href="https://readouble.com/laravel/6.x/ja/eloquent.html#:~:text=%E9%98%B2%E3%81%92%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AE%E9%81%A9%E7%94%A8,-%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB" target="_blank" rel="noopener noreferrer">Eloquent：利用の開始 6.x Laravel</a><br><br>試しにモデルファイルに以下のように書き、&nbsp;<code>booted()</code>&nbsp;のところにマウスをホバーさせてVSCodeのヒントを表示してみます。</p><pre><code class="hljs"><span class="hljs-comment">// モデルファイルに記述</span>
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> void
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">booted</span>(<span class="hljs-params"></span>): <span class="hljs-title">void</span>
</span>{
    <span class="hljs-comment">//</span>
}

<span class="hljs-comment">// booted() にマウスをホバーさせると、以下の説明が表示される</span>
Illuminate\Database\Eloquent\<span class="hljs-title class_">Model</span>::booted

Perform any actions required after the model boots.

<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">booted</span>(<span class="hljs-params"></span>) </span>{ }</code></pre><p><code>booted</code>メソッドについては、&nbsp;<code>Perform any actions required after the model boots.</code>&nbsp;と説明されています。<br><br><code>boot()</code>&nbsp;を書いた場合も確認します。</p><pre><code class="hljs"><span class="hljs-comment">// モデルファイルに記述</span>
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@return</span> void
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span>(<span class="hljs-params"></span>): <span class="hljs-title">void</span>
</span>{
    <span class="hljs-comment">//</span>
}

<span class="hljs-comment">// boot() にマウスをホバーさせると、以下の説明が出る</span>
Illuminate\Database\Eloquent\<span class="hljs-title class_">Model</span>::boot

Bootstrap the model <span class="hljs-keyword">and</span> its traits.

<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span>(<span class="hljs-params"></span>) </span>{ }
@<span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span></code></pre><p><code>boot</code>&nbsp;メソッドは&nbsp;<code>Bootstrap the model and its traits.</code>&nbsp;と説明がありました。<br><br>※実際のLaravelのソースコードだと、以下のファイルに&nbsp;<code>boot</code>&nbsp;メソッドも&nbsp;<code>booted</code>&nbsp;メソッドもありました。　<br>興味のある方はこちらもご覧ください。<br><a href="https://github.com/laravel/framework/blob/9.x/src/Illuminate/Database/Eloquent/Model.php" target="_blank" rel="noopener noreferrer">framework/Model.php at 9.x · laravel/framework</a><br><br>メソッド名の通りですが、&nbsp;<code>booted</code>メソッドはモデルの初期起動後に実行されているということですね。<br>私は業務ではLaravel8を使っており、&nbsp;<code>boot</code>&nbsp;メソッドでも&nbsp;<code>booted</code>&nbsp;メソッドでも同じように設定を行うことは出来ましたが、現在の&nbsp;<code>readouble</code>&nbsp;の説明に従って&nbsp;<code>booted</code>メソッドを使っていきたいと思います。<br></p><h2 id="haaaceead0a">Modelのbootedメソッドにクロージャを書く</h2><p>前置きが長くなりましたが、実際にモデルの&nbsp;<code>booted</code>&nbsp;メソッドに「データを論理削除したらリレーション先のデータも削除する」設定を記述します。<br></p><h3 id="h8a175a9b0e">前提</h3><ul><li><code>users</code>&nbsp;テーブル（親）と<strong>1対多</strong>で紐づく&nbsp;<code>posts</code>&nbsp;テーブルがあるとします。</li><li><code>users</code>&nbsp;テーブルからレコードを論理削除したら、 リレーション先の<code>posts</code>&nbsp;テーブルからもレコードを論理削除するように設定します。</li></ul><p><br></p><h3 id="hf031c5e696">実装方法</h3><p><code>User.php</code>にリレーションと&nbsp;<code>booted</code>メソッドを追記します。</p><pre><code class="hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">HasFactory</span>, <span class="hljs-title">SoftDeletes</span>;

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@return</span> HasMany
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">posts</span><span class="hljs-params">()</span>: <span class="hljs-title">HasMany</span>
    </span>{
        <span class="hljs-keyword">return</span> $this-&gt;hasMany(Post::class);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">booted</span><span class="hljs-params">()</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">static</span>::deleted(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($user)</span> </span>{
            $user-&gt;posts()-&gt;delete();
        });
    }
}</code></pre><p>これにより、&nbsp;<code>users</code>&nbsp;テーブルのデータ削除時に、リレーション先の&nbsp;<code>posts</code>&nbsp;テーブルからも同時に削除してくれます。<br><br>※&nbsp;<code>posts</code>&nbsp;テーブルに対してもソフトデリートの設定を行っている場合は&nbsp;<code>posts</code>&nbsp;テーブルも論理削除、何も設定していなければ&nbsp;<code>posts</code>&nbsp;テーブルからは物理削除になります。<br></p><h2 id="h3bcda3e6b0">最後に</h2><p>論理削除はDBのレコードを削除するわけでは無く、SQLの命令文でいうと&nbsp;<code>UPDATE</code>&nbsp;にあたるので、論理削除の場合はDB的には削除と見なされないということは、よく考えると当たり前でもありますが改めて勉強になりました。<br><br>またモデルの&nbsp;<code>boot</code>&nbsp;メソッドや&nbsp;<code>booted</code>&nbsp;メソッドの使い方や、これらが出来ることについても良い学びになりました。<br>Laravelのライフサイクルの理解を深めれば、もっともっと実装の引き出しが増えるんだろうなと思うので、コツコツ勉強していきたいと思います。<br></p><h2 id="he45680f0bc">参考記事</h2><p><br><a href="https://readouble.com/laravel/8.x/ja/eloquent.html" target="_blank" rel="noopener noreferrer">Eloquentの準備 8.x Laravel</a><br><br><a href="https://yaba-blog.com/larave-soft-delete/#toc3" target="_blank" rel="noopener noreferrer">【Laravel】リレーション先のデータを論理削除（Soft Delete）する方法</a><br><br><a href="https://zenn.dev/naoki_oshiumi/articles/e16c9fbb4dfa3d" target="_blank" rel="noopener noreferrer">レコードが削除されたときに子要素も一緒に削除する(laravel)</a><br><br><a href="https://qiita.com/niisan-tokyo/items/d3be588b53df8fa0278c" target="_blank" rel="noopener noreferrer">Laravelのマニュアルにない?小技: Eloquentのboot時にtraitのbootを別に走らせる - Qiita</a><br></p></body></html></div></div></div><style data-emotion="css 2sbw87">.css-2sbw87{background-color:#494949;margin:0 auto;padding-top:30px;padding-bottom:30px;color:#f2f2f2;letter-spacing:0.08rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-around;-ms-flex-pack:space-around;-webkit-justify-content:space-around;justify-content:space-around;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="css-2sbw87"><style data-emotion="css kta5xp">.css-kta5xp{box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}@media (min-width:600px){.css-kta5xp{-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}}@media (min-width:900px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1200px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1536px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}</style><div class="MuiGrid-root MuiGrid-grid-xs-10 MuiGrid-grid-md-8 css-kta5xp"><style data-emotion="css 1lx0lai">.css-1lx0lai{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;text-align:center;}</style><div class="MuiGrid-root MuiGrid-item css-1lx0lai"><a href="https://twitter.com/napi_nami"><style data-emotion="css 1ea777n">.css-1ea777n{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;margin:8px;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TwitterIcon"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a href="https://github.com/hinakonagao"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></div><style data-emotion="css 198jr53">.css-198jr53{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;text-align:center;font-weight:200;}</style><p class="MuiTypography-root MuiTypography-body2 css-198jr53">© 2022 hinako blog</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"id":"laravel-softdelete","createdAt":"2022-03-02T23:54:39.267Z","updatedAt":"2022-03-02T23:55:00.491Z","publishedAt":"2022-02-23T23:54:39.000Z","revisedAt":"2022-03-02T23:54:39.267Z","title":"【Laravel】論理削除（softDelete）するときにリレーション先のデータも削除する方法","body":"\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eLaravelでは、マイグレーションファイルに外部キー制約の設定を記述しておくと、親テーブルのデータを削除したときに子テーブルのデータも同時に削除することができます。\u003cbr\u003e\u003cbr\u003e但しこれは、DBから実際にデータを削除する「\u003cstrong\u003e物理削除\u003c/strong\u003e」の場合の話です。\u003cbr\u003eDBからレコードを削除するわけではなく削除フラグを立てて削除したとみなす「\u003cstrong\u003e論理削除\u003c/strong\u003e」の場合は、マイグレーションファイルへの記述だけではリレーション先のデータを一緒に削除してくれません。\u003cbr\u003eこのような場合に、\u0026nbsp;\u003cstrong\u003eモデルの\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eboot\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド（もしくは\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003ebooted\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド）を使って初期設定を行えば\u003c/strong\u003e、あるテーブルのデータを論理削除したときにリレーション先のテーブルのデータも削除することができます。\u003cbr\u003e業務でこの方法を使う機会があったので、 モデル\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドについて勉強したこととあわせて、備忘録を書いておきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hafc8e872cc\"\u003e論理削除（softDelete）の設定方法\u003c/h2\u003e\u003cp\u003eまず事前準備としてソフトデリートの設定をします。\u003cbr\u003e\u003cbr\u003eソフトデリート機能を組み込む手順は以下の2つです。\u003cbr\u003e\u003cbr\u003e1.　マイグレーションファイルにソフトデリートの設定を記述する\u003cbr\u003e2.　EloquentモデルにSoftDeletesトレイトを組み込む\u003cbr\u003e\u003cbr\u003e例として\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルにソフトデリート機能を設定してみます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hb5391332f6\"\u003e1. マイグレーションファイルにソフトデリートの設定を記述する\u003c/h3\u003e\u003cp\u003eLaravelの論理削除ではテーブルの\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムに値が入っている場合はデータは削除されたとみなすので、\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加する必要があります。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加するため、マイグレーションファイルに以下の1行を追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003epublicfunction up()\n{\n    Schema::table('user',function (Blueprint $table) {\n        $table-\u0026gt;softDeletes();    // 追記\n    });\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれでマイグレーションを実行すると、DBのテーブルに\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムが作成されていることが確認できます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h4383fed8c3\"\u003e2. EloquentモデルにSoftDeletesトレイトを組み込む\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser\u003c/code\u003e\u0026nbsp;モデルファイルに以下のように追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003euse Illuminate\\Database\\Eloquent\\SoftDeletes;    // 追記\n\nclass User extends Model\n{\n    use SoftDeletes;    // 追記\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこの記述により、deleteメソッドでモデルを削除した際はソフトデリートが実行されるようになります。\u003cbr\u003e\u003cbr\u003eLaravelでソフトデリートを行うための設定は以上です。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h10178e1c1c\"\u003eモデルのbootedメソッドとは\u003c/h2\u003e\u003cp\u003e本題の「ソフトデリートするときにリレーション先のデータも削除する」ための実装にあたり、先に今回使用する\u0026nbsp;\u003ccode\u003eboooted\u003c/code\u003e\u0026nbsp;メソッドについて少し勉強しておきます。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;のモデルでは、初期起動時に\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドを走らせて初期設定をしています。\u003cbr\u003e\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドはモデルの初期起動後に実行されるメソッドで、モデルに対して行いたい初期設定は\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに書くよう\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;にも説明があります。\u003c/p\u003e\u003ch3 id=\"he23cb179bf\"\u003e【補足】bootedメソッドとbootメソッドについて\u003c/h3\u003e\u003cp\u003e今回実装方法をググっていると\u003ccode\u003eboot\u003c/code\u003eメソッドを使っている記事が見つかり、自分としても初期起動時のメソッドといえば\u003ccode\u003eboot\u003c/code\u003eメソッドのイメージがあったので、\u003ccode\u003ebooted\u003c/code\u003eメソッドと\u003ccode\u003eboot\u003c/code\u003eメソッドについて少し調べてみました。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明では、モデルの初期設定を行う方法としてLaravel6までは\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドが使われていますが、Laravel7以降では\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドが使われていました。\u003cbr\u003e・Laravel8の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%97%E3%81%AA%E3%81%84%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82-,%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E4%BD%BF%E7%94%A8,-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%AF%E3%83%A9%E3%82%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e・Laravel6の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/6.x/ja/eloquent.html#:~:text=%E9%98%B2%E3%81%92%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AE%E9%81%A9%E7%94%A8,-%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquent：利用の開始 6.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e試しにモデルファイルに以下のように書き、\u0026nbsp;\u003ccode\u003ebooted()\u003c/code\u003e\u0026nbsp;のところにマウスをホバーさせてVSCodeのヒントを表示してみます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// モデルファイルに記述\n/**\n * @return void\n */\npublic static function booted(): void\n{\n    //\n}\n\n// booted() にマウスをホバーさせると、以下の説明が表示される\nIlluminate\\Database\\Eloquent\\Model::booted\n\nPerform any actions required after the model boots.\n\n\u0026lt;?php\nprotected static function booted() { }\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003ebooted\u003c/code\u003eメソッドについては、\u0026nbsp;\u003ccode\u003ePerform any actions required after the model boots.\u003c/code\u003e\u0026nbsp;と説明されています。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eboot()\u003c/code\u003e\u0026nbsp;を書いた場合も確認します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// モデルファイルに記述\n/**\n * @return void\n */\npublic static function boot(): void\n{\n    //\n}\n\n// boot() にマウスをホバーさせると、以下の説明が出る\nIlluminate\\Database\\Eloquent\\Model::boot\n\nBootstrap the model and its traits.\n\n\u0026lt;?php\nprotected static function boot() { }\n@return void\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドは\u0026nbsp;\u003ccode\u003eBootstrap the model and its traits.\u003c/code\u003e\u0026nbsp;と説明がありました。\u003cbr\u003e\u003cbr\u003e※実際のLaravelのソースコードだと、以下のファイルに\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドもありました。　\u003cbr\u003e興味のある方はこちらもご覧ください。\u003cbr\u003e\u003ca href=\"https://github.com/laravel/framework/blob/9.x/src/Illuminate/Database/Eloquent/Model.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eframework/Model.php at 9.x · laravel/framework\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eメソッド名の通りですが、\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドはモデルの初期起動後に実行されているということですね。\u003cbr\u003e私は業務ではLaravel8を使っており、\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドでも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドでも同じように設定を行うことは出来ましたが、現在の\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明に従って\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを使っていきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"haaaceead0a\"\u003eModelのbootedメソッドにクロージャを書く\u003c/h2\u003e\u003cp\u003e前置きが長くなりましたが、実際にモデルの\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに「データを論理削除したらリレーション先のデータも削除する」設定を記述します。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8a175a9b0e\"\u003e前提\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブル（親）と\u003cstrong\u003e1対多\u003c/strong\u003eで紐づく\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルがあるとします。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルからレコードを論理削除したら、 リレーション先の\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからもレコードを論理削除するように設定します。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hf031c5e696\"\u003e実装方法\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser.php\u003c/code\u003eにリレーションと\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eclass User extends Model\n{\n    use HasFactory, SoftDeletes;\n\n    /**\n     * @return HasMany\n     */\n    public function posts(): HasMany\n    {\n        return $this-\u0026gt;hasMany(Post::class);\n    }\n\n    /**\n     * @return void\n     */\n    public static function booted(): void\n    {\n        static::deleted(function ($user) {\n            $user-\u0026gt;posts()-\u0026gt;delete();\n        });\n    }\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれにより、\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルのデータ削除時に、リレーション先の\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからも同時に削除してくれます。\u003cbr\u003e\u003cbr\u003e※\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルに対してもソフトデリートの設定を行っている場合は\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルも論理削除、何も設定していなければ\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからは物理削除になります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3bcda3e6b0\"\u003e最後に\u003c/h2\u003e\u003cp\u003e論理削除はDBのレコードを削除するわけでは無く、SQLの命令文でいうと\u0026nbsp;\u003ccode\u003eUPDATE\u003c/code\u003e\u0026nbsp;にあたるので、論理削除の場合はDB的には削除と見なされないということは、よく考えると当たり前でもありますが改めて勉強になりました。\u003cbr\u003e\u003cbr\u003eまたモデルの\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドや\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドの使い方や、これらが出来ることについても良い学びになりました。\u003cbr\u003eLaravelのライフサイクルの理解を深めれば、もっともっと実装の引き出しが増えるんだろうなと思うので、コツコツ勉強していきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://yaba-blog.com/larave-soft-delete/#toc3\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel】リレーション先のデータを論理削除（Soft Delete）する方法\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/naoki_oshiumi/articles/e16c9fbb4dfa3d\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eレコードが削除されたときに子要素も一緒に削除する(laravel)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/niisan-tokyo/items/d3be588b53df8fa0278c\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eLaravelのマニュアルにない?小技: Eloquentのboot時にtraitのbootを別に走らせる - Qiita\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"}],"image":"laravel"},"highlightedBody":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eLaravelでは、マイグレーションファイルに外部キー制約の設定を記述しておくと、親テーブルのデータを削除したときに子テーブルのデータも同時に削除することができます。\u003cbr\u003e\u003cbr\u003e但しこれは、DBから実際にデータを削除する「\u003cstrong\u003e物理削除\u003c/strong\u003e」の場合の話です。\u003cbr\u003eDBからレコードを削除するわけではなく削除フラグを立てて削除したとみなす「\u003cstrong\u003e論理削除\u003c/strong\u003e」の場合は、マイグレーションファイルへの記述だけではリレーション先のデータを一緒に削除してくれません。\u003cbr\u003eこのような場合に、\u0026nbsp;\u003cstrong\u003eモデルの\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eboot\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド（もしくは\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003ebooted\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド）を使って初期設定を行えば\u003c/strong\u003e、あるテーブルのデータを論理削除したときにリレーション先のテーブルのデータも削除することができます。\u003cbr\u003e業務でこの方法を使う機会があったので、 モデル\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドについて勉強したこととあわせて、備忘録を書いておきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hafc8e872cc\"\u003e論理削除（softDelete）の設定方法\u003c/h2\u003e\u003cp\u003eまず事前準備としてソフトデリートの設定をします。\u003cbr\u003e\u003cbr\u003eソフトデリート機能を組み込む手順は以下の2つです。\u003cbr\u003e\u003cbr\u003e1.　マイグレーションファイルにソフトデリートの設定を記述する\u003cbr\u003e2.　EloquentモデルにSoftDeletesトレイトを組み込む\u003cbr\u003e\u003cbr\u003e例として\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルにソフトデリート機能を設定してみます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hb5391332f6\"\u003e1. マイグレーションファイルにソフトデリートの設定を記述する\u003c/h3\u003e\u003cp\u003eLaravelの論理削除ではテーブルの\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムに値が入っている場合はデータは削除されたとみなすので、\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加する必要があります。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加するため、マイグレーションファイルに以下の1行を追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003epublicfunction \u003cspan class=\"hljs-built_in\"\u003eup\u003c/span\u003e()\n{\n    Schema::table(\u003cspan class=\"hljs-string\"\u003e'user'\u003c/span\u003e,function (Blueprint \u003cspan class=\"hljs-variable\"\u003e$table\u003c/span\u003e) {\n        \u003cspan class=\"hljs-variable\"\u003e$table\u003c/span\u003e-\u0026gt;\u003cspan class=\"hljs-built_in\"\u003esoftDeletes\u003c/span\u003e();    \u003cspan class=\"hljs-comment\"\u003e// 追記\u003c/span\u003e\n    });\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれでマイグレーションを実行すると、DBのテーブルに\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムが作成されていることが確認できます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h4383fed8c3\"\u003e2. EloquentモデルにSoftDeletesトレイトを組み込む\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser\u003c/code\u003e\u0026nbsp;モデルファイルに以下のように追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003euse \u003cspan class=\"hljs-type\"\u003eIlluminate\u003c/span\u003e\\\u003cspan class=\"hljs-type\"\u003eDatabase\u003c/span\u003e\\\u003cspan class=\"hljs-type\"\u003eEloquent\u003c/span\u003e\\\u003cspan class=\"hljs-type\"\u003eSoftDeletes\u003c/span\u003e;    \u003cspan class=\"hljs-comment\"\u003e// 追記\u003c/span\u003e\n\n\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUser\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eModel\u003c/span\u003e\u003c/span\u003e\n{\n    use \u003cspan class=\"hljs-type\"\u003eSoftDeletes\u003c/span\u003e;    \u003cspan class=\"hljs-comment\"\u003e// 追記\u003c/span\u003e\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこの記述により、deleteメソッドでモデルを削除した際はソフトデリートが実行されるようになります。\u003cbr\u003e\u003cbr\u003eLaravelでソフトデリートを行うための設定は以上です。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h10178e1c1c\"\u003eモデルのbootedメソッドとは\u003c/h2\u003e\u003cp\u003e本題の「ソフトデリートするときにリレーション先のデータも削除する」ための実装にあたり、先に今回使用する\u0026nbsp;\u003ccode\u003eboooted\u003c/code\u003e\u0026nbsp;メソッドについて少し勉強しておきます。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;のモデルでは、初期起動時に\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドを走らせて初期設定をしています。\u003cbr\u003e\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドはモデルの初期起動後に実行されるメソッドで、モデルに対して行いたい初期設定は\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに書くよう\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;にも説明があります。\u003c/p\u003e\u003ch3 id=\"he23cb179bf\"\u003e【補足】bootedメソッドとbootメソッドについて\u003c/h3\u003e\u003cp\u003e今回実装方法をググっていると\u003ccode\u003eboot\u003c/code\u003eメソッドを使っている記事が見つかり、自分としても初期起動時のメソッドといえば\u003ccode\u003eboot\u003c/code\u003eメソッドのイメージがあったので、\u003ccode\u003ebooted\u003c/code\u003eメソッドと\u003ccode\u003eboot\u003c/code\u003eメソッドについて少し調べてみました。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明では、モデルの初期設定を行う方法としてLaravel6までは\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドが使われていますが、Laravel7以降では\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドが使われていました。\u003cbr\u003e・Laravel8の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%97%E3%81%AA%E3%81%84%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82-,%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E4%BD%BF%E7%94%A8,-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%AF%E3%83%A9%E3%82%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e・Laravel6の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/6.x/ja/eloquent.html#:~:text=%E9%98%B2%E3%81%92%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AE%E9%81%A9%E7%94%A8,-%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquent：利用の開始 6.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e試しにモデルファイルに以下のように書き、\u0026nbsp;\u003ccode\u003ebooted()\u003c/code\u003e\u0026nbsp;のところにマウスをホバーさせてVSCodeのヒントを表示してみます。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-comment\"\u003e// モデルファイルに記述\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e/**\n * \u003cspan class=\"hljs-doctag\"\u003e@return\u003c/span\u003e void\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ebooted\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-title\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e{\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// booted() にマウスをホバーさせると、以下の説明が表示される\u003c/span\u003e\nIlluminate\\Database\\Eloquent\\\u003cspan class=\"hljs-title class_\"\u003eModel\u003c/span\u003e::booted\n\nPerform any actions required after the model boots.\n\n\u003cspan class=\"hljs-meta\"\u003e\u0026lt;?php\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ebooted\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) \u003c/span\u003e{ }\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003ebooted\u003c/code\u003eメソッドについては、\u0026nbsp;\u003ccode\u003ePerform any actions required after the model boots.\u003c/code\u003e\u0026nbsp;と説明されています。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eboot()\u003c/code\u003e\u0026nbsp;を書いた場合も確認します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-comment\"\u003e// モデルファイルに記述\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e/**\n * \u003cspan class=\"hljs-doctag\"\u003e@return\u003c/span\u003e void\n */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eboot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-title\"\u003evoid\u003c/span\u003e\n\u003c/span\u003e{\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// boot() にマウスをホバーさせると、以下の説明が出る\u003c/span\u003e\nIlluminate\\Database\\Eloquent\\\u003cspan class=\"hljs-title class_\"\u003eModel\u003c/span\u003e::boot\n\nBootstrap the model \u003cspan class=\"hljs-keyword\"\u003eand\u003c/span\u003e its traits.\n\n\u003cspan class=\"hljs-meta\"\u003e\u0026lt;?php\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eboot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) \u003c/span\u003e{ }\n@\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドは\u0026nbsp;\u003ccode\u003eBootstrap the model and its traits.\u003c/code\u003e\u0026nbsp;と説明がありました。\u003cbr\u003e\u003cbr\u003e※実際のLaravelのソースコードだと、以下のファイルに\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドもありました。　\u003cbr\u003e興味のある方はこちらもご覧ください。\u003cbr\u003e\u003ca href=\"https://github.com/laravel/framework/blob/9.x/src/Illuminate/Database/Eloquent/Model.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eframework/Model.php at 9.x · laravel/framework\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eメソッド名の通りですが、\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドはモデルの初期起動後に実行されているということですね。\u003cbr\u003e私は業務ではLaravel8を使っており、\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドでも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドでも同じように設定を行うことは出来ましたが、現在の\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明に従って\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを使っていきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"haaaceead0a\"\u003eModelのbootedメソッドにクロージャを書く\u003c/h2\u003e\u003cp\u003e前置きが長くなりましたが、実際にモデルの\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに「データを論理削除したらリレーション先のデータも削除する」設定を記述します。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8a175a9b0e\"\u003e前提\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブル（親）と\u003cstrong\u003e1対多\u003c/strong\u003eで紐づく\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルがあるとします。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルからレコードを論理削除したら、 リレーション先の\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからもレコードを論理削除するように設定します。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hf031c5e696\"\u003e実装方法\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser.php\u003c/code\u003eにリレーションと\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eUser\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eModel\u003c/span\u003e\n\u003c/span\u003e{\n    \u003cspan class=\"hljs-keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eHasFactory\u003c/span\u003e, \u003cspan class=\"hljs-title\"\u003eSoftDeletes\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-comment\"\u003e/**\n     * \u003cspan class=\"hljs-doctag\"\u003e@return\u003c/span\u003e HasMany\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eposts\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e: \u003cspan class=\"hljs-title\"\u003eHasMany\u003c/span\u003e\n    \u003c/span\u003e{\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e $this-\u0026gt;hasMany(Post::class);\n    }\n\n    \u003cspan class=\"hljs-comment\"\u003e/**\n     * \u003cspan class=\"hljs-doctag\"\u003e@return\u003c/span\u003e void\n     */\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ebooted\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e: \u003cspan class=\"hljs-title\"\u003evoid\u003c/span\u003e\n    \u003c/span\u003e{\n        \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e::deleted(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-params\"\u003e($user)\u003c/span\u003e \u003c/span\u003e{\n            $user-\u0026gt;posts()-\u0026gt;delete();\n        });\n    }\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれにより、\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルのデータ削除時に、リレーション先の\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからも同時に削除してくれます。\u003cbr\u003e\u003cbr\u003e※\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルに対してもソフトデリートの設定を行っている場合は\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルも論理削除、何も設定していなければ\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからは物理削除になります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3bcda3e6b0\"\u003e最後に\u003c/h2\u003e\u003cp\u003e論理削除はDBのレコードを削除するわけでは無く、SQLの命令文でいうと\u0026nbsp;\u003ccode\u003eUPDATE\u003c/code\u003e\u0026nbsp;にあたるので、論理削除の場合はDB的には削除と見なされないということは、よく考えると当たり前でもありますが改めて勉強になりました。\u003cbr\u003e\u003cbr\u003eまたモデルの\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドや\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドの使い方や、これらが出来ることについても良い学びになりました。\u003cbr\u003eLaravelのライフサイクルの理解を深めれば、もっともっと実装の引き出しが増えるんだろうなと思うので、コツコツ勉強していきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://yaba-blog.com/larave-soft-delete/#toc3\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel】リレーション先のデータを論理削除（Soft Delete）する方法\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/naoki_oshiumi/articles/e16c9fbb4dfa3d\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eレコードが削除されたときに子要素も一緒に削除する(laravel)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/niisan-tokyo/items/d3be588b53df8fa0278c\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eLaravelのマニュアルにない?小技: Eloquentのboot時にtraitのbootを別に走らせる - Qiita\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003c/body\u003e\u003c/html\u003e"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"laravel-softdelete"},"buildId":"EwuWiZmkeG3lYlO_XC9fM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>