<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4bc12c1be68739c7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4bc12c1be68739c7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-101cfeaa18eb0e64.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a602b05d6a5b45c.js" defer=""></script><script src="/_next/static/chunks/451-8446afed8f2a81ca.js" defer=""></script><script src="/_next/static/chunks/49-d35eb4e044ca3943.js" defer=""></script><script src="/_next/static/chunks/pages/index-b1d98640f1f6b8fa.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_buildManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_ssgManifest.js" defer=""></script><script src="/_next/static/EwuWiZmkeG3lYlO_XC9fM/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><style data-emotion="css 183devt">.css-183devt{background-color:#FFF;color:#333;}</style><style data-emotion="css r6vx3e">.css-r6vx3e{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;background-color:#1976d2;color:#fff;background-color:#FFF;color:#333;}</style><style data-emotion="css 7fouig">.css-7fouig{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;background-color:#1976d2;color:#fff;background-color:#FFF;color:#333;}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-7fouig"><style data-emotion="css 1svgg4d">.css-1svgg4d{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;margin-left:32px;margin-right:32px;}@media (min-width:600px){.css-1svgg4d{padding-left:24px;padding-right:24px;}}@media (min-width:0px) and (orientation: landscape){.css-1svgg4d{min-height:48px;}}@media (min-width:600px){.css-1svgg4d{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-1svgg4d"><style data-emotion="css 1247i0s">.css-1247i0s{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;font-size:20px;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><p class="MuiTypography-root MuiTypography-body1 css-1247i0s">hinako blog<style data-emotion="css wwwrrx">.css-wwwrrx{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;margin-left:8px;vertical-align:middle;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-wwwrrx" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="IntegrationInstructionsOutlinedIcon"><path d="M11 14.17 8.83 12 11 9.83 9.59 8.41 6 12l3.59 3.59zm3.41 1.42L18 12l-3.59-3.59L13 9.83 15.17 12 13 14.17z"></path><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-.14 0-.27.01-.4.04-.39.08-.74.28-1.01.55-.18.18-.33.4-.43.64-.1.23-.16.49-.16.77v14c0 .27.06.54.16.78s.25.45.43.64c.27.27.62.47 1.01.55.13.02.26.03.4.03h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7-.25c.41 0 .75.34.75.75s-.34.75-.75.75-.75-.34-.75-.75.34-.75.75-.75zM19 15v4H5V5h14v10z"></path></svg></p><style data-emotion="css aeicvb">.css-aeicvb{list-style:none;margin:0;padding:0;position:relative;padding-top:8px;padding-bottom:8px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><ul class="MuiList-root MuiList-padding css-aeicvb"><style data-emotion="css 14ad3f4">.css-14ad3f4{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;-webkit-text-decoration:none;text-decoration:none;box-sizing:border-box;text-align:left;padding-top:8px;padding-bottom:8px;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding-left:16px;padding-right:16px;}.css-14ad3f4:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-14ad3f4:hover{background-color:transparent;}}.css-14ad3f4.Mui-selected{background-color:rgba(25, 118, 210, 0.08);}.css-14ad3f4.Mui-selected.Mui-focusVisible{background-color:rgba(25, 118, 210, 0.2);}.css-14ad3f4.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.12);}@media (hover: none){.css-14ad3f4.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.08);}}.css-14ad3f4.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.12);}.css-14ad3f4.Mui-disabled{opacity:0.38;}</style><style data-emotion="css e0yuwi">.css-e0yuwi{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;-webkit-text-decoration:none;text-decoration:none;box-sizing:border-box;text-align:left;padding-top:8px;padding-bottom:8px;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding-left:16px;padding-right:16px;}.css-e0yuwi::-moz-focus-inner{border-style:none;}.css-e0yuwi.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-e0yuwi{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-e0yuwi:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-e0yuwi:hover{background-color:transparent;}}.css-e0yuwi.Mui-selected{background-color:rgba(25, 118, 210, 0.08);}.css-e0yuwi.Mui-selected.Mui-focusVisible{background-color:rgba(25, 118, 210, 0.2);}.css-e0yuwi.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.12);}@media (hover: none){.css-e0yuwi.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.08);}}.css-e0yuwi.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.12);}.css-e0yuwi.Mui-disabled{opacity:0.38;}</style><a class="MuiListItemButton-root MuiListItemButton-gutters MuiButtonBase-root css-e0yuwi" tabindex="0" href="/"><style data-emotion="css 1tsvksn">.css-1tsvksn{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;min-width:0;margin-top:4px;margin-bottom:4px;}</style><div class="MuiListItemText-root css-1tsvksn"><style data-emotion="css yb0lig">.css-yb0lig{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;display:block;}</style><span class="MuiTypography-root MuiTypography-body1 MuiListItemText-primary css-yb0lig">Blog</span></div><style data-emotion="css 1r5zk36">.css-1r5zk36{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;font-size:18px;margin-left:4px;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1r5zk36" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="DescriptionOutlinedIcon"><path d="M8 16h8v2H8zm0-4h8v2H8zm6-10H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"></path></svg></a></ul></div></header><style data-emotion="css 1d3bbye">.css-1d3bbye{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}</style><div class="MuiGrid-root MuiGrid-container css-1d3bbye"><style data-emotion="css c67oew">.css-c67oew{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;max-width:1500px;padding-top:48px;margin-bottom:40px;margin:auto;}@media (min-width:600px){.css-c67oew{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:900px){.css-c67oew{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:1200px){.css-c67oew{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}@media (min-width:1536px){.css-c67oew{-webkit-flex-basis:91.666667%;-ms-flex-preferred-size:91.666667%;flex-basis:91.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:91.666667%;}}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-item MuiGrid-grid-xs-11 css-c67oew"><style data-emotion="css 1cqxkba">.css-1cqxkba{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;padding:8px;background-color:#FFF;margin-bottom:40px;}@media (min-width:600px){.css-1cqxkba{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:900px){.css-1cqxkba{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1200px){.css-1cqxkba{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}@media (min-width:1536px){.css-1cqxkba{-webkit-flex-basis:75%;-ms-flex-preferred-size:75%;flex-basis:75%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:75%;}}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-sm-9 css-1cqxkba"><p>There are no posts...</p><ul class="pagination"><li class="previous disabled"><a class=" " tabindex="-1" role="button" aria-disabled="true" aria-label="Previous page" rel="prev">&lt;</a></li><li class="active"><a rel="canonical" role="button" tabindex="-1" aria-label="Page 1 is your current page" aria-current="page">1</a></li><li><a rel="next" role="button" tabindex="0" aria-label="Page 2">2</a></li><li class="next"><a class="" tabindex="0" role="button" aria-disabled="false" aria-label="Next page" rel="next">&gt;</a></li></ul></div><style data-emotion="css pur55n">.css-pur55n{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}@media (min-width:600px){.css-pur55n{-webkit-flex-basis:4.166667%;-ms-flex-preferred-size:4.166667%;flex-basis:4.166667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:4.166667%;}}@media (min-width:900px){.css-pur55n{-webkit-flex-basis:4.166667%;-ms-flex-preferred-size:4.166667%;flex-basis:4.166667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:4.166667%;}}@media (min-width:1200px){.css-pur55n{-webkit-flex-basis:4.166667%;-ms-flex-preferred-size:4.166667%;flex-basis:4.166667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:4.166667%;}}@media (min-width:1536px){.css-pur55n{-webkit-flex-basis:4.166667%;-ms-flex-preferred-size:4.166667%;flex-basis:4.166667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:4.166667%;}}</style><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-0 MuiGrid-grid-sm-0.5 css-pur55n"></div><style data-emotion="css mmrudf">.css-mmrudf{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;margin-bottom:40px;}@media (min-width:600px){.css-mmrudf{-webkit-flex-basis:20.833333%;-ms-flex-preferred-size:20.833333%;flex-basis:20.833333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:20.833333%;}}@media (min-width:900px){.css-mmrudf{-webkit-flex-basis:20.833333%;-ms-flex-preferred-size:20.833333%;flex-basis:20.833333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:20.833333%;}}@media (min-width:1200px){.css-mmrudf{-webkit-flex-basis:20.833333%;-ms-flex-preferred-size:20.833333%;flex-basis:20.833333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:20.833333%;}}@media (min-width:1536px){.css-mmrudf{-webkit-flex-basis:20.833333%;-ms-flex-preferred-size:20.833333%;flex-basis:20.833333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:20.833333%;}}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-sm-2.5 css-mmrudf"><style data-emotion="css 1qqe9z2">.css-1qqe9z2{list-style:none;margin:0;padding:0;position:relative;padding-top:0;padding-bottom:8px;width:100%;background-color:#fff;height:500px;}</style><nav class="MuiList-root MuiList-padding MuiList-subheader css-1qqe9z2" aria-labelledby="nested-list-subheader"><style data-emotion="css 15mux4r">.css-15mux4r{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:#444;padding-top:4px;padding-bottom:4px;padding-left:32px;padding-right:32px;margin-top:8px;margin-bottom:8px;font-size:18px;border-bottom:solid 0.7px #888;}</style><div class="MuiTypography-root MuiTypography-body1 css-15mux4r"># Tags</div><style data-emotion="css 9opimv">.css-9opimv{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;-webkit-text-decoration:none;text-decoration:none;box-sizing:border-box;text-align:left;padding-top:8px;padding-bottom:8px;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding-left:16px;padding-right:16px;padding-top:4px;padding-bottom:4px;padding-left:32px;padding-right:32px;min-height:32px;}.css-9opimv:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-9opimv:hover{background-color:transparent;}}.css-9opimv.Mui-selected{background-color:rgba(25, 118, 210, 0.08);}.css-9opimv.Mui-selected.Mui-focusVisible{background-color:rgba(25, 118, 210, 0.2);}.css-9opimv.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.12);}@media (hover: none){.css-9opimv.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.08);}}.css-9opimv.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.12);}.css-9opimv.Mui-disabled{opacity:0.38;}</style><style data-emotion="css 1r556wr">.css-1r556wr{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;-webkit-text-decoration:none;text-decoration:none;box-sizing:border-box;text-align:left;padding-top:8px;padding-bottom:8px;-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding-left:16px;padding-right:16px;padding-top:4px;padding-bottom:4px;padding-left:32px;padding-right:32px;min-height:32px;}.css-1r556wr::-moz-focus-inner{border-style:none;}.css-1r556wr.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1r556wr{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1r556wr:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-1r556wr:hover{background-color:transparent;}}.css-1r556wr.Mui-selected{background-color:rgba(25, 118, 210, 0.08);}.css-1r556wr.Mui-selected.Mui-focusVisible{background-color:rgba(25, 118, 210, 0.2);}.css-1r556wr.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.12);}@media (hover: none){.css-1r556wr.Mui-selected:hover{background-color:rgba(25, 118, 210, 0.08);}}.css-1r556wr.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.12);}.css-1r556wr.Mui-disabled{opacity:0.38;}</style><div class="MuiListItemButton-root MuiListItemButton-gutters MuiButtonBase-root css-1r556wr" tabindex="0" role="button"><style data-emotion="css 1tsvksn">.css-1tsvksn{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;min-width:0;margin-top:4px;margin-bottom:4px;}</style><div class="MuiListItemText-root css-1tsvksn"><style data-emotion="css 1dg887a">.css-1dg887a{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;display:block;font-size:15px;}</style><span class="MuiTypography-root MuiTypography-body1 MuiListItemText-primary css-1dg887a">All</span></div></div></nav></div></div></div><style data-emotion="css 2sbw87">.css-2sbw87{background-color:#494949;margin:0 auto;padding-top:30px;padding-bottom:30px;color:#f2f2f2;letter-spacing:0.08rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-around;-ms-flex-pack:space-around;-webkit-justify-content:space-around;justify-content:space-around;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="css-2sbw87"><style data-emotion="css kta5xp">.css-kta5xp{box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}@media (min-width:600px){.css-kta5xp{-webkit-flex-basis:83.333333%;-ms-flex-preferred-size:83.333333%;flex-basis:83.333333%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:83.333333%;}}@media (min-width:900px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1200px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}@media (min-width:1536px){.css-kta5xp{-webkit-flex-basis:66.666667%;-ms-flex-preferred-size:66.666667%;flex-basis:66.666667%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:66.666667%;}}</style><div class="MuiGrid-root MuiGrid-grid-xs-10 MuiGrid-grid-md-8 css-kta5xp"><style data-emotion="css 1lx0lai">.css-1lx0lai{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;text-align:center;}</style><div class="MuiGrid-root MuiGrid-item css-1lx0lai"><a href="https://twitter.com/napi_nami"><style data-emotion="css 1ea777n">.css-1ea777n{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;margin:8px;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="TwitterIcon"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a href="https://github.com/hinakonagao"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1ea777n" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></div><style data-emotion="css 198jr53">.css-198jr53{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.875rem;line-height:1.43;letter-spacing:0.01071em;text-align:center;font-weight:200;}</style><p class="MuiTypography-root MuiTypography-body2 css-198jr53">© 2022 hinako blog</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blogs":[{"id":"csv-laravel-nextjs","createdAt":"2022-03-02T23:59:40.487Z","updatedAt":"2022-03-02T23:59:40.487Z","publishedAt":"2022-03-02T23:59:40.487Z","revisedAt":"2022-03-02T23:59:40.487Z","title":"【Laravel × Next.js】Axiosを使ってCSVファイルをダウンロードする","body":"\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eフロント\u003ccode\u003enext.js\u003c/code\u003e\u0026nbsp;× API\u0026nbsp;\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;の構成で作成しているアプリケーションにおいて、\u003cbr\u003e「フロント側でとあるボタンをクリックしたら、API側で生成した\u003cstrong\u003eCSVファイル\u003c/strong\u003eをダウンロードする」\u003cbr\u003eという機能を業務で実装する機会があったので、実装方法や勉強になったことをまとめておきます。\u003cbr\u003e\u003cbr\u003e全体の流れは以下の通りです。\u003cbr\u003e\u003cbr\u003e1.　フロント側から\u003ccode\u003eAxios\u003c/code\u003eを使ってAPIへリクエストを飛ばす。\u003cbr\u003e2.　API側（\u003ccode\u003eLaravel\u003c/code\u003e）でCSVファイルを生成し、レスポンスとして返す。\u003cbr\u003e3.　フロント側でレスポンスを受け取り、CSVファイルをダウンロードする。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"he52b44f87d\"\u003eAPI側の実装\u003c/h1\u003e\u003cp\u003eAPI側から実装していきます。\u003cbr\u003e※本来はサービスクラスなどへ処理を切り分けるべきではありますが、ここではコントローラーに全ての処理を書くものとします。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf64c7c1253\"\u003eルーティング\u003c/h2\u003e\u003cp\u003eフロント側（\u003ccode\u003eNext.js\u003c/code\u003e）から\u003ccode\u003eAxios\u003c/code\u003eで送られてくるリクエストに対するルーティングを定義します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// routes/api.php\n\nRoute::get('/download/csv', [DownloadCsvController::class, 'downloadCsv']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここで定義した通り、\u003ccode\u003eDownloadCsvController\u003c/code\u003eの\u003ccode\u003edownloadCsv\u003c/code\u003eメソッドにCSVファイルを生成してレスポンスとして返す処理をかいていきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2171e4cd81\"\u003eコントローラー\u003c/h2\u003e\u003ch3 id=\"h50212800e7\"\u003eコードの概要\u003c/h3\u003e\u003cp\u003e先に概要だけざっくり説明すると、以下の通りです。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eLaravelの\u003ccode\u003estreamDownload\u003c/code\u003eメソッドを使って、CSVファイルをレスポンスとして返す。\u003c/li\u003e\u003cli\u003e\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは引数を3つ取るので、各引数を用意する。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e※\u003ccode\u003estreamDownload\u003c/code\u003eメソッドについてはReadoubleの以下の箇所を参照ください。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/responses.html?header=%25E3%2582%25B9%25E3%2583%2588%25E3%2583%25AA%25E3%2583%25BC%25E3%2583%25A0%25E3%2583%2580%25E3%2582%25A6%25E3%2583%25B3%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%2589#:~:text=%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89,-%E7%89%B9%E5%AE%9A%E3%81%AE%E6%93%8D%E4%BD%9C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHTTPレスポンス 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2faa5e3f79\"\u003eコードの全文\u003c/h3\u003e\u003cp\u003e詳しい解説は後にして、コードの全文を載せます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// DownloadCsvController.php\n\n/**\n * CSVダウンロード\n * @return StreamedResponse\n */\npublic function downloadCsv(): StreamedResponse\n{\n  // CSVファイル作成コールバック\n  $downloadCsvCallback = function () {\n    // CSVファイル作成\n    $csv = fopen('php://output', 'w');\n\n    // CSVの1行目\n    $colums = [\n      'id' =\u0026gt; 'ユーザーID',\n      'name' =\u0026gt; 'ユーザー名',\n      'email' =\u0026gt; 'メールアドレス'\n    ];\n    // 文字化け対策\n    mb_convert_variables('SJIS-win', 'UTF-8', $colums);\n    // CSVの1行目を記入\n    fputcsv($csv, $colums);\n\n    // CSVの2行目以降\n    $users = User::all();\n    foreach ($users as $user) {\n      $userData = [\n        'id' =\u0026gt; $user-\u0026gt;id,\n        'name' =\u0026gt; $user-\u0026gt;name,\n        'email' =\u0026gt; $user-\u0026gt;email\n      ];\n      // 文字化け対策\n      mb_convert_variables('SJIS-win', 'UTF-8', $userData );\n      // CSVファイルの2行目以降にユーザー情報を記入\n      fputcsv($csv, $userData);\n    }\n\n    // CSVファイルを閉じる\n    fclose($csv);\n  }\n\n  // ファイル名\n  $fileName = 'ユーザー情報.csv';\n\n  // レスポンスヘッダー情報\n  $responseHeader = [\n    'Content-type' =\u0026gt; 'text/csv',\n    'Access-Control-Expose-Headers' =\u0026gt; 'Content-Disposition'\n  ],\n\n  return response()-\u0026gt;streamDownload($downloadCsvCallback, $fileName, $responseHeader);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eここから上記のコードのポイントを解説していきます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h3693827ec3\"\u003esteramDownloadメソッド\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e引数と返り値について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e先述の通り、\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドは以下の3つの引数を取り、返り値は\u0026nbsp;\u003ccode\u003eSymfony\\Component\\HttpFoundation\\StreamedResponse\u003c/code\u003eとなります。\u003cbr\u003e　・第1引数：エクスポートするファイルを生成するコールバック関数\u003cbr\u003e　・第2引数：ファイル名\u003cbr\u003e　・第3引数：レスポンスヘッダーの配列\u003cbr\u003e\u003cbr\u003e今回の構成では、フロント側（\u003ccode\u003eNext.js\u003c/code\u003e）からAPIリクエストを受け取って\u003ccode\u003eStreamedResponse\u003c/code\u003eの形式でレスポンスを返すことになります。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eレスポンスヘッダーについて\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eHTTPレスポンスの際に、ブラウザで表示するのではなくファイルをブラウザでダウンロードさせたい場合は、レスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを持たせる必要があります。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition#:~:text=Content%2DDisposition%3A%20attachment%3B%20filename%3D%22filename.jpg%22\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Disposition - HTTP | MDN\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// レスポンスヘッダーに以下の記述が必要\nContent-Disposition: attachment\n\n// ファイル名を指定する場合\nContent-Disposition: attachment; filename=\"filename.jpg\"\n\n// ファイル名をエンコードする場合\nContent-Disposition: attachment; filename*=UTF-8''URLエンコーディングされたファイル名\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eそこで\u003ccode\u003estreamDownload\u003c/code\u003eメソッドは、この\u003ccode\u003eContent-Disposition\u003c/code\u003eをよしなにレスポンスヘッダーに加えてくれます。\u003cbr\u003e\u003cbr\u003e以下の画像は、第2引数に\u003ccode\u003e'ファイル.csv'\u003c/code\u003eと指定してレスポンスを返した際のレスポンスヘッダーを、検証ツールで確認したものです。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6a50ee5392784850a2205c44dc23d633/%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%83%98%E3%83%83%E3%83%80%E3%83%BC.jpg\" alt=\"\"\u003e\u003cbr\u003eファイル名に日本語を指定すると、URLエンコーディングされた状態でレスポンスヘッダーに付与されています。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"he1a46ab77a\"\u003eCSVファイル作成コールバック\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eCSVファイルの作成\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eコールバック関数内で行う処理の大まかな流れは以下の通りで、\u003cbr\u003e\u003ccode\u003eCSVファイルを作成→中身を書き込む→ファイルを閉じる\u003c/code\u003e\u003cbr\u003eというものです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// ファイルを作成する\nfopen('php://output', 'w');  \n\n// CSVの1行目のカラムを記入する\nfputcsv($csv, $colums);\n\n// CSVの2行目以降に企業情報を記入する\nfputcsv($csv, $userData); \n\n// ファイルを閉じる\nfclose($csv);  \u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e文字化け対策について\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eデフォルトの文字コードは、\u003cbr\u003e・Excel：\u003ccode\u003eSJIS\u003c/code\u003e\u003cbr\u003e・PHP：\u003ccode\u003eUTF-8\u003c/code\u003e（\u003ccode\u003ephp.ini\u003c/code\u003eで設定されている）\u003cbr\u003eという違いがあります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// php.ini\ndefault_charset = \"UTF-8\"\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eなのでPHPの文字コードが\u003ccode\u003eUTF-8\u003c/code\u003eのままCSVファイルを生成すると、Excelで開いたときに文字化けしてしまいます。\u003cbr\u003e\u003cbr\u003eこれを防ぐため、PHPの\u003ccode\u003emb_convert_variables\u003c/code\u003e関数を使って文字コードを\u003ccode\u003eUTF-8\u003c/code\u003eから\u003ccode\u003eSJIS-win\u003c/code\u003eに変換します。\u003cbr\u003ePHPドキュメント：\u003ca style=\"color:#4aac00\" href=\"https://www.php.net/manual/ja/function.mb-convert-variables.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emb_convert_variables\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003emb_convert_variables('SJIS-win', 'UTF-8', $colums);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e※\u003ccode\u003eSJIS-win\u003c/code\u003eはWindows向けに使われる\u003ccode\u003eShift-JIS\u003c/code\u003eで、通常の\u003ccode\u003eSJIS\u003c/code\u003eよりも対応している文字が多いようです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h13b0fcb7b2\"\u003eレスポンスヘッダーについて\u003c/h3\u003e\u003cp\u003e先述の通り、\u003ccode\u003estreamDownload\u003c/code\u003eメソッドがレスポンスヘッダーに\u003ccode\u003eContent-Disposition\u003c/code\u003eを自動で含めてくれます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの要素はフロント側で\u0026nbsp;\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;から受け取ることが出来るので、後ほどフロント側でレスポンスヘッダーからファイル名を取得することになります。\u003cbr\u003e但し今回のような\u0026nbsp;\u003ccode\u003eCORS\u003c/code\u003e\u0026nbsp;の通信の場合、標準的なレスポンスヘッダー以外の場合はAPIから返すレスポンスヘッダーに\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eAccess-Control-Expose-Headers: {レスポンスヘッダ名}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eを追加しておかないと、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;からレスポンス情報を受け取ることが出来ないので、\u003ccode\u003eContent-Disposition\u003c/code\u003eについては上記の記述が必要です。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAccess-Control-Expose-Headers - HTTP | MDN\u003c/a\u003e\u003cbr\u003e参考記事：\u003ca style=\"color:#4aac00\" href=\"https://note.kiriukun.com/entry/20200303-axios-response-header-could-not-get\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAxiosでレスポンスヘッダが取得できなかった (CORSなAPI)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eよって\u003ccode\u003estreamDownload\u003c/code\u003eメソッドの第3引数には、以下のレスポンスヘッダー情報を渡します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// レスポンスヘッダー情報\n$responseHeader = [\n  'Content-type' =\u0026gt; 'text/csv',\n  'Access-Control-Expose-Headers' =\u0026gt; 'Content-Disposition' \n],\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAPI（\u003ccode\u003eLaravel\u003c/code\u003e）側の実装は以上です。\u003cbr\u003e\u003cbr\u003eここまでの実装で、直接APIのURLをブラウザのURLに入れてアクセスすればCSVファイルをダウンロードできるはずです。\u003cbr\u003eただしフロント側にレスポンスとして返すだけではフロント側ではファイルダウンロードは行われないので、続けてフロント側も実装していきます。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h5a8452001c\"\u003eフロント側の実装\u003c/h1\u003e\u003cp\u003eフロント側の実装方法は2通り紹介させていただきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h16c6498226\"\u003e実装方法①\u003c/h2\u003e\u003cp\u003e\u003ccode\u003efile-saver\u003c/code\u003e\u0026nbsp;というライブラリを使ってファイル保存を行います。\u003cbr\u003eライブラリ：\u003ca style=\"color:#4aac00\" href=\"https://www.npmjs.com/package/file-saver\" target=\"_blank\" rel=\"noopener noreferrer\"\u003efile-saver\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこのライブラリの\u0026nbsp;\u003ccode\u003esaveAs\u003c/code\u003e\u0026nbsp;メソッドに、\u003cbr\u003e\u003cbr\u003e・第1引数：\u0026nbsp;\u003ccode\u003eblob\u003c/code\u003e\u0026nbsp;オブジェクト\u003cbr\u003e・第2引数：ファイル名\u003cbr\u003e\u003cbr\u003eを渡すだけで、指定したファイル名でファイルを保存することができます。\u003cbr\u003e\u003cbr\u003e実装したコードは以下の通りです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eimport { saveAs } from 'file-saver'\n\n// 中略\n\naxiosApi\n  .get('/download/csv', {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    const blob = new Blob([res.data], { type: res.data.type })\n    const fileName = getFileName(res.headers['content-disposition'])\n    saveAs(blob, fileName)\n  })\n\nconst getFileName = (contentDisposition: string) =\u0026gt; {\n  return decodeURI(contentDisposition).substring(\n    contentDisposition.indexOf(\"''\") + 2,\n    contentDisposition.length,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h598587f39e\"\u003e\u003cbr\u003eポイント\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eresponseType: 'blob'\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eこの指定をしないと文字化けしてしまいます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003eファイル名の取得\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレスポンスヘッダーの情報は、\u003ccode\u003eAxiosResponse\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003eres\u003c/code\u003e\u0026nbsp;から、\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eres.headers['content-disposition']\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eのように書くと取り出すことができます。\u003cbr\u003e\u003cbr\u003eレスポンスヘッダーの\u003ccode\u003eContent-Disposition\u003c/code\u003eをフロント側で受け取り、出力してみると、以下のようにエンコードされた状態です。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eaxiosApi\n  .get(`/download/csv/${entryType}`, {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    console.log(res.headers['content-disposition'])    // 出力する\n    const blob = new Blob([res.data], { type: res.data.type })\n    const fileName = getFileName(res.headers['content-disposition'])\n    saveAs(blob, fileName)\n  })\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e出力結果\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eattachment; filename=___20220301173602.csv; filename*=utf-8''%E9%A1%A7%E5%AE%A2%E6%83%85%E5%A0%B1_%E3%82%82%E3%81%AE%E3%81%A5%E3%81%8F%E3%82%8A%E8%A3%.csv\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eなので上記の状態からデコードを行い、さらに\u003ccode\u003efilename*=utf-8''\u003c/code\u003e以降のファイル名の部分のみを切り取ります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst getFileName = (contentDisposition: string) =\u0026gt; {\n  return decodeURI(contentDisposition).substring(\n    contentDisposition.indexOf(\"''\") + 2,\n    contentDisposition.length,\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"he028bf746e\"\u003e\u003cbr\u003e実装方法②\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eHTML\u003c/code\u003e\u0026nbsp;の\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグに\u003ccode\u003edownload\u003c/code\u003e\u0026nbsp;属性を設定すると、\u0026nbsp;\u003ccode\u003ea\u003c/code\u003e\u0026nbsp;タグをクリックした場合、ブラウザはユーザーをそのURLへ遷移させるのではなくそのコンテンツを保存させます。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/HTML/Element/a#:~:text=%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82-,download,HTML5,-%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%95%E3%82%8C\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e: アンカー要素 - HTML: HyperText Markup Language | MDN\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこの機能を使ってファイル保存を行います。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eaxiosApi\n  .get('/download/csv', {\n    responseType: 'blob',\n  })\n  .then((res: AxiosResponse) =\u0026gt; {\n    // Blobを参照するための一時的なURLを生成\n    const url = window.URL.createObjectURL(new Blob([res.data]))\n    // HTML要素のaタグを生成\n    const link = document.createElement('a')\n    link.href = url\n    // aタグのdownload属性を設定\n    link.setAttribute('download', `顧客情報_ものづくり補助金_全件_${getTimestamp()}.csv`)\n    // 生成したaタグを設置し、クリックさせる\n    document.body.appendChild(link)\n    link.click()\n    // URLを削除\n    window.URL.revokeObjectURL(url)\n  }\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h1afe451c43\"\u003e\u003cbr\u003eさいごに\u003c/h2\u003e\u003cp\u003e自分で実装して検証ツールで確認しながら進めることで、レスポンスヘッダーの働きやレスポンスヘッダーが違えば挙動も変わることを実感できたので良かったと思います。\u003cbr\u003e\u003cbr\u003eまたLaravelの\u0026nbsp;\u003ccode\u003esteramDownload\u003c/code\u003eメソッドがレスポンスヘッダーをよしなに生成してくれていることに気付いたとき、フレームワークってすごい…と感動してしまいました！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://coinbaby8.com/php-csv-export.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【PHP】【Laravel】CSVエクスポートの方法〜5つのポイント〜\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://www.wakuwakubank.com/posts/799-it-content-type-content-disposition/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eContent-Type, Content-Dispositionの役割 - わくわくBank\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/koushisa/items/ac908d81361534264d35\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosでファイルダウンロード処理を実装(IEにも対応) - Qiita\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://jpdebug.com/p/978039\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eSpringboot+Vue+axios excelのエクスポートダウンロードを実現 - JPDEBUG.COM\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://javascript.keicode.com/newjs/download-files.php#1-1\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eファイルをダウンロード保存する方法 - JavaScript 入門\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://tkkm.tokyo/post-177/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【JavaScript】Axiosを使ってCSVをダウンロードしたい | ゆとって生きたい。【JavaScript】Axiosを使ってCSV...\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://helloworld-blog.tech/javascript/axios%E3%81%8B%E3%82%89csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eaxiosからCSVファイルをダウンロードさせる方法 | \u0026lt;HelloWorld/\u0026gt;\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"},{"id":"php","createdAt":"2022-01-07T13:16:36.618Z","updatedAt":"2022-02-12T02:31:46.498Z","publishedAt":"2022-01-07T13:16:36.618Z","revisedAt":"2022-01-07T13:16:36.618Z","tag":"PHP"},{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"},{"id":"javascript","createdAt":"2022-01-07T13:18:33.680Z","updatedAt":"2022-01-07T13:18:33.680Z","publishedAt":"2022-01-07T13:18:33.680Z","revisedAt":"2022-01-07T13:18:33.680Z","tag":"JavaScript"}],"image":"laravel"},{"id":"microcms-nextjs-blog","createdAt":"2022-02-17T12:46:35.174Z","updatedAt":"2022-03-02T23:51:43.327Z","publishedAt":"2022-02-26T23:51:43.000Z","revisedAt":"2022-03-02T23:51:43.327Z","title":"microCMS × Next.js（TypeScript）で個人ブログを作る","body":"\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003e\u003ccode\u003emicroCMS\u003c/code\u003e、\u003ccode\u003eNext.js（TypeScript）\u003c/code\u003eを使ってブログサイトを作成した手順と、追加で実装した機能について、またその過程で学んだことの備忘録記事です。\u003cbr\u003e\u003cbr\u003e基本的には公式のチュートリアル通りに進めていますが、TypeScriptの型付けや記事内のコードブロックのハイライトなど詰まった箇所もあったので、まとめておきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eデプロイURL\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ca href=\"https://microcms-blog-hinakonagao.vercel.app/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://microcms-blog-hinakonagao.vercel.app\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eGitHub\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ca href=\"https://github.com/hinakonagao/microcms_blog\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://github.com/hinakonagao/microcms_blog\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e※この記事ではページのスタイリングは解説しません。\u003cbr\u003eMaterialUIを主に使用してスタイリングを行っているので、詳しいコードはGitHubをご覧いただければと思います。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h48162eced8\"\u003e使用技術\u003c/h3\u003e\u003cul\u003e\u003cli\u003eNext.js　12.0.10\u003c/li\u003e\u003cli\u003eReact　17.0.2\u003c/li\u003e\u003cli\u003eTypeScript　4.5.5\u003c/li\u003e\u003cli\u003eESLint　8.8.0\u003c/li\u003e\u003cli\u003eprettier　2.5.1\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hc953739b3f\"\u003e全体の流れ\u003c/h2\u003e\u003cp\u003e１．microCMSの準備（アカウント作成・記事コンテンツのAPI作成）\u003cbr\u003e２．Next.jsのプロジェクト作成\u003cbr\u003e３．APIリクエストのための環境変数の設定\u003cbr\u003e４．公式のSDK「microcms-js-sdk」の導入\u003cbr\u003e５．記事一覧画面の作成\u003cbr\u003e６．記事詳細画面の作成\u003cbr\u003e７．コードブロックのシンタックスハイライトの実装\u003cbr\u003e８．【おまけ】タグでの絞り込み機能の実装\u003cbr\u003e９．【おまけ】ページネーション機能の実装\u003cbr\u003e\u003cbr\u003eというような流れで説明していきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hd1205c1797\"\u003e1. microCMSの準備\u003c/h2\u003e\u003cp\u003eまずはmicroCMSのアカウントを作成し、APIを作成します。\u003cbr\u003e\u003cbr\u003e手順は公式のチュートリアルに詳しく書かれているので、ここでの説明は割愛します。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://blog.microcms.io/microcms-next-jamstack-blog/#:%7E:text=%E3%81%8C%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%8C%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82-,2.%20microCMS%E3%81%AE%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B,-%E6%AC%A1%E3%81%AB%E3%80%81microCMS%E3%81%A7\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emicroCMS + Next.jsでJamstackブログを作ってみよう　2. microCMSの用意する\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e私は\u0026nbsp;\u003ccode\u003eblog\u003c/code\u003e\u0026nbsp;と\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;の2つのAPIエンドポイントを作成しました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hebabef9705\"\u003eblog\u003c/h3\u003e\u003cp\u003eブログコンテンツを登録しておくリスト形式の API です。\u003c/p\u003e\u003cul\u003e\u003cli\u003etitle：記事タイトル\u003c/li\u003e\u003cli\u003ebody：記事本文\u003c/li\u003e\u003cli\u003etags：タグ（別のエンドポイント\u0026nbsp;\u003ccode\u003e/tag\u003c/code\u003e\u0026nbsp;に登録したタグを複数参照できるように設定）\u003c/li\u003e\u003cli\u003eimage：表示する画像名（プロジェクトディレクトリに保存した画像の中から、ブラウザに表示する画像を指定するために使用）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/577556386f954864b763ec82bdea4d3c/blog.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h1d9b92c0c9\"\u003etag\u003c/h3\u003e\u003cp\u003eブログ記事に紐づけるタグを登録しておくリスト形式の API です。\u003cbr\u003e\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/24cd3d349eb74b35a9ee5ca8f901543a/tag.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hce660a84c7\"\u003e2. Next.jsプロジェクトを作成する\u003c/h2\u003e\u003cp\u003e下記のコマンドを実行してNext.jsのプロジェクトを作成し、続けて開発サーバーを立ち上げます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ yarn create next-app --typescript\n// プロジェクト名の入力を求められるので入力する\n\n$ cd ./microcms_blog/\n\n$ yarn dev\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e次に\u003ccode\u003esrc\u003c/code\u003eディレクトリを作成して、\u003ccode\u003epages\u003c/code\u003eディレクトリと\u003ccode\u003estyles\u003c/code\u003eディレクトリを\u003ccode\u003esrc\u003c/code\u003eディレクトリの配下に移動させます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ mkdir src \u0026amp;\u0026amp; mv pages src \u0026amp;\u0026amp; mv styles src\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eさらに、モジュールのインポートを絶対パスで指定できるよう、ベースURLを\u0026nbsp;\u003ccode\u003esrc\u003c/code\u003e\u0026nbsp;ディレクトリに設定します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// tsconfig.json\n{\n  \"compilerOptions\": {\n    // 追加\n    \"baseUrl\": \"src\"\n  }\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eベースURLの設定についてはこちらの記事を参考にさせていただきました。\u003cbr\u003e\u003ca href=\"https://fwywd.com/tech/next-base-url\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Next.js】特定のディレクトリを基準にし、絶対パスでモジュールをインポートする方法 | fwywd（フュード）powered by キ...\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"ha56333b74a\"\u003eESLint / Prettier\u003c/h2\u003e\u003cp\u003eNext.js のバージョン11 からは、デフォルトでESLintが搭載されています。\u003cbr\u003eESLintに関するインストール済のパッケージは以下の2つです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// package.json\n{\n  ...\n  \"devDependencies\": {\n    \"eslint\": \"8.8.0\",    // 構文解析のエンジン\n    \"eslint-config-next\": \"12.0.10\",    // ESLintのルール\n  }\n  ...\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eNext.js の新規プロジェクト作成時に生成された\u0026nbsp;\u003ccode\u003e.eslintrc\u003c/code\u003e\u0026nbsp;は ESLint の設定ファイルを意味しており、\u003cstrong\u003eデフォルトで\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eeslint-config-next\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;の設定が適用\u003c/strong\u003eされています。（ルールの詳細は後述）\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// .eslintrc.json\n\n{\n  \"extends\": \"next/core-web-vitals\",\n}\n\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e少しだけESLintの設定を加えます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// .eslintrc.json\n\n{\n  \"extends\": \"next/core-web-vitals\",\n  // 以下のルールを追記\n  \"rules\": {\n    \"react/display-name\": \"off\",\n    \"react-hooks/exhaustive-deps\": \"off\",\n    \"@next/next/no-sync-scripts\": \"off\"\n  }\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003ePrettier は含まれていないため、インストールしておきます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ yarn -DE add prettier eslint-config-prettier\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h5095390624\"\u003e\u003cbr\u003e3. 環境変数の設定\u003c/h2\u003e\u003cp\u003emicroCMSのAPIへアクセスする際は、サービスドメインを指定し、リクエストにそのサービスドメインのAPIキーを含める事でデータを取得することができます。\u003cbr\u003e\u003cbr\u003e※microCMSでのAPIキーの作成方法は公式ページを参照ください。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://document.microcms.io/content-api/x-microcms-api-key\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAPIキー（X-MICROCMS-API-KEY）\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eまずは環境変数を管理するファイルを作成します。\u003cbr\u003e※\u0026nbsp;\u003ccode\u003e.local\u003c/code\u003eをつけるとローカル環境で使うことができ、\u0026nbsp;\u003ccode\u003e.development\u003c/code\u003eをつけると開発環境で使えます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ touch .env.development.local\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003e.env.development.local\u003c/code\u003eファイルを作成したら、\u003ccode\u003eサービスドメイン\u003c/code\u003eとmicroCMSの\u003ccode\u003eAPIキー\u003c/code\u003eを書き込みます。\u003cbr\u003e※サービスドメインは、例えば自分のmicroCMSページのURLが\u0026nbsp;\u003ccode\u003ehttps://aiueo.microcms.io/\u003c/code\u003e\u0026nbsp;であれば\u0026nbsp;\u003ccode\u003eaiueo\u003c/code\u003e\u0026nbsp;の部分になります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eSERVICE_DOMAIN=xxxxxxxxxxx\nAPI_KEY=xxxxxxxxxxxx\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003eenv\u003c/code\u003e\u0026nbsp;ファイルに書いた値は、以下のようにしてプロジェクト内で参照することができます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eprocess.env.API_KEY\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h84f24c70f8\"\u003e\u003cbr\u003e4.microcms-js-sdkの準備\u003c/h2\u003e\u003cp\u003eAPIリクエストには公式が提供している\u003ccode\u003emicrocms-js-sdk\u003c/code\u003eを使います。\u003cbr\u003e\u003cbr\u003eまずは\u003ccode\u003emicrocms-js-sdk\u003c/code\u003eをインストールします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ yarn add microcms-js-sdk\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003elibs/client.ts\u003c/code\u003e\u0026nbsp;を作成してSDKの初期化を行います。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ mkdir src/libs\n$ touch ./src/libs/client.ts\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003eserviceDomain\u003c/code\u003e\u0026nbsp;と\u0026nbsp;\u003ccode\u003eapiKey\u003c/code\u003e\u0026nbsp;の値は\u0026nbsp;\u003ccode\u003eenv\u003c/code\u003e\u0026nbsp;ファイルを参照します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// libs/client.ts\n\nimport { createClient } from \"microcms-js-sdk\";\n\nexport const client = createClient({\n  serviceDomain: process.env.SERVICE_DOMAIN || \"\",\n  apiKey: process.env.API_KEY || \"\",\n});\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e※\u003ccode\u003eserviceDomain\u003c/code\u003e\u0026nbsp;と\u0026nbsp;\u003ccode\u003eapiKey\u003c/code\u003e\u0026nbsp;は\u0026nbsp;\u003ccode\u003estring\u003c/code\u003e型、.envファイルから参照する環境変数は\u0026nbsp;\u003ccode\u003estring | undefined\u003c/code\u003e型なので、もし以下のように\u0026nbsp;\u003ccode\u003e|| \"\"\u003c/code\u003e\u0026nbsp;の部分を書かないとエラーが出ます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eserviceDomain: process.env.SERVICE_DOMAIN\n// 型 'string | undefined' を型 'string' に割り当てることはできません。型 'undefined' を型 'string' に割り当てることはできません。\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"h4e79de37a7\"\u003e\u003cbr\u003e5. microCMSから記事データを取得する（一覧画面）\u003c/h2\u003e\u003ch3 id=\"hde4a1d43ba\"\u003e型の事前準備\u003c/h3\u003e\u003cp\u003emicroCMSから取得するブログ記事とタグのデータ型を定義しておきます。\u003cbr\u003e\u003cbr\u003e型定義ファイルを別途作成します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ mkdir src/types\n$ touch ./src/types/blog.ts\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e作成したファイルに型を定義します。\u003cbr\u003e今回私が作成したAPIだと以下の通りになります。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// src/types/blog.ts\n\nexport type Blog = {\n  id: string;\n  body: string;\n  title: string;\n  tags: Tag[];\n  image: string;\n  createdAt: string;\n  updatedAt: string;\n  publishedAt: string;\n  revisedAt: string;\n};\n\nexport type Tag = {\n  id: string;\n  tag: string;\n  createdAt: string;\n  updatedAt: string;\n  publishedAt: string;\n  revisedAt: string;\n};\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"hbc42ef09fb\"\u003e\u003cbr\u003eAPIリクエストを行う\u003c/h3\u003e\u003cp\u003e\u003ccode\u003egetStaticProps\u003c/code\u003eを使ってmicroCMSのAPIを叩き、データを取得します。\u003cbr\u003e\u003ccode\u003epages/index.tsx\u003c/code\u003e\u0026nbsp;に以下のように書きます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// pages/index.js\n\n\nimport Link from \"next/link\";\nimport type { InferGetStaticPropsType, NextPage } from \"next\";\nimport { client } from \"libs/client\";    // srcから見た絶対パスで指定\nimport type { Blog, Tag } from \"types/blog\";    // srcから見た絶対パスで指定\n\n// microCMSへAPIリクエスト\nexport const getStaticProps = async () =\u0026gt; {\n  const blog = await client.get({ endpoint: \"blog\" });\n  const tag = await client.get({ endpoint: \"tag\" });\n\n  return {\n    props: {\n      blogs: blog.contents,\n      tags: tag.contents,\n    },\n  };\n};\n\n// Props（blogsとtags）の型\ntype Props = {\n  blogs: Blog[];\n  tags: Tag[];\n};\n\nconst Home: NextPage\u0026lt;InferGetStaticPropsType\u0026lt;typeof getStaticProps\u0026gt;\u0026gt; = ({\n  blogs,\n  tags,\n}: Props) =\u0026gt; {\n  console.log(blogs);\n  console.log(tags);\n　// ... 以下省略\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eここで\u0026nbsp;\u003ccode\u003ehttp://localhost:3000\u003c/code\u003e\u0026nbsp;にアクセスすると、コンソールにAPIから取得したデータが表示されるはずです。\u003cbr\u003e\u003cbr\u003e私の作成したAPIだと、以下の画像のようなデータが取れています。\u003c/p\u003e\u003ch3 id=\"hf4a22cee96\"\u003eblogs\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/21ce7cb8666749859e4e9a8a1a57939a/blogs.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h0502f3a90c\"\u003etags\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/3634ac49f1c749069024d8d2e57474f1/tags.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003eではこのデータを画面に表示します。\u003cbr\u003e\u003cbr\u003e※ディレクトリ構成は以下のようにします。\u003c/p\u003e\u003cul\u003e\u003cli\u003epages/index.js\u0026nbsp;→ 記事一覧画面\u003c/li\u003e\u003cli\u003epages/blog/[id].ts → 記事詳細画面\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e一覧画面に記事タイトルをリスト形式で表示し、記事詳細画面へのリンクをつけます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// pages/index.tsx\n\nconst Home: NextPage\u0026lt;InferGetStaticPropsType\u0026lt;typeof getStaticProps\u0026gt;\u0026gt; = ({\n  blogs,\n  tags,\n}: Props) =\u0026gt; {\n  return (\n    \u0026lt;div\u0026gt;\n      \u0026lt;ul\u0026gt;\n        {blogs.map((blog) =\u0026gt; (\n          \u0026lt;li key={blog.id}\u0026gt;\n            \u0026lt;Link href={`/blog/${blog.id}`}\u0026gt;\n              \u0026lt;a\u0026gt;{blog.title}\u0026lt;/a\u0026gt;\n            \u0026lt;/Link\u0026gt;\n          \u0026lt;/li\u0026gt;\n        ))}\n      \u0026lt;/ul\u0026gt;\n    \u0026lt;/div\u0026gt;\n  )\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこれで\u0026nbsp;\u003ccode\u003ehttp://localhost:3000\u003c/code\u003e\u0026nbsp;にアクセスすると記事タイトル一覧が表示され、タイトルをクリックすると\u0026nbsp;\u003ccode\u003ehttp://localhost:3000/blog/[microCMSで設定したコンテンツID]\u003c/code\u003e\u0026nbsp;のURLへ遷移するはずです。\u003cbr\u003e\u003cbr\u003e次にこの遷移先のページを作ります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h85b588f038\"\u003e6. 記事詳細画面を作成する\u003c/h2\u003e\u003cp\u003e一覧画面でブログ記事の詳細画面を作っていきます。\u003cbr\u003e\u003cbr\u003e上記のリンク先に指定した通り、\u0026nbsp;\u003ccode\u003epages/blog/[id].ts\u003c/code\u003eに詳細画面を作ります。\u003cbr\u003eまずはファイルを作成します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ mkdir src/pages/blog\n$ touch ./src/pages/blog/[id].tsx\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e作成したファイルを、以下のように編集します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// pages/blog/[id].tsx\n\nimport {\n  GetStaticPaths,\n  GetStaticProps,\n  InferGetStaticPropsType,\n  NextPage,\n} from \"next\";\nimport { client } from \"libs/client\";\nimport type { Blog } from \"types/blog\";\n\n// APIリクエストを行うパスを指定\nexport const getStaticPaths: GetStaticPaths\u0026lt;Params\u0026gt; = async () =\u0026gt; {\n  const data = await client.get({ endpoint: \"blog\" });\n\n  const paths = data.contents.map((content) =\u0026gt; `/blog/${content.id}`);\n  return { paths, fallback: false };\n};\n\n// microCMSへAPIリクエスト\nexport const getStaticProps: GetStaticProps\u0026lt;Props, Params\u0026gt; = async (\n  const id = context.params?.id;\n  const data = await client.get({ endpoint: \"blog\", contentId: id });\n\n  return {\n    props: {\n      blog: data,\n    },\n  };\n};\n\n// // Props（blog）の型\ntype Props = {\n  blog: Blog;\n};\n\nconst BlogId: NextPage\u0026lt;InferGetStaticPropsType\u0026lt;typeof getStaticProps\u0026gt;\u0026gt; = ({\n  blog,\n}: Props) =\u0026gt; {\n  return (\n    \u0026lt;main\u0026gt;\n      \u0026lt;h1\u0026gt;{blog.title}\u0026lt;/h1\u0026gt;\n      \u0026lt;p\u0026gt;{blog.publishedAt}\u0026lt;/p\u0026gt;\n            {blog.tags.map((tag) =\u0026gt; (\n        \u0026lt;li key={tag.id}\u0026gt;\n          #{tag.tag}\n        \u0026lt;/li\u0026gt;\n      ))}\n      \u0026lt;div\n        dangerouslySetInnerHTML={{\n          __html: `${blog.body}`,\n        }}\n      /\u0026gt;\n    \u0026lt;/main\u0026gt;\n  );\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h8a50fc5ec1\"\u003e\u003cbr\u003eポイント解説\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003efallback: false\u003c/code\u003e\u0026nbsp;の設定\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003egetStaticPaths\u003c/code\u003e\u0026nbsp;で\u0026nbsp;\u003ccode\u003ereturn { fallback: false };\u003c/code\u003e\u0026nbsp;と書いています。\u003cbr\u003e\u003cbr\u003eこれにより、\u0026nbsp;\u003ccode\u003ehttp://localhost:3000/blog/[存在しないコンテンツID]\u003c/code\u003e\u0026nbsp;のURLにアクセスすると404ページへ遷移するようになります。\u003cbr\u003e※\u0026nbsp;\u003ccode\u003efallback: true\u003c/code\u003e\u0026nbsp;にして存在しないURLにアクセスした場合はエラー画面が出てしまいます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003edangerouslySetInnerHTML\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e以下の通り、記事本文は\u0026nbsp;\u003ccode\u003edangerouslySetInnerHTML\u003c/code\u003e\u0026nbsp;を通して表示しています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;div\n  dangerouslySetInnerHTML={{\n    __html: `${blog.body}`,\n  }}\n/\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eAPIから返される記事本文は文字列形式（HTMLタグも文字列として取得される）なので、これをHTMLとして描画するために\u003ccode\u003edangerouslySetInnerHTML\u003c/code\u003e\u0026nbsp;を使っています。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h7941af99cd\"\u003e7. コードブロックのハイライトを行う\u003c/h2\u003e\u003cp\u003emicroCMSのリッチエディタでソースコードとして記述した部分は、\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;pre\u0026gt;\n  \u0026lt;code\u0026gt;\n    // コード\n  \u0026lt;/code\u0026gt;\n\u0026lt;/pre\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eという形式で取得されます。\u003cbr\u003e\u003cbr\u003eこのままdangerouslySetInnerHTMLを通すだけでは、何もハイライトされていないコードが表示されるので、ライブラリを使って装飾していきます。\u003cbr\u003e\u003cbr\u003emicroCMSの公式で紹介されている、\u003ca style=\"color:#4aac00\" href=\"https://www.npmjs.com/package/cheerio\" target=\"_blank\" rel=\"noopener noreferrer\"\u003echeerio\u003c/a\u003eと\u003ca style=\"color:#4aac00\" href=\"https://www.npmjs.com/package/highlight.js\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehighlight.js\u003c/a\u003eというライブラリを使ってサーバーサイドでハイライトを行いました。\u003cbr\u003e\u003ca href=\"https://blog.microcms.io/syntax-highlighting-on-server-side/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eサーバサイドでシンタックスハイライトを行う\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eまずはライブラリをインストールします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ yarn add highlight.js cheerio\n$ yarn add --dev @types/highlightjs @types/cheerio\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e次にブログ記事を生成する際の\u0026nbsp;\u003ccode\u003egetStaticProps\u003c/code\u003e\u0026nbsp;内の記述を修正します。\u003cbr\u003e※ライブラリについての説明は上記のmicroCMSの記事などを参照ください。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// pages/blog/[id].tsx\n\n// importを追記\nimport cheerio from \"cheerio\";\nimport hljs from \"highlight.js\";\nimport \"highlight.js/styles/hybrid.css\";\n\n// 中略\n\nexport const getStaticProps: GetStaticProps\u0026lt;Props, Params\u0026gt; = async (\n  context\n) =\u0026gt; {\n  const id = context.params?.id;\n  const blog = await client.get({ endpoint: \"blog\", contentId: id });\n  // 以下の部分を追記\n  const $ = cheerio.load(blog.body);\n  $(\"pre code\").each((_, elm) =\u0026gt; {\n    const result = hljs.highlightAuto($(elm).text());\n    $(elm).html(result.value);\n    $(elm).addClass(\"hljs\");\n  });\n\n  return {\n    props: {\n      blog,\n      highlightedBody: $.html(),\n    },\n  };\n};\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれでサーバーサード側でシンタックスハイライト済の記事データを取得することができます。\u003cbr\u003e\u003cbr\u003e※実装においては以下の記事も参考にさせていただきました。\u003cbr\u003e\u003ca href=\"https://www.blogchin.net/blogs/p9f3s1x5k5yb/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eNext.JS+microCMSで作成したブログに、ソースコードのシンタックスハイライトをつけてみる\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/cawauchi/items/ff6489b17800c5676908\" target=\"_blank\" rel=\"noopener noreferrer\"\u003enext.js+microcmsでシンタックスハイライトの導入 - Qiita\u003c/a\u003e\u003c/p\u003e\u003ch2 id=\"h5a51a8e35e\"\u003e\u003cbr\u003e8. 【おまけ】タグでの絞り込み機能\u003c/h2\u003e\u003cp\u003e先述の通り、今回は\u0026nbsp;\u003ccode\u003eblog\u003c/code\u003e\u0026nbsp;と\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;の2つのAPIを作成し、ブログ記事は複数の\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;を持てるようにしました。\u003cbr\u003e\u003cbr\u003eそして\u003c/p\u003e\u003cul\u003e\u003cli\u003e記事一覧画面で各記事が持つタグを表示\u003c/li\u003e\u003cli\u003eAPIから取得した\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;の一覧をサイドバーに表示（タグを選んで記事を絞り込む）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eを出来るようにしました。\u003cbr\u003e\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/0ef6284906254e6580e558fae4082554/tag_serch.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h3ab24f6f50\"\u003eメリット\u003c/h3\u003e\u003cp\u003e\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;のAPIエンドポイントを別途作成する構成にしたことで、以下のようなメリットがあります。\u003c/p\u003e\u003cul\u003e\u003cli\u003eサイドバーに設置した\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;一覧の表示順の並べ替えや修正を、コードをいじらずmicroCMSの管理画面で行える。\u003c/li\u003e\u003cli\u003e\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;名を修正したい時に、記事のタグを一つひとつ修正しなくともAPIの\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;を修正すれば一括して変更できる。\u003c/li\u003e\u003c/ul\u003e\u003ch3 id=\"h50d6571ee1\"\u003e\u003cbr\u003e実装方法（記事一覧の表示について）\u003c/h3\u003e\u003cp\u003eまずは、\u0026nbsp;\u003ccode\u003egetStaticProps\u003c/code\u003e\u0026nbsp;から受け取った記事をそのまま全て表示するのではなく、画面に表示する記事だけを格納する\u0026nbsp;\u003ccode\u003estate\u003c/code\u003e\u0026nbsp;を別途作成します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst [showBlogs, setShowBlogs] = useState(blogs)\n// 初期値にgetStaticPropsから受け取ったブログ記事データを入れる\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eそして画面には\u0026nbsp;\u003ccode\u003eshowBlogs\u003c/code\u003e\u0026nbsp;の中身を\u0026nbsp;\u003ccode\u003emap\u003c/code\u003e\u0026nbsp;で回して一覧表示します。\u003cbr\u003e※絞り込みによって\u0026nbsp;\u003ccode\u003eshowBlogs\u003c/code\u003e\u0026nbsp;に記事が入っていなかった場合のための条件付きレンダリングも記述しておきます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e{!showBlogs.length \u0026amp;\u0026amp; \u0026lt;p\u0026gt;There are no posts...\u0026lt;/p\u0026gt;}\n{showBlogs.map((blog) =\u0026gt; (\n    // 記事を表示\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e※注\u003c/strong\u003e\u003cbr\u003e\u003cstrong\u003eこのブログサイトはMaterialUIを使ってスタイリングを行っており、ここからは実際の実装通り、通常のHTMLタグではなくMaterialUIのタグで表記させていただきます。\u003c/strong\u003e\u003cbr\u003e\u003cstrong\u003e（MaterialUIのタグ名を見ればどんな役割の要素なのか想像がつくと思うので、MaterialUIに触れたことが無い方も何となく読み取っていただけるかなと思います。）\u003c/strong\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e記事の一覧表示の中で、この記事が持つ\u0026nbsp;\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;も\u0026nbsp;\u003ccode\u003emap\u003c/code\u003e\u0026nbsp;で回して表示します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e{showBlogs.map((blog) =\u0026gt; (\n\n    // 中略\n\n    // 持っているtagを全て表示\n    {blog.tags.map((tag) =\u0026gt; (\n      \u0026lt;Typography key={tag.id}\u0026gt;\n        #{tag.tag}\n      \u0026lt;/Typography\u0026gt;\n    ))}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h79fb2c15aa\"\u003e\u003cbr\u003e実装方法（タグによる絞り込みについて）\u003c/h3\u003e\u003cp\u003e\u003ccode\u003etag\u003c/code\u003e\u0026nbsp;のAPIエンドポイントから受け取るデータは、以下の\u003ccode\u003etag\u003c/code\u003e型の配列でした。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eexport type Tag = {\n  id: string;\n  tag: string;\n  createdAt: string;\n  updatedAt: string;\n  publishedAt: string;\n  revisedAt: string;\n};\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eなのでまずはこのデータから、tag名だけを抜き出して配列に格納します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// getStaticPropsで取得したtagsからtag名のみ抜き出す\nconst tagList = tags.map((tag) =\u0026gt; tag.tag);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e作成した\u0026nbsp;\u003ccode\u003etagList\u003c/code\u003e\u0026nbsp;を使って、サイドバーにタグ一覧を表示します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;List\u0026gt;\n  \u0026lt;Typography\u0026gt;\n    # Tags\n  \u0026lt;/Typography\u0026gt;\n\n  \u0026lt;ListItemButton onClick={() =\u0026gt; selectTag(\"all\")}\u0026gt;\n    \u0026lt;ListItemText primary=\"All\"/\u0026gt;   // primaryに指定した文字列が表示される\n  \u0026lt;/ListItemButton\u0026gt;\n\n  {tagList.map((tag) =\u0026gt; (\n    \u0026lt;ListItemButton key={tag} onClick={() =\u0026gt; selectTag(tag)}\u0026gt;\n      \u0026lt;ListItemText primary={tag}/\u0026gt;   // primaryに指定した文字列が表示される\n    \u0026lt;/ListItemButton\u0026gt;\n  ))}\n\u0026lt;/List\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003eonClick\u003c/code\u003e\u0026nbsp;に指定した\u0026nbsp;\u003ccode\u003eselectTag()\u003c/code\u003e\u0026nbsp;メソッドを実装します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// タグ絞り込み\nconst selectTag = (tag: string) =\u0026gt; {\n  if (tag === \"all\") {\n    setShowBlogs(blogs);\n  } else {\n    const selectedBlogs = blogs.filter((blog) =\u0026gt; {\n      const haveTags = blog.tags.map((tag) =\u0026gt; tag.tag);\n      return haveTags.includes(tag);\n    });\n    setShowBlogs(selectedBlogs);\n  }\n\n  // 画面最上部へスクロールさせる\n  window.scrollTo({\n    top: 0,\n    behavior: \"smooth\",\n  });\n};\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e検索のロジックについては以前別の記事に書いたので、詳しくはこちらをご覧ください。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://qiita.com/hinako_n/items/a0745afe0631578c698e\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eReactでリアルタイムの検索機能を実装する - Qiita\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e以上で「All」を選べば全記事が表示され、タグを選べばそのタグを持つ記事のみが表示されるようになりました。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h88cdec125d\"\u003e 9.【おまけ】ページネーション機能の実装\u003c/h2\u003e\u003cp\u003e\u003ccode\u003ereact-paginate\u003c/code\u003eというライブラリを使って、ページネーション機能を実装しました。  \u003cbr\u003eライブラリ： \u003ca href=\"https://www.npmjs.com/package/react-paginate \" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://www.npmjs.com/package/react-paginate \u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/9a2cb163f00a4910b6ebf063d87811ab/%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3.jpg\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003eライブラリについての詳しい説明では割愛し、ここでは実装したコードだけ載せさせていただきます。\u003cbr\u003e使い方は以下の記事を参考にさせていただきました。\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://de-milestones.com/react_pagination/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://de-milestones.com/react_pagination/\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://tech.stmn.co.jp/entry/2020/10/28/141406\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://tech.stmn.co.jp/entry/2020/10/28/141406\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2661198b93\"\u003e実装手順\u003c/h3\u003e\u003cp\u003eまずはライブラリをインストールします。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ yarn add react-paginate\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e記事一覧画面を編集していきます。\u003cbr\u003e\u003cbr\u003eページネーションの制御に使う \u003ccode\u003estate\u003c/code\u003eと、ページネーションをクリックした時に実行するメソッドを定義します。  \u003cbr\u003e\u003cbr\u003epages/index.tsx\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eimport ReactPaginate from \"react-paginate\";\n\n\n// 中略\n\n\u0026nbsp;const [offset, setOffset] = useState(0);\u0026nbsp;\u0026nbsp;// 何番目の記事から表示するか\n\u0026nbsp;const perPage = 6;\u0026nbsp;\u0026nbsp;// 1ページあたりに表示する記事数\n\n\u0026nbsp;const handlePageChange = (data: { selected: number }) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// クリックしたページ数を{selected: 1}のようなオブジェクト形式で引数に受ける\n\u0026nbsp;\u0026nbsp;setOffset(data.selected * perPage)\u0026nbsp;\u0026nbsp;// 表示する記事の開始位置を変更\n\n\u0026nbsp;\u0026nbsp;// ページ最上部へスクロールする\n\u0026nbsp;\u0026nbsp;window.scrollTo({\u0026nbsp;\u0026nbsp;\u0026nbsp;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;top: 0,\n\u0026nbsp;\u0026nbsp;\u0026nbsp;behavior: \"smooth\",\n\u0026nbsp;\u0026nbsp;});\n\u0026nbsp;};\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e記事の一覧表示の箇所を修正します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// 表示する記事をsliceで抽出して一覧表示\n{showBlogs.slice(offset, offset + perPage).map((blog) =\u0026gt; (\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003cbr\u003eページネーションコンポーネントを記事一覧の下に設置します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// ページネーションコンポーネント\n\u0026lt;ReactPaginate\n\u0026nbsp;\u0026nbsp;previousLabel={\"\u0026lt;\"}\u0026nbsp;// 前のページボタン\n\u0026nbsp;\u0026nbsp;nextLabel={\"\u0026gt;\"}\u0026nbsp;\u0026nbsp;// 次のページボタン\n\u0026nbsp;\u0026nbsp;pageCount={Math.ceil(blogs.length / perPage)}\u0026nbsp;\u0026nbsp;// ページ総数\n\u0026nbsp;\u0026nbsp;onPageChange={handlePageChange}\u0026nbsp;\u0026nbsp;// クリック時のfunction\n\u0026nbsp;\u0026nbsp;containerClassName={\"pagination\"}\u0026nbsp;\u0026nbsp;// ページネーションであるulに付くクラス名\n\u0026nbsp;\u0026nbsp;activeClassName={\"active\"}\u0026nbsp;\u0026nbsp;// アクティブなページのliに着くクラス名\n/\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eスタイルを付けます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e.pagination {\n\u0026nbsp;display: flex;\n\u0026nbsp;align-items: center;\n\u0026nbsp;justify-content: center;\n\u0026nbsp;margin: 0 auto;\n\u0026nbsp;padding: 40px 0;\n}\n\n.pagination li {\n\u0026nbsp;margin: 0 16px;\n}\n\n.pagination li \u0026gt; a {\n\u0026nbsp;position: relative;\n\u0026nbsp;font-size: 16px;\n\u0026nbsp;width: 24px;\n\u0026nbsp;height: 24px;\n\u0026nbsp;outline: none;\n\u0026nbsp;z-index: 100;\n\u0026nbsp;cursor: pointer;\n}\n\n.pagination a::before {\n\u0026nbsp;content: \"\";\n\u0026nbsp;display: block;\n\u0026nbsp;position: absolute;\n\u0026nbsp;top: 50%;\n\u0026nbsp;left: 50%;\n\u0026nbsp;width: 32px;\n\u0026nbsp;height: 32px;\n\u0026nbsp;border-radius: 50%;\n\u0026nbsp;transform: translate(-50%, -50%);\n\u0026nbsp;z-index: -100;\n}\n\n.pagination li.active \u0026gt; a::before {\n\u0026nbsp;background-color: #929191;\n}\n\n.pagination li.active \u0026gt; a {\n\u0026nbsp;color: #f2f2f2;\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e以上でページネーションを実装できました。\u003cbr\u003e\u003cbr\u003e予めフロント側で全件保持している記事データに対して表示を変えているだけなので、もちろんリロードもなく瞬時に切り替わります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h9b4c4b9dd7\"\u003e 最後に\u003c/h2\u003e\u003cp\u003emicroCMSは公式のチュートリアルやブログが豊富で分かりやすく、機能もどんどん拡張されており（最初は公式SDKも無かったらしい）、長く使っていくにも安心だなと思いました。\u003cbr\u003e\u003cbr\u003eこのブログは最低限の機能を作ってデプロイしたのでまだまだ未完成ですが、これから機能拡大・スタイル修正していきたいなと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3bcda3e6b0\"\u003e最後に\u003c/h2\u003e\u003cp\u003emicroCMSは公式のチュートリアルやブログが豊富で分かりやすく、機能もどんどん拡張されており（最初は公式SDKも無かったらしい）、長く使っていくにも安心だなと思いました。\u003cbr\u003e\u003cbr\u003eこのブログは最低限の機能を作ってデプロイしたのでまだまだ未完成ですが、これから機能拡大・スタイル修正していきたいなと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://zenn.dev/elletech/articles/nextjs_microcms\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eNext.js(TypeScript)、TailwindCSS、microCMSでブログを作成しよう！\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://blog.microcms.io/microcms-next-jamstack-blog/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emicroCMS + Next.jsでJamstackブログを作ってみよう\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://fwywd.com/tech/next-eslint-prettier\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eNext.js (TypeScript) に ESLint と Prettier を導入し、コードを綺麗に保とう | fwywd（フュード）...\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"microcms","createdAt":"2022-02-17T12:48:01.991Z","updatedAt":"2022-02-17T12:48:13.704Z","publishedAt":"2022-02-17T12:48:01.991Z","revisedAt":"2022-02-17T12:48:01.991Z","tag":"microCMS"},{"id":"typescript","createdAt":"2022-01-07T13:18:58.358Z","updatedAt":"2022-02-17T03:22:47.524Z","publishedAt":"2022-01-07T13:18:58.358Z","revisedAt":"2022-02-17T03:22:47.524Z","tag":"TypeScript"}],"image":"blog"},{"id":"laravel-softdelete","createdAt":"2022-03-02T23:54:39.267Z","updatedAt":"2022-03-02T23:55:00.491Z","publishedAt":"2022-02-23T23:54:39.000Z","revisedAt":"2022-03-02T23:54:39.267Z","title":"【Laravel】論理削除（softDelete）するときにリレーション先のデータも削除する方法","body":"\u003ch2 id=\"h9707d3a59a\"\u003e概要\u003c/h2\u003e\u003cp\u003eLaravelでは、マイグレーションファイルに外部キー制約の設定を記述しておくと、親テーブルのデータを削除したときに子テーブルのデータも同時に削除することができます。\u003cbr\u003e\u003cbr\u003e但しこれは、DBから実際にデータを削除する「\u003cstrong\u003e物理削除\u003c/strong\u003e」の場合の話です。\u003cbr\u003eDBからレコードを削除するわけではなく削除フラグを立てて削除したとみなす「\u003cstrong\u003e論理削除\u003c/strong\u003e」の場合は、マイグレーションファイルへの記述だけではリレーション先のデータを一緒に削除してくれません。\u003cbr\u003eこのような場合に、\u0026nbsp;\u003cstrong\u003eモデルの\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eboot\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド（もしくは\u0026nbsp;\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003ebooted\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e\u0026nbsp;メソッド）を使って初期設定を行えば\u003c/strong\u003e、あるテーブルのデータを論理削除したときにリレーション先のテーブルのデータも削除することができます。\u003cbr\u003e業務でこの方法を使う機会があったので、 モデル\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドについて勉強したこととあわせて、備忘録を書いておきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hafc8e872cc\"\u003e論理削除（softDelete）の設定方法\u003c/h2\u003e\u003cp\u003eまず事前準備としてソフトデリートの設定をします。\u003cbr\u003e\u003cbr\u003eソフトデリート機能を組み込む手順は以下の2つです。\u003cbr\u003e\u003cbr\u003e1.　マイグレーションファイルにソフトデリートの設定を記述する\u003cbr\u003e2.　EloquentモデルにSoftDeletesトレイトを組み込む\u003cbr\u003e\u003cbr\u003e例として\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルにソフトデリート機能を設定してみます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hb5391332f6\"\u003e1. マイグレーションファイルにソフトデリートの設定を記述する\u003c/h3\u003e\u003cp\u003eLaravelの論理削除ではテーブルの\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムに値が入っている場合はデータは削除されたとみなすので、\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加する必要があります。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003edeleted_at\u003c/code\u003eカラムを追加するため、マイグレーションファイルに以下の1行を追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003epublicfunction up()\n{\n    Schema::table('user',function (Blueprint $table) {\n        $table-\u0026gt;softDeletes();    // 追記\n    });\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれでマイグレーションを実行すると、DBのテーブルに\u0026nbsp;\u003ccode\u003edeleted_at\u003c/code\u003eカラムが作成されていることが確認できます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h4383fed8c3\"\u003e2. EloquentモデルにSoftDeletesトレイトを組み込む\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser\u003c/code\u003e\u0026nbsp;モデルファイルに以下のように追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003euse Illuminate\\Database\\Eloquent\\SoftDeletes;    // 追記\n\nclass User extends Model\n{\n    use SoftDeletes;    // 追記\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこの記述により、deleteメソッドでモデルを削除した際はソフトデリートが実行されるようになります。\u003cbr\u003e\u003cbr\u003eLaravelでソフトデリートを行うための設定は以上です。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h10178e1c1c\"\u003eモデルのbootedメソッドとは\u003c/h2\u003e\u003cp\u003e本題の「ソフトデリートするときにリレーション先のデータも削除する」ための実装にあたり、先に今回使用する\u0026nbsp;\u003ccode\u003eboooted\u003c/code\u003e\u0026nbsp;メソッドについて少し勉強しておきます。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eLaravel\u003c/code\u003e\u0026nbsp;のモデルでは、初期起動時に\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドを走らせて初期設定をしています。\u003cbr\u003e\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドはモデルの初期起動後に実行されるメソッドで、モデルに対して行いたい初期設定は\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに書くよう\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;にも説明があります。\u003c/p\u003e\u003ch3 id=\"he23cb179bf\"\u003e【補足】bootedメソッドとbootメソッドについて\u003c/h3\u003e\u003cp\u003e今回実装方法をググっていると\u003ccode\u003eboot\u003c/code\u003eメソッドを使っている記事が見つかり、自分としても初期起動時のメソッドといえば\u003ccode\u003eboot\u003c/code\u003eメソッドのイメージがあったので、\u003ccode\u003ebooted\u003c/code\u003eメソッドと\u003ccode\u003eboot\u003c/code\u003eメソッドについて少し調べてみました。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明では、モデルの初期設定を行う方法としてLaravel6までは\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドが使われていますが、Laravel7以降では\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドが使われていました。\u003cbr\u003e・Laravel8の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%97%E3%81%AA%E3%81%84%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82-,%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E4%BD%BF%E7%94%A8,-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%AF%E3%83%A9%E3%82%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e・Laravel6の該当箇所\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/6.x/ja/eloquent.html#:~:text=%E9%98%B2%E3%81%92%E3%81%BE%E3%81%99%E3%80%82-,%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AE%E9%81%A9%E7%94%A8,-%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquent：利用の開始 6.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e試しにモデルファイルに以下のように書き、\u0026nbsp;\u003ccode\u003ebooted()\u003c/code\u003e\u0026nbsp;のところにマウスをホバーさせてVSCodeのヒントを表示してみます。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// モデルファイルに記述\n/**\n * @return void\n */\npublic static function booted(): void\n{\n    //\n}\n\n// booted() にマウスをホバーさせると、以下の説明が表示される\nIlluminate\\Database\\Eloquent\\Model::booted\n\nPerform any actions required after the model boots.\n\n\u0026lt;?php\nprotected static function booted() { }\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003ebooted\u003c/code\u003eメソッドについては、\u0026nbsp;\u003ccode\u003ePerform any actions required after the model boots.\u003c/code\u003e\u0026nbsp;と説明されています。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003eboot()\u003c/code\u003e\u0026nbsp;を書いた場合も確認します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// モデルファイルに記述\n/**\n * @return void\n */\npublic static function boot(): void\n{\n    //\n}\n\n// boot() にマウスをホバーさせると、以下の説明が出る\nIlluminate\\Database\\Eloquent\\Model::boot\n\nBootstrap the model and its traits.\n\n\u0026lt;?php\nprotected static function boot() { }\n@return void\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドは\u0026nbsp;\u003ccode\u003eBootstrap the model and its traits.\u003c/code\u003e\u0026nbsp;と説明がありました。\u003cbr\u003e\u003cbr\u003e※実際のLaravelのソースコードだと、以下のファイルに\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドもありました。　\u003cbr\u003e興味のある方はこちらもご覧ください。\u003cbr\u003e\u003ca href=\"https://github.com/laravel/framework/blob/9.x/src/Illuminate/Database/Eloquent/Model.php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eframework/Model.php at 9.x · laravel/framework\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eメソッド名の通りですが、\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドはモデルの初期起動後に実行されているということですね。\u003cbr\u003e私は業務ではLaravel8を使っており、\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドでも\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドでも同じように設定を行うことは出来ましたが、現在の\u0026nbsp;\u003ccode\u003ereadouble\u003c/code\u003e\u0026nbsp;の説明に従って\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを使っていきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"haaaceead0a\"\u003eModelのbootedメソッドにクロージャを書く\u003c/h2\u003e\u003cp\u003e前置きが長くなりましたが、実際にモデルの\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドに「データを論理削除したらリレーション先のデータも削除する」設定を記述します。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8a175a9b0e\"\u003e前提\u003c/h3\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブル（親）と\u003cstrong\u003e1対多\u003c/strong\u003eで紐づく\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルがあるとします。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルからレコードを論理削除したら、 リレーション先の\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからもレコードを論理削除するように設定します。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hf031c5e696\"\u003e実装方法\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eUser.php\u003c/code\u003eにリレーションと\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003eメソッドを追記します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eclass User extends Model\n{\n    use HasFactory, SoftDeletes;\n\n    /**\n     * @return HasMany\n     */\n    public function posts(): HasMany\n    {\n        return $this-\u0026gt;hasMany(Post::class);\n    }\n\n    /**\n     * @return void\n     */\n    public static function booted(): void\n    {\n        static::deleted(function ($user) {\n            $user-\u0026gt;posts()-\u0026gt;delete();\n        });\n    }\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eこれにより、\u0026nbsp;\u003ccode\u003eusers\u003c/code\u003e\u0026nbsp;テーブルのデータ削除時に、リレーション先の\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからも同時に削除してくれます。\u003cbr\u003e\u003cbr\u003e※\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルに対してもソフトデリートの設定を行っている場合は\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルも論理削除、何も設定していなければ\u0026nbsp;\u003ccode\u003eposts\u003c/code\u003e\u0026nbsp;テーブルからは物理削除になります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3bcda3e6b0\"\u003e最後に\u003c/h2\u003e\u003cp\u003e論理削除はDBのレコードを削除するわけでは無く、SQLの命令文でいうと\u0026nbsp;\u003ccode\u003eUPDATE\u003c/code\u003e\u0026nbsp;にあたるので、論理削除の場合はDB的には削除と見なされないということは、よく考えると当たり前でもありますが改めて勉強になりました。\u003cbr\u003e\u003cbr\u003eまたモデルの\u0026nbsp;\u003ccode\u003eboot\u003c/code\u003e\u0026nbsp;メソッドや\u0026nbsp;\u003ccode\u003ebooted\u003c/code\u003e\u0026nbsp;メソッドの使い方や、これらが出来ることについても良い学びになりました。\u003cbr\u003eLaravelのライフサイクルの理解を深めれば、もっともっと実装の引き出しが増えるんだろうなと思うので、コツコツ勉強していきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://yaba-blog.com/larave-soft-delete/#toc3\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel】リレーション先のデータを論理削除（Soft Delete）する方法\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/naoki_oshiumi/articles/e16c9fbb4dfa3d\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eレコードが削除されたときに子要素も一緒に削除する(laravel)\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/niisan-tokyo/items/d3be588b53df8fa0278c\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eLaravelのマニュアルにない?小技: Eloquentのboot時にtraitのbootを別に走らせる - Qiita\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"}],"image":"laravel"},{"id":"laravele-upsert","createdAt":"2022-02-17T13:10:20.839Z","updatedAt":"2022-02-17T13:10:54.928Z","publishedAt":"2022-02-16T13:10:20.000Z","revisedAt":"2022-02-17T13:10:44.894Z","title":"【Laravel8】Eloquentのupsertメソッドで複数レコードのupdateとinsertをよしなに行う","body":"\u003cp\u003e業務で、複数のデータについて、\u003cbr\u003e・既存のデータがDBにあれば更新\u003cbr\u003e・既存のデータがDBになければレコード追加\u003cbr\u003eを行いたいという場面がありました。\u003cbr\u003e\u003cbr\u003eそこで\u003ccode\u003eupdate\u003c/code\u003eか\u003ccode\u003einsert\u003c/code\u003eのどちらを行うかよしなに判断して\u003ccode\u003eBulk insert\u003c/code\u003eを行ってくれるという、すごく便利な\u003ccode\u003eEloquent\u003c/code\u003eの\u003ccode\u003eupsert\u003c/code\u003eメソッドの存在を知ったので、備忘録を書いておきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h00bfa7a117\"\u003eupsertメソッドとは\u003c/h2\u003e\u003cp\u003eLaravel8から実装された機能で、\u003cstrong\u003e1つのクエリで複数のアップサート\u003c/strong\u003eを実行できるメソッドです。\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e※アップサート（\u003c/strong\u003e\u003cstrong\u003e\u003ccode\u003eupsert\u003c/code\u003e\u003c/strong\u003e\u003cstrong\u003e）とは\u003c/strong\u003e\u003cbr\u003eupdate + insertのことで、データの更新(update)とデータの挿入(insert)の両方の機能を併せ持つ。\u003cbr\u003e対象のレコードがあればそのレコードを更新し、レコードがなければレコードの新規追加をするという場合で使う。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eLaravel7までにも\u003ccode\u003eupdateOrCreate\u003c/code\u003eメソッドや\u003ccode\u003efirstOrCreate\u003c/code\u003eメソッドという一つのレコードをアップサートするメソッドはありましたが、\u003ccode\u003eupsert\u003c/code\u003eメソッドにより複数レコードを\u003ccode\u003eBulk insert\u003c/code\u003eできるようになったようです。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h4d849f4362\"\u003e使い方\u003c/h2\u003e\u003cp\u003e\u003ccode\u003eusersテーブル\u003c/code\u003eに複数のデータを\u003ccode\u003eupsert\u003c/code\u003eする例を書いてみます。\u003cbr\u003e\u003cbr\u003e前提として、DBの\u003ccode\u003eusersテーブル\u003c/code\u003eには\u003cbr\u003e\u003cstrong\u003e・id：1、name：taro\u003c/strong\u003e\u003cbr\u003e\u003cstrong\u003e・id：2、name：hanako\u003c/strong\u003e\u003cbr\u003eの2つのレコードが既に存在するとします。\u003cbr\u003e\u003cbr\u003eこれに対して以下の通り\u003ccode\u003eupsert\u003c/code\u003eメソッドを実行します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eUser::upsert([\n  ['id' =\u0026gt; 1, 'name' =\u0026gt; 'taro', 'age' =\u0026gt; 20],      // update\n  ['id' =\u0026gt; 2, 'name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22],      // update\n  ['id' =\u0026gt; null, 'name' =\u0026gt; 'taro', 'age' =\u0026gt; 24]    // insert\n], ['id'], ['name', 'age']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e結果は、第2引数に渡した\u003ccode\u003eid\u003c/code\u003eが一致するレコードがあった1つ目と2つ目は\u003ccode\u003eupdate\u003c/code\u003eとなり、3つ目は\u003ccode\u003einsert\u003c/code\u003eになります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h997f312e71\"\u003e構文\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eupsert\u003c/code\u003eメソッドは3つの引数を持ちます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第1引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eまたは\u003ccode\u003einsert\u003c/code\u003eを行いたい値を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第2引数\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eレコードを一意に識別するカラム（プライマリーキーかユニークキー）を配列で渡す。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e第3引数（省略可）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ccode\u003eupdate\u003c/code\u003eが行われる際に、更新する必要があるカラムを配列で渡す。\u003cbr\u003e省略すると全カラム更新される。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h86c1eb6dfa\"\u003e注意点\u003c/h2\u003e\u003cp\u003e色んな引数を渡して動作確認をしてみて、気を付けるべきと思ったことを挙げておきます。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h93464fb061\"\u003e第2引数に指定して意味があるのはプライマリーキーもしくはユニークキーのみ\u003c/h4\u003e\u003cp\u003e上記の例で第2引数に\u003ccode\u003e['id', 'name']\u003c/code\u003eを渡したとします。\u003cbr\u003e\u003cbr\u003eすると2つ目のデータ\u003ccode\u003e['id' =\u0026gt; 2, 'name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22]\u003c/code\u003eについては、既存のDBのデータは\u003ccode\u003eid：2、name：hanako\u003c/code\u003eであり\u003ccode\u003ename\u003c/code\u003eが一致しないので\u003ccode\u003einsert\u003c/code\u003eになる…と思いきや、\u003ccode\u003eupdate\u003c/code\u003eが実行されました。\u003cbr\u003e\u003cbr\u003eReadoubleにも\u003c/p\u003e\u003cblockquote\u003e2番目の引数は、関連付けられたテーブル内のレコードを一意に識別するカラムをリストします。\u003c/blockquote\u003e\u003cp\u003eと書いてあるので、第2引数に渡せるのは一意に識別できるカラムに限るようです。\u003cbr\u003e\u003c/p\u003e\u003ch4 id=\"h80576f371d\"\u003e第2引数には第1引数に渡しているカラムを渡す\u003c/h4\u003e\u003cp\u003e先ほどの例で、以下のように第1引数には\u003ccode\u003eid\u003c/code\u003eを渡さず、第2引数に\u003ccode\u003eid\u003c/code\u003eを渡したとします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eUser::upsert([\n  ['name' =\u0026gt; 'taro', 'age' =\u0026gt; 20],\n  ['name' =\u0026gt; 'jiro', 'age' =\u0026gt; 22],\n  ['name' =\u0026gt; 'taro', 'age' =\u0026gt; 24] \n], ['id'], ['name', 'age']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこの場合は\u003ccode\u003eid\u003c/code\u003eが一致するカラムがあったとしても全て\u003ccode\u003einsert\u003c/code\u003eになりました。\u003cbr\u003eなので第2引数に指定するカラムは、必ず第1引数にも渡しておかないといけません。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hb95673d4bb\"\u003ecreated_atとupdated_atは自動で設定される\u003c/h2\u003e\u003cp\u003eモデルのタイムスタンプが有効になっている場合、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eのカラムは自動的に値を入れてくれます。\u003cbr\u003e\u003cbr\u003e第1引数には\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eについて何も書かなくても、\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eupdate\u003c/code\u003e\u0026nbsp;：\u003ccode\u003eupdated_at\u003c/code\u003eのみ更新\u003c/li\u003e\u003cli\u003e\u003ccode\u003einsert\u003c/code\u003e\u0026nbsp;：\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは処理をしたときの時刻\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eとしてくれます。\u003cbr\u003e\u003cbr\u003e普通の\u0026nbsp;\u003ccode\u003einsert\u003c/code\u003eメソッドを使って\u003ccode\u003ebulk insert\u003c/code\u003eする場合は、\u003ccode\u003ecreated_at\u003c/code\u003eと\u003ccode\u003eupdated_at\u003c/code\u003eは自動入力されず明示的に含める必要があるので、これは便利だなと思いました。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h09ff17952e\"\u003e【おまけ】実装例\u003c/h2\u003e\u003cp\u003e実際のコードの書き方の例も残しておきたいと思います。\u003cbr\u003e\u003cbr\u003eこれは\u003ccode\u003eupsert\u003c/code\u003eだけでなく通常の\u003ccode\u003ebulk insert\u003c/code\u003eにも言えることですが、DBを更新するための配列を\u003ccode\u003eforeach\u003c/code\u003eや\u003ccode\u003efor\u003c/code\u003e文を回して作る際は、以下のように書くとスッキリします。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// POSTされたデータ配列 $postedAnswers をupsertする場合\n\n$upsertAnswers = [];\n\nforeach ($postedAnswers as $answer) {\n  $upsertAnswers [] = [\n    'id' =\u0026gt; $answer['id'] ?? null,\n    'body' =\u0026gt; $answer['body'],\n    'type' =\u0026gt; $answer['type']\n  ];\n}\n\n// idが一致するレコードがあれば更新、無ければレコード作成する\nAnswer::upsert($upsertSelections, ['id']);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e私ははじめ\u003ccode\u003earray_push\u003c/code\u003eを使って配列に要素を追加していっていましたが、先輩にレビューいただいて上記の書き方を知ったのでこれもメモでした！\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/eloquent.html#:~:text=%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%80%81-,upsert%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89,-%E3%81%AFcreated_at%E3%81%A8\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eEloquentの準備 8.x Laravel\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://readouble.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/uchiii1/items/bb8043719f15e40db35b#eloquent%E3%81%AEupsert%E3%81%A3%E3%81%A6\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel８】Eloquentのupsert()について - Qiita\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com\u003c/a\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/y640/articles/9f66d6abfeecf6#%E4%BD%BF%E3%81%84%E6%96%B9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Laravel 8】Bulk insertはEloquent::upsertメソッドが便利\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://zenn.dev\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"}],"image":"laravel"},{"id":"react-serch","createdAt":"2022-01-06T00:15:53.503Z","updatedAt":"2022-02-12T11:40:50.275Z","publishedAt":"2022-02-06T00:15:53.000Z","revisedAt":"2022-02-12T11:40:50.275Z","title":"Reactでリアルタイムの検索機能を実装する","body":"\u003cp\u003e個人ブログサイトを作った際、記事一覧画面にキーワード検索やカテゴリーで絞り込む機能を実装しました。\u003cbr\u003e\u003cbr\u003eAPIから取得したコンテンツなどフロントエンドで保持しているデータに対して絞り込みを行う機能は色んな場面で使えるかなと思うので、そのロジックと具体的な実装方法をまとめておきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h652c073a9b\"\u003e基本的なロジック\u003c/h2\u003e\u003cp\u003e\u003cbr\u003eデータの絞り込みを行う基本的なロジックは、JavaScriptの組み込み関数の\u003ccode\u003efitler\u003c/code\u003e  を利用した\u003cstrong\u003e配列操作\u003c/strong\u003eです。\u003cbr\u003e\u003c/p\u003e\u003cblockquote\u003e\u003ccode\u003e filter()\u003c/code\u003eメソッドは、与えられた関数によって実装されたテストに合格したすべての配列からなる\u003cstrong\u003e新しい配列を生成\u003c/strong\u003eします。\u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\u003c/a\u003e\u003c/blockquote\u003e\u003cp\u003e\u003ca style=\"background-color:#ffffff\" href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/filter\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e[\"りんご\", \"みかん\", \"いちご\"].filter((text) =\u0026gt; {\n\u0026nbsp;return text !== \"りんご\";\n});\n\n// #=\u0026gt; [\"みかん\", \"いちご\"];\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003efilterメソッドを使ってReactで検索機能を実装する流れは以下の通りです。\u003cbr\u003e\u003c/p\u003e\u003col\u003e\u003cli\u003eユーザーから検索条件を受け取る。（キーワードの入力、カテゴリーの選択など）\u003c/li\u003e\u003cli\u003e全てのデータが入った配列に対して、filterメソッドにより1.で受け取った検索条件に合致するデータのみを選別して新しい配列を生成する。\u003c/li\u003e\u003cli\u003e2.で生成された配列の中身を画面に一覧表示する。\u003c/li\u003e\u003c/ol\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hb4d7d075a8\"\u003e検索機能の実装例\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e以下のURLはこれから説明する検索機能を実装したサンプルコードです。\u003cbr\u003e\u003cbr\u003eサンプルコードにある、\u003ccode\u003e①カテゴリー選択ボタンによる検索\u003c/code\u003e と\u003ccode\u003e②フリーキーワード検索\u003c/code\u003eについて解説していきます。 \u003cbr\u003e\u003c/p\u003e\u003ciframe class=\"embedly-embed\" src=\"https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fcodesandbox.io%2Fembed%2Fc93jo\u0026display_name=CodeSandbox\u0026url=https%3A%2F%2Fcodesandbox.io%2Fs%2Fc93jo\u0026image=https%3A%2F%2Fcodesandbox.io%2Fapi%2Fv1%2Fsandboxes%2Fc93jo%2Fscreenshot.png\u0026key=94335756f04b424b8ce3ce71cbe3de0a\u0026type=text%2Fhtml\u0026schema=codesandbox\" width=\"1000\" height=\"500\" scrolling=\"no\" title=\"CodeSandbox embed\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen=\"true\"\u003e\u003c/iframe\u003e\u003cp\u003e\u003ca href=\"https://codesandbox.io/s/react-serch-c93jo?file=/src/App.js\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://codesandbox.io/s/react-serch-c93jo?file=/src/App.js\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e実際のWebサービスでは、ブログ記事のデータはAPIから受け取ることが多いかと思いますが、今回は予め \u003ccode\u003eposts\u003c/code\u003e という配列で記事データを用意し、フロント側で保持しておきます。\u003cbr\u003e\u003cbr\u003e【検索対象とする記事データ】\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst posts = [\n\u0026nbsp;{\n\u0026nbsp;\u0026nbsp;title: 'useStateの使い方',\n\u0026nbsp;\u0026nbsp;category: 'React'\n\u0026nbsp;},\n\u0026nbsp;{\n\u0026nbsp;\u0026nbsp;title: 'LaravelのMVCモデルについて',\n\u0026nbsp;\u0026nbsp;category: 'Laravel'\n\u0026nbsp;},\n\u0026nbsp;{\n\u0026nbsp;\u0026nbsp;title: '同一オリジンポリシーとCORS',\n\u0026nbsp;\u0026nbsp;category: 'Web'\n\u0026nbsp;},\n\u0026nbsp;{\n\u0026nbsp;\u0026nbsp;title: 'useEffectの使い方',\n\u0026nbsp;\u0026nbsp;category: 'React'\n\u0026nbsp;}\n]\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eそして、画面に表示する記事データを管理するための状態変数 \u003ccode\u003eshowPosts\u003c/code\u003e  を用意し、\u003ccode\u003eshowPosts\u003c/code\u003eの記事を一覧表示します。 \u003cbr\u003e\u003ccode\u003eshowPosts\u003c/code\u003eの初期値には、上記の\u003ccode\u003eposts\u003c/code\u003eを入れておきます。   \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eexport default function App() {\n\u0026nbsp;const [showPosts, setShowPosts] = useState(posts);\n\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;div className=\"App\"\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;h1\u0026gt;記事一覧\u0026lt;/h1\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{showPosts.map((post, index) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div key={post.title}\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;{index+1}. {post.title}\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;category：{post.category}\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;})}\n\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eブラウザに表示すると以下の通りです。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/4218f0d2e06447bcaad24ed417b5c3a9/blogs.png\" alt=\"\"\u003e\u003cbr\u003eこの記事一覧に対して絞り込みを行っていきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hc8bb7fb60d\"\u003e①カテゴリー選択ボタンによる検索\u003c/h2\u003e\u003cp\u003eまずは、カテゴリー選択ボタンでカテゴリーを絞り込む機能を実装してみます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2661198b93\"\u003e実装手順\u003c/h3\u003e\u003cp\u003e1. カテゴリーリストの配列を作成\u003cbr\u003e2. カテゴリー選択ボタンを設置\u003cbr\u003e3. \u003ccode\u003eonClick\u003c/code\u003e時に実行して絞り込み処理を行う\u003ccode\u003eselectCategory\u003c/code\u003eメソッドを定義   \u003cbr\u003e\u003cbr\u003e実装したコードはこちらです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eexport default function App() {\n\n\u0026nbsp;const [showPosts, setShowPosts] = useState(posts);\n\n\u0026nbsp;// カテゴリーリスト\n\u0026nbsp;const categories = Array.from(new Set(posts.map((post) =\u0026gt; post.category)));\n\t\n\u0026nbsp;// カテゴリー絞り込み\n\u0026nbsp;const selectCategory = (category) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// allを選択した場合は早期return\n\u0026nbsp;\u0026nbsp;if (category === \"all\") {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;setShowPosts(posts);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;return;\n\u0026nbsp;\u0026nbsp;}\n\n\u0026nbsp;\u0026nbsp;const selectedPosts = posts.filter((post) =\u0026gt; post.category === category);\n\u0026nbsp;\u0026nbsp;setShowPosts(selectedPosts);\n\u0026nbsp;};\n\u0026nbsp;\u0026nbsp;\n\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;div className=\"App\"\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;h1\u0026gt;記事一覧\u0026lt;/h1\u0026gt;\n\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{/* カテゴリー選択ボタン */}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;h4\u0026gt;Category：\u0026lt;/h4\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;button onClick={() =\u0026gt; selectCategory(\"all\")}\u0026gt;All\u0026lt;/button\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{categories.map((category) =\u0026gt; (\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;button onClick={() =\u0026gt; selectCategory(category)}\u0026gt;{category}\u0026lt;/button\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;))}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{showPosts.map((post, index) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div key={post.title}\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{index + 1}. {post.title}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;category：{post.category}\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;})}\n\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8a50fc5ec1\"\u003eポイント解説\u003c/h3\u003e\u003cp\u003e\u003cbr\u003eひとつずつ解説します。\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e1.カテゴリーリストの配列を作成\u003c/strong\u003e \u003cbr\u003e\u003ccode\u003eposts\u003c/code\u003e配列に記事が存在するカテゴリーの分だけカテゴリー選択ボタンを設置したいので、まずはカテゴリーのリストを作成します。  \u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// カテゴリーリスト\nconst categories = Array.from(new Set(posts.map((post) =\u0026gt; post.category)));\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eJavaScriptの\u003ccode\u003eSetオブジェクト\u003c/code\u003eを使って、\u003ccode\u003eposts\u003c/code\u003e  に存在するカテゴリーを\u003cstrong\u003e 重複排除\u003c/strong\u003eして格納したカテゴリーリストを作っています。 \u003cbr\u003eSetオブジェクトについては以下の記事を参考にしました。\u003cbr\u003e\u003ca href=\"https://qiita.com/netebakari/items/7c1db0b0cea14a3d4419\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com/netebakari/items/7c1db0b0cea14a3d4419\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eSetオブジェクトはES2015から導入された機能で、重複した値が無いことを保証してくれます。\u003c/p\u003e\u003cblockquote\u003e Setオブジェクトは値のコレクションです。挿入順に要素を反復することができます。Setに\u003cstrong\u003e重複する値は格納出来ません\u003c/strong\u003e。Set内の値はコレクション内で一意となります。\u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Set\"\u003e\u0026nbsp;\u003c/a\u003e\u003ca href=\"unsafe:[object Object]\"\u003ehttps://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Set\u003c/a\u003e\u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003e\u003cstrong\u003e2.　カテゴリー選択ボタンを設置\u003c/strong\u003e \u003cbr\u003e各カテゴリーを選択するボタンと、全ての記事を表示するためのAllボタンを作ります。\u003cbr\u003e\u003cbr\u003e1.で作成したカテゴリーリストの分だけカテゴリー選択ボタンを設置します。\u003cbr\u003e\u003cbr\u003eカテゴリー選択ボタンとAllボタンの\u003ccode\u003eonClick\u003c/code\u003e時には\u003ccode\u003eselectCategory\u003c/code\u003eメソッドを実行し、引数には該当のカテゴリーを渡しています。   \u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;button onClick={() =\u0026gt; selectCategory(\"all\")}\u0026gt;All\u0026lt;/button\u0026gt;\n{categories.map((category) =\u0026gt; (\n\u0026nbsp;\u0026nbsp;\u0026lt;button onClick={() =\u0026gt; selectCategory(category)}\u0026gt;{category}\u0026lt;/button\u0026gt;\n))}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003cstrong\u003e3.　onClick時に実行するselectCategoryメソッドを定義\u003c/strong\u003e \u003cbr\u003e\u003ccode\u003eposts\u003c/code\u003eの中から、選択されたカテゴリーと一致するカテゴリーの記事のみを\u003ccode\u003efilter\u003c/code\u003eメソッドで選別しています。   \u003cbr\u003e\u003cbr\u003e絞り込み後の配列を、一覧表示に使う状態変数\u003ccode\u003eshowPosts\u003c/code\u003eにセットしています。  \u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst selectCategory = (category) =\u0026gt; {\n\u0026nbsp;// allの場合は早期return\n\u0026nbsp;if (category === \"all\") {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;setShowPosts(posts);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;return;\n\u0026nbsp;}\n\u0026nbsp;const selectedPosts = posts.filter((post) =\u0026gt; post.category === category);\n\u0026nbsp;setShowPosts(selectedPosts);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h9f9b4f1e4a\"\u003e②フリーキーワード\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e次に、ユーザーの入力値による絞り込み（フリーキーワード検索）の機能を実装してみます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2661198b93\"\u003e実装手順\u003c/h3\u003e\u003cp\u003e\u003cbr\u003e1. 検索フォームへの入力値を保持する状態変数\u003ccode\u003einputValue\u003c/code\u003eを定義  \u003cbr\u003e2. フリーキーワード検索フォームを設置\u003cbr\u003e3. 検索フォームの\u003ccode\u003eonChange\u003c/code\u003e時に実行する\u003ccode\u003ehandleInputChange\u003c/code\u003eメソッドを定義   \u003cbr\u003e4. 検索フォームへの入力値が変わる度に実行して絞り込みを行う\u003ccode\u003esearch\u003c/code\u003eメソッドを定義  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eexport default function App() {\n\u0026nbsp;const [showPosts, setShowPosts] = useState(posts)\n\u0026nbsp;const [inputValue, setInputValue] = useState()\n\n\u0026nbsp;// 検索欄への入力値をハンドリング\n\u0026nbsp;const handleInputChange = (e) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;setInputValue(e.target.value)\n\u0026nbsp;\u0026nbsp;search(e.target.value)\n\u0026nbsp;}\n\n\u0026nbsp;// 検索欄への入力値での絞り込み\n\u0026nbsp;const search = (value) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// 検索欄への入力が空の場合は早期return\n\u0026nbsp;\u0026nbsp;if (value === \"\") {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;setShowPosts(posts);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;return;\n\u0026nbsp;\u0026nbsp;}\n\n\u0026nbsp;\u0026nbsp;const serchedPosts = posts.filter(\n\u0026nbsp;\u0026nbsp;\u0026nbsp;(post) =\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;Object.values(post).filter(\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;(item) =\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item !== undefined \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item !== null \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item.toUpperCase().indexOf(value.toUpperCase()) !== -1\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;).length \u0026gt; 0\n\u0026nbsp;\u0026nbsp;);\n\n\u0026nbsp;\u0026nbsp;setShowPosts(serchedPosts);\n\u0026nbsp;}\n\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;div className=\"App\"\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;h1\u0026gt;記事一覧\u0026lt;/h1\u0026gt;\n\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{/* フリーキーワード検索フォーム */}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;h4\u0026gt;Search\u0026lt;/h4\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;input type=\"text\" value={inputValue} onChange={handleInputChange} /\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{/* 記事一覧表示 */}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{showPosts.map((post, index) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div key={post.title}\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{index + 1}. {post.title}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;category：{post.category}\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;);\n\u0026nbsp;\u0026nbsp;\u0026nbsp;})}\n\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;);\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8a50fc5ec1\"\u003eポイント解説\u003c/h3\u003e\u003cp\u003e\u003cbr\u003e大体はReactの基本の知識でカバーできるかと思います。\u003cbr\u003e\u003cbr\u003e4.の絞り込みを行うロジックの部分は一見ややこしいですが、一つずつ読み解いて解説していきます。\u003cbr\u003e\u003cbr\u003e記事の絞り込みを行っているのは以下の部分です。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst serchedPosts = posts.filter(\n\u0026nbsp;(post) =\u0026gt;\n\u0026nbsp;\u0026nbsp;Object.values(post).filter(\n\u0026nbsp;\u0026nbsp;\u0026nbsp;(item) =\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item !== undefined \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item !== null \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;item.toUpperCase().indexOf(value.toUpperCase()) !== -1\n\u0026nbsp;\u0026nbsp;).length \u0026gt; 0\n)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこのコードでは、\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eタイトルもしくはカテゴリーの\u003cstrong\u003eいずれか\u003c/strong\u003eにユーザーの入力値を\u003cstrong\u003e含む\u003c/strong\u003e（全一致ではない） \u003c/li\u003e\u003cli\u003e大文字小文字の違いは許容 \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eという要件で絞り込んでいます。\u003cbr\u003e\u003cbr\u003e要点を解説していきます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003cstrong\u003eObject.values()\u003c/strong\u003e \u003c/li\u003e\u003c/ul\u003e\u003cpre\u003e\u003ccode\u003eObject.values(post)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e上記の部分で、オブジェクトの\u003cstrong\u003eプロパティの値を配列で取得\u003c/strong\u003eする`Object.values()`メソッドを使い、検索対象の値を格納した配列を作ります。 \u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/values\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/values\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003cstrong\u003eundefinedとnullを除外\u003c/strong\u003e \u003c/li\u003e\u003c/ul\u003e\u003cpre\u003e\u003ccode\u003eitem !== undefined \u0026amp;\u0026amp;\nitem !== null \u0026amp;\u0026amp;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e次に出てくる\u003ccode\u003etoUpperCase()\u003c/code\u003eは\u003ccode\u003enull\u003c/code\u003eや\u003ccode\u003eundefined\u003c/code\u003eの値に対しては使えません。    \u003cbr\u003e\u003cbr\u003eなので仮にこの2行が無いと、\u003ccode\u003eObect.values(post)\u003c/code\u003eで生成された配列の中に\u003ccode\u003eundefined\u003c/code\u003eもしくは\u003ccode\u003enull\u003c/code\u003eがあった場合 \u003ccode\u003eCannot read properties of null (reading 'toUpperCase')\u003c/code\u003e というエラーが出ます。     \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003cstrong\u003etoUpperCase()\u003c/strong\u003e \u003c/li\u003e\u003c/ul\u003e\u003cblockquote\u003e\u003cstrong\u003etoUpperCase()\u003c/strong\u003eメソッドは、呼び出す文字列の値を（文字列でない場合、文字列に変換して）大文字に変換して返します。\u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/toUpperCase\"\u003e\u0026nbsp;https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/toUpperCase\u003c/a\u003e\u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003e\u003cstrong\u003e記事のタイトルとカテゴリー\u003c/strong\u003eと、\u003cstrong\u003eユーザーの入力値\u003c/strong\u003e の双方を大文字に変換することで、\u003cstrong\u003e大文字・小文字の違いは許容\u003c/strong\u003eします。  \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003cstrong\u003eindexOf()\u003c/strong\u003e\u003c/li\u003e\u003c/ul\u003e\u003cblockquote\u003e\u003cstrong\u003eindexOf()\u003c/strong\u003eメソッドは、呼び出す\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eString\u003c/a\u003eオブジェクト中で、 \u003ccode\u003efromIndex\u003c/code\u003e   から検索を始め、指定された値が最初に現れたインデックスを返します。値が見つからない場合は\u0026nbsp;\u003ccode\u003e-1\u003c/code\u003eを返します \u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/indexOf\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/indexOf\u003c/a\u003e\u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eitem.toUpperCase().indexOf(value.toUpperCase()) !== -1\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e値が見つからなければ \u003ccode\u003e-1\u003c/code\u003eを返すという特性を使って、記事のタイトルやカテゴリーにユーザーの入力値を含んでいれば \u003ccode\u003e true\u003c/code\u003e 、含まなければ \u003ccode\u003efalse\u003c/code\u003e を返すようにしています。\u003cbr\u003e\u003cbr\u003e以上のステップを経て、以下のコードで検索キーワードを含む値が1つでもある記事は \u003ccode\u003e.length \u0026gt; 0\u003c/code\u003e の結果 \u003cem\u003etrue\u003c/em\u003eが返り、\u003ccode\u003eserchedPosts\u003c/code\u003eに格納されます。    \u003c/p\u003e\u003cpre\u003e\u003ccode\u003eObject.values(member).filter(\n\u0026nbsp;(item: string) =\u0026gt;\n\u0026nbsp;\u0026nbsp;item !== undefined \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;item !== null \u0026amp;\u0026amp;\n\u0026nbsp;\u0026nbsp;item.toUpperCase().indexOf(value.toUpperCase()) !== -1\n).length \u0026gt; 0\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eあとはこの\u003ccode\u003eserchedPosts\u003c/code\u003eを画面に表示するだけです。  \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h1afe451c43\"\u003eさいごに\u003c/h2\u003e\u003cp\u003eSetオブジェクト、fileterメソッド、indexOfメソッド、toUpperCaseメソッドなど、JavaScriptの持つメソッドについても勉強になりました。\u003cbr\u003e\u003cbr\u003e組み込み関数を一通りチラッとでも知っていれば、何かを実装したい時にあれを使えばできそう…って考えられると思うので、元々用意されている関数なんかの知識は増やしていきたいなと思います。\u003cbr\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://himenon.github.io/docs/javascript/simple-react-local-search-form/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://himenon.github.io/docs/javascript/simple-react-local-search-form/\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/takf-jp/items/af10bc05428b1182ece5\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com/takf-jp/items/af10bc05428b1182ece5\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"}],"image":"react2"},{"id":"docker-lemp","createdAt":"2022-02-10T12:13:34.104Z","updatedAt":"2022-02-12T10:24:14.756Z","publishedAt":"2022-01-31T12:13:34.000Z","revisedAt":"2022-02-12T10:04:24.386Z","title":"DockerでPHP（Laravel）+ nginx + MySQLのLEMP環境を構築する","body":"\u003cp\u003eDocker, Docker Compose を使って、\u003ccode\u003ePHP（Laravel） + nginx + MySQL\u003c/code\u003eの\u003ccode\u003eLEMP環境\u003c/code\u003eを構築する記事です。   \u003cbr\u003e\u003cbr\u003e検索するとDockerfileやdocker-compose.ymlの書き方については色んな方が記事を書いてくださっていて、動く環境を作ること自体は難しくありませんでした。\u003cbr\u003e\u003cbr\u003eですが、筆者はひとつコンテナを作っては動作確認していくという過程を経てすごく理解が深まったなと思うので、ファイルの書き方だけでなく動作確認したことやその結果を含めて記事に残しておきたいと思います。\u003cbr\u003e\u003cbr\u003e↓　完成後のリポジトリはこちらです。\u003cbr\u003e\u003ca href=\"unsafe:[object Object]\"\u003ehttps://github.com/hinakonagao/laravel_docker\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"hdb194e8fef\"\u003e 全体像\u003c/h1\u003e\u003cp\u003e最終的なディレクトリ構成は以下の通りです。\u003cbr\u003e\u003cbr\u003e全コンテナを管理するdocker-compose.ymlがトップレベルにあり、同じくトップレベルにあるdockerディレクトリ配下に各コンテナのDockerfileや設定ファイルを置いています。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003edocker_sample/\n├── src\u0026nbsp;\u0026nbsp;// Laravelプロジェクトのソースコード\n├── docker\n│\u0026nbsp;\u0026nbsp;├── app\u0026nbsp;\u0026nbsp;// PHPコンテナ\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;├── Dockerfile\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;└── php.ini\n│\u0026nbsp;\u0026nbsp;├── db\u0026nbsp;\u0026nbsp;\u0026nbsp;// MySQLコンテナ\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;├── Dockerfile\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;└── my.cnf\n│\u0026nbsp;\u0026nbsp;└── web\u0026nbsp;\u0026nbsp;// nginxコンテナ\n│\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;├── Dockerfile\n│\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;└── default.conf\n└──\u0026nbsp;docker-compose.yml\u0026nbsp;\u0026nbsp;// 全コンテナの管理\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003cbr\u003e早速一つずつコンテナを作っていきます。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h949dc20ce4\"\u003ePHPのコンテナ（Laravelの開発環境）\u003c/h1\u003e\u003cp\u003eまずはLaravelの開発環境を構築するための、PHPのコンテナを作成します。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e docker-compose.ymlへの記述\u003c/li\u003e\u003cli\u003e PHPコンテナ用のDockerfile\u003c/li\u003e\u003cli\u003e PHPコンテナ用の設定ファイル（php.ini）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eについて順に説明します。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hce39c12d7b\"\u003e docker-compose.yml（PHP）\u003c/h2\u003e\u003cp\u003e\u003cbr\u003edocker-compose.ymlのうち、PHPコンテナについての記述は以下の通りです。\u003cbr\u003e※docker-compose.ymlはインデントが意味を持つので注意。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eversion: \"3.9\"\n\nservices:\n\u0026nbsp;app:\u0026nbsp;\u0026nbsp;// サービス名\n\u0026nbsp;\u0026nbsp;build:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;context: .\n\u0026nbsp;\u0026nbsp;\u0026nbsp;dockerfile: ./docker/app/Dockerfile\n\u0026nbsp;\u0026nbsp;volumes:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- ./src/:/app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003eversion:\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;これはPHPコンテナについてではなく \u003ccode\u003edocker-compose.yml\u003c/code\u003e の先頭に書く設定ですが、Composeファイルのバージョンを表しています。  \u003cbr\u003e\u0026nbsp;\u0026nbsp;今回は最新の `3.9` を使います。（最新のバージョンは下記の公式サイトを参照）\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u003ca href=\"https://docs.docker.com/compose/compose-file/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eCompose file\u003c/a\u003e \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003ebuild:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;ビルドコンテキストを指定します。\u003c/p\u003e\u003cul\u003e\u003cli\u003e context：ビルドコンテキスト（buildを実行する場所）の設定\u003c/li\u003e\u003cli\u003e dockerfile：buildするDockerfileまでのパス（docker-compose.ymlから見た相対パス）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;参考記事： \u003ca href=\"https://qiita.com/sam8helloworld/items/e7fffa9afc82aea68a7a\" target=\"_blank\" rel=\"noopener noreferrer\"\u003edocker-compose.ymlのbuild設定はとりあえずcontextもdockerfileも埋めとけって話 - Qiita\u003c/a\u003e \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003evolumes:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;ホスト側の \u003ccode\u003e./src/\u003c/code\u003eをコンテナ側の \u003ccode\u003e/app\u003c/code\u003e にマウントするという意味になります。   \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;※ここで \u003ccode\u003eservices:\u003c/code\u003e の中に書いているこの \u003ccode\u003evolumes:\u003c/code\u003e は \u003ccode\u003eバインドマウント\u003c/code\u003e を行っています。    \u003cbr\u003e\u0026nbsp;\u0026nbsp;参考記事：\u003ca href=\"https://qiita.com/y518gaku/items/456f34c317a65a9dae86\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eDockerのマウント3種類についてわかったことをまとめる - Qiita\u003c/a\u003e \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;何が起きているかは実際の挙動を見てみた方が分かりやすいと思うので、後ほどまた動作確認します。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2043ae13c7\"\u003eDockerfile（PHP）\u003c/h2\u003e\u003cp\u003eDockerfileはテキストファイルであり、Dockerイメージを作り上げるために実行する命令をこのファイルに書きます。\u003cbr\u003e\u003cbr\u003e作成するDockerfileの全文がこちらです。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eFROM php:8.0-fpm\n\nENV TZ Asia/Tokyo\n\nRUN apt-get update \u0026amp;\u0026amp; \\\n\tapt-get install -y git unzip libzip-dev libicu-dev libonig-dev \u0026amp;\u0026amp; \\\n\tdocker-php-ext-install intl pdo_mysql zip bcmath\n\nCOPY ./docker/app/php.ini /usr/local/etc/php/php.ini\nCOPY --from=composer:2.0 /usr/bin/composer /usr/bin/composer\n\nWORKDIR /app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e一つずつ説明します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eFROM php:8.0-fpm\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003eFROM\u003c/code\u003eではイメージをビルドするためのベースイメージを設定します。  \u003cbr\u003e書き方は \u003ccode\u003eFROM イメージ名:タグ名\u003c/code\u003e です。  \u003cbr\u003eここではDocker HubからPHP公式のイメージをベースとして指定しています。\u003cbr\u003e\u003ca href=\"https://hub.docker.com/_/php\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ePhp - Official Image | Docker Hub\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eENV TZ Asia/Tokyo\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003eENV\u003c/code\u003eはコンテナ内のサーバー環境変数を設定します。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eRUN apt-get update \u0026amp;\u0026amp; \\\n    apt-get install -y git unzip libzip-dev libicu-dev libonig-dev \u0026amp;\u0026amp; \\\n\tdocker-php-ext-install intl pdo_mysql zip bcmath\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003eRUN\u003c/code\u003e にはコンテナビルド時に実行するコマンドを書きます。  \u003cbr\u003e\u0026nbsp;\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e で複数のコマンドをつなぎ、 \u003ccode\u003e\\\u003c/code\u003e で改行します。   \u003cbr\u003e※ \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e と \u003ccode\u003e\\\u003c/code\u003e を使うことで複数コマンドを1レイヤーにまとめることができ、公式でもベストプラクティスのTipsとして挙げられています。   \u003cbr\u003e\u003ca href=\"https://www.docker.com/blog/intro-guide-to-dockerfile-best-practices/#:~:text=Tip%20%233%3A%20Identify%20cacheable%20units%20such%20as%20apt%2Dget%20update%20%26%20install\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eIntro Guide to Dockerfile Best Practices - Docker Blog\u003c/a\u003e \u003cbr\u003e\u003cbr\u003e\u003ccode\u003eapt-get update\u003c/code\u003e ：インストール可能なパッケージの「一覧」を更新  \u003cbr\u003e\u0026nbsp;\u003ccode\u003eapt-get -y install\u003c/code\u003e：パッケージをインストール  \u003cbr\u003e\u0026nbsp;\u003ccode\u003edocker-php-ext-install\u003c/code\u003e：PHPの拡張ライブラリをインストール  \u003cbr\u003e※Laravelのインストールや開発に必要な（もしくは便利な）パッケージや拡張ライブラリをインストールしています。\u003cbr\u003e※試しにこれらを全くインストールせず手順を進めてみると、コンテナを起動することはできますが、その後のLaravelプロジェクトを作成する時に大量のエラーに遭遇しました…（笑）\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eCOPY ./docker/app/php.ini /usr/local/etc/php/php.ini\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eローカルで（後ほど）作成する \u003ccode\u003ephp.ini\u003c/code\u003e （PHPの設定ファイル）をDockerコンテナ内にコピーします。  \u003cbr\u003e書き方は \u003ccode\u003eCOPY [ローカル側のパス] [コンテナ側のパス]\u003c/code\u003eです。  \u003cbr\u003e\u003cbr\u003e※ローカル側のパスは、Dockerfileから見てではなくbuildコマンドを実行するディレクトリから見た相対パスです。今回はDocker composeを使ってイメージビルドを行うので、docker-compose.ymlから見た相対パスになっています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eCOPY --from=composer:2.0 /usr/bin/composer /usr/bin/composer\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eLaravelを使うためComposerをインストールします。\u003cbr\u003eこの書き方により\u003cstrong\u003eマルチステージビルド\u003c/strong\u003eという方法でインストールされます。 \u003cbr\u003e※マルチステージビルドという方法はイメージの軽量化に役立つようです。 \u003cbr\u003e公式ドキュメント：\u003ca href=\"https://docs.docker.com/develop/develop-images/multistage-build/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eUse multi-stage builds\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eWORKDIR /app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eコンテナを起動している時に \u003ccode\u003e$ docker-compose exec コンテナ名 bash\u003c/code\u003e というコマンドを実行すると、コンテナの中でbashを実行することができるのですが、 \u003ccode\u003eWORKDIR\u003c/code\u003eはその時のカレントディレクトリを指定しています。   \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h559c05704d\"\u003e 設定ファイル（php.ini）\u003c/h2\u003e\u003cp\u003e\u0026nbsp;\u003ccode\u003eCOPY ./docker/app/php.ini /usr/local/etc/php/php.ini\u003c/code\u003e で出てきたPHPの設定ファイル \u003ccode\u003ephp.ini\u003c/code\u003eを作成します。   \u003cbr\u003e\u003cbr\u003e作成したファイルの中身がこちらです。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003ezend.exception_ignore_args = off\nexpose_php = on\nmax_execution_time = 30\nmax_input_vars = 1000\nupload_max_filesize = 64M\npost_max_size = 128M\nmemory_limit = 256M\nerror_reporting = E_ALL\ndisplay_errors = on\ndisplay_startup_errors = on\nlog_errors = on\nerror_log = /var/log/php/php-error.log\ndefault_charset = UTF-8\n\n[Date]\ndate.timezone = Asia/Tokyo\n\n[mysqlnd]\nmysqlnd.collect_memory_statistics = on\n\n[Assertion]\nzend.assertions = 1\n\n[mbstring]\nmbstring.language = Japanese\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこちらの記事の開発用php.iniをまるっとお借りしました。\u003cbr\u003e開発用 / 本番用の設定例と、項目ごとの説明も載っていて面白かったので、ぜひご覧ください。\u003cbr\u003e参考記事：\u003ca href=\"https://qiita.com/ucan-lab/items/0d74378e1b9ba81699a9\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ePHP7.4 ぼくのかんがえたさいきょうのphp.ini - Qiita\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2c3fab92b5\"\u003e PHPコンテナを起動する\u003c/h2\u003e\u003cp\u003e\u003cbr\u003eここまででPHPのコンテナの準備が出来たので、実際に起動してみます。\u003cbr\u003e\u003cbr\u003edocker-sompose.ymlのあるディレクトリで以下のコマンドを実行します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose up -d --build\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003edocker compose up\u003c/code\u003e は \u003ccode\u003edocker-compose.yml\u003c/code\u003e に定義したサービスを起動します。   \u003c/li\u003e\u003cli\u003e  \u003ccode\u003e-d\u003c/code\u003eデタッチド」モードでコンテナを起動します。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;（デフォルトは「アタッチド」モードで全てのコンテナログを画面上に表示する。「デタッチド」モードではバックグラウンドで動作する。）\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003e--build\u003c/code\u003e コンテナの開始前にイメージをビルドします。  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;（特に変更がない場合はキャッシュが使用される。）\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e※ \u003ccode\u003e$ docker-compose build\u003c/code\u003e → \u003ccode\u003e$ docker-compose up -d\u003c/code\u003e を順に行うのと同じです。   \u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hbdb8067534\"\u003e 起動したコンテナを確認する\u003c/h3\u003e\u003cp\u003e以下のコマンドで起動中のコンテナを一覧で確認することができます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose ps\n\nNAME\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;COMMAND\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;SERVICE\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;STATUS\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;PORTS\ndocker_sample-app-1\u0026nbsp;\u0026nbsp;\"docker-php-entrypoi…\"\u0026nbsp;\u0026nbsp;app\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;9000/tcp\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eSTATUSがrunningになっていれば正常に起動しています。\u003cbr\u003e\u003cbr\u003e今はPHPのコンテナしか作っていないので1つだけ表示されていますが、この後nginx, MySQLのコンテナを作り、最終的に3つのコンテナが表示されるようにします。\u003cbr\u003e\u003cbr\u003eここで今作業しているディレクトリの構成を確認してみます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ tree\n.\n├── src\u0026nbsp;\u0026nbsp;// 作成された！\n├── docker\n│\u0026nbsp;\u0026nbsp;├── app\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;├── Dockerfile\n│\u0026nbsp;\u0026nbsp;│\u0026nbsp;\u0026nbsp;└── php.ini\n└── docker-compose.yml\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eするとdocker-compose.ymlに書いたバインドマウントの以下の部分を受けて、コンテナを起動したときに自動でsrcディレクトリが作成されたことが確認できます。（同様にコンテナ内にもappディレクトリが作成されています。）\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003evolumes:\n\u0026nbsp;- ./src/:/app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h4353a13706\"\u003e コンテナの中に入ってみる\u003c/h3\u003e\u003cp\u003e\u003cbr\u003eコンテナを起動中に以下のコマンドを実行すると、コンテナの中に入ってbashを実行することができます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec app bash\n// appの部分はサービス名を指定する\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこれで今コンテナの中に入れたので、Dockerfileの記述通りにコンテナが作られているか、またPHP・Composer・インストールした拡張機能が使えるか確認していきます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// Dockerfileの「WORKDIR /app」で指定したカレントディレクトリ通りか確認\n[app]:/app$ pwd\n/app\n\n// PHPのバージョン確認\n[app]:/app$ php -v\nPHP 8.0.15 (cli) (built: Jan 26 2022 17:38:36) ( NTS )\nCopyright (c) The PHP Group\nZend Engine v4.0.15, Copyright (c) Zend Technologies\n\n// Composerのバージョン確認\n[app]:/app$ composer -v\n\u0026nbsp;\u0026nbsp;______\n\u0026nbsp;/ ____/___\u0026nbsp;____ ___\u0026nbsp;____\u0026nbsp;____\u0026nbsp;________\u0026nbsp;_____\n\u0026nbsp;/ /\u0026nbsp;\u0026nbsp;/ __ \\/ __ `__ \\/ __ \\/ __ \\/ ___/ _ \\/ ___/\n/ /___/ /_/ / / / / / / /_/ / /_/ (__\u0026nbsp;)\u0026nbsp;__/ /\n\\____/\\____/_/ /_/ /_/ .___/\\____/____/\\___/_/\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;/_/\nComposer version 2.0.14 2021-05-21 17:03:37\n\n// gitのバージョン確認\n[app]:/app$ git --version\ngit version 2.30.2\n\n// インストール済の拡張機能の一覧\n[app]:/app$ php -m\n[PHP Modules]\nbcmath\nintl\npdo_mysql\nzip\n// たくさん出てくるので他は省略\n\n// php.iniがコピー出来ているか確認\n[app]:/app$ cat /usr/local/etc/php/php.ini\nzend.exception_ignore_args = off\nexpose_php = on\nmax_execution_time = 30\nmax_input_vars = 1000\nupload_max_filesize = 64M\npost_max_size = 128M\nmemory_limit = 256M\nerror_reporting = E_ALL\ndisplay_errors = on\ndisplay_startup_errors = on\nlog_errors = on\nerror_log = /var/log/php/php-error.log\ndefault_charset = UTF-8\n\n[Date]\ndate.timezone = Asia/Tokyo\n\n[mysqlnd]\nmysqlnd.collect_memory_statistics = on\n\n[Assertion]\nzend.assertions = 1\n\n[mbstring]\nmbstring.language = Japaneseroot@0e3ba825df88\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e確認できたのでコンテナを抜けます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ exit\n\n// もしくは ctrl + d\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hb30552acef\"\u003e コンテナの外からコマンドを実行する\u003c/h3\u003e\u003cp\u003e上記のコンテナの中で実行したコマンドは、 \u003ccode\u003e$ docker-compose exec サービス名 実行したいコマンド\u003c/code\u003e でコンテナの外から実行することもできます。（コンテナが起動中に限る）  \u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hbe7ef0b1fb\"\u003e バインドマウントの挙動を確認する\u003c/h3\u003e\u003cp\u003eコンテナの外からコマンドが実行できるという確認も兼ねて、バインドマウントの動きを見る為、試しに以下のコマンドを実行してみます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// コンテナ内の/app配下にファイルを作ってみる\n$ docker-compose exec app touch sample.php\n$ docker-compose exec app pwd\n/app\n$ docker-compose exec app ls\nsample.php\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eコンテナ内の/app配下にファイルを作成しました。\u003cbr\u003e\u003cbr\u003eこの/appという場所は、docker-compose.ymlに書いた以下の記述の通りにバインドマウントされています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003evolumes:\n\u0026nbsp;- ./src/:/app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこれにより、プロジェクトディレクトリ配下の/srcにもsample.phpが作成されています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ ls src\nsample.php\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e以上より、コンテナ内の \u003ccode\u003e/app\u003c/code\u003e に対して行ったことが、プロジェクトの \u003ccode\u003e/src\u003c/code\u003e に反映していることが分かりました。   \u003cbr\u003e\u003cbr\u003eでは次に \u003ccode\u003e/src\u003c/code\u003e への変更がコンテナ内の \u003ccode\u003e/app\u003c/code\u003e に対しても反映するか試してみます。   \u003cbr\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003e/src/sample.php\u003c/code\u003e をエディタで開いてファイルに \u003ccode\u003ehello\u003c/code\u003e と書きこみ、以下のコマンドを実行します。   \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec app cat sample.php\nhello\n\n// この時permission errorが出たら権限を変更する\n$ sudo chmod -R 777 ./src\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eするとコンテナ内の \u003ccode\u003e./app/sample.php\u003c/code\u003e も編集されていることがわかります。  \u003cbr\u003e\u003cbr\u003eこのようにバインドマウントにより、ホスト側のディレクトリがコンテナ内へマウント出来ていることも確認できました。\u003cbr\u003e\u003cbr\u003e試しに作成したファイルは不要なので消しておきます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ rm src/sample.php\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h3a503e139b\"\u003e nginxのコンテナ（webサーバー）\u003c/h1\u003e\u003cp\u003ewebサーバーとなるnginxのコンテナを作成します。\u003cbr\u003e\u003cbr\u003ePHPコンテナのときと同じく、\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e docker-compose.ymlへの記述\u003c/li\u003e\u003cli\u003e nginxコンテナ用のDockerfile\u003c/li\u003e\u003cli\u003e nginxコンテナ用の設定ファイル（default.conf）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eの流れで説明します。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hc888d0dee3\"\u003e docker-compose.yml（nginx）\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e既に作成しているdocker-compose.ymlに、nginxのコンテナについての部分を追記します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eservices:\n\u0026nbsp;api:\n\n// 中略\n\t\n\u0026nbsp;web:\u0026nbsp;\u0026nbsp;// サービス名\n\u0026nbsp;\u0026nbsp;build:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;context: .\n\u0026nbsp;\u0026nbsp;\u0026nbsp;dockerfile: ./docker/web/Dockerfile\n\u0026nbsp;\u0026nbsp;ports:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- 8081:80\n\u0026nbsp;\u0026nbsp;depends_on:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- app\n\u0026nbsp;\u0026nbsp;volumes:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- ./src/:/app\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e解説していきます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003ebuild:\u003c/code\u003e ・\u003ccode\u003evolumes:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;ここはPHPコンテナと同様なので説明は省きます。\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eports:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;ホスト側とコンテナ間のポート番号の対応付けを設定します。\u003cbr\u003e\u0026nbsp;\u0026nbsp;書き方は \u003ccode\u003eホスト側のポート番号 : コンテナのポート番号\u003c/code\u003eです。  \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;※今回ホスト側（自分のPC）は既に他の開発で使っているポートとの兼ね合いで \u003ccode\u003e8081\u003c/code\u003e を使いました。コンテナ側はnginxのデフォルトのポート番号である \u003ccode\u003e80\u003c/code\u003e にしています。   \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003edepends_on:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;サービスの起動順序を制御します。\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003ccode\u003eweb\u003c/code\u003e の \u003ccode\u003edepends_on\u003c/code\u003e に \u003ccode\u003eapp\u003c/code\u003e と書いているので、 \u003ccode\u003eapp\u003c/code\u003e → \u003ccode\u003eweb\u003c/code\u003e の順に起動するように指定しています。      \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;※但しこの記述なしで \u003ccode\u003e$ docker-compose up -d --build\u003c/code\u003e をしてみても私の環境では全く問題なく動きました。が、サービス同士の依存関係を明示的に記すという意味でも書いておくに越したことはないという判断で書いています。  \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;※ nginxとphp間でTCPによるfpm接続についてや、\u003ccode\u003edepends_on\u003c/code\u003e オプションについては以下の記事がすごく勉強になったので是非読んでみてください。  \u003cbr\u003e\u0026nbsp;\u0026nbsp;参考記事：\u003ca href=\"https://qiita.com/haruyanhopemucci/items/344f1e2fb95ed452bdb2#%E5%90%84%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%8C%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E5%90%8D%E3%81%AE%E5%90%8D%E5%89%8D%E8%A7%A3%E6%B1%BA%E3%82%92%E5%BF%85%E8%A6%81%E3%81%A8%E3%81%99%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【docker-compose】dependsonとサービス名解決にまつわるエトセトラ - Qiita\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h5a107e8b8a\"\u003e Dockerfile（nginx）\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e作成するDockerfileの全文はこちらです。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eFROM nginx:1.20-alpine\n\nENV TZ Asia/Tokyo\n\nCOPY ./docker/web/default.conf /etc/nginx/conf.d/default.conf\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003eFROM\u003c/code\u003e , \u003ccode\u003eENV\u003c/code\u003e , \u003ccode\u003eCOPY\u003c/code\u003e の意味はPHPコンテナのDockerfileと同様なので詳しい説明は省略し、このファイルで設定していることを簡単にまとめます。    \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e nginx公式のイメージ（Alpineベース）をベースイメージに使用\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ca href=\"https://hub.docker.com/_/nginx\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eNginx - Official Image | Docker Hub\u003c/a\u003e \u003cbr\u003e参考記事：\u003ca href=\"https://charlie1012.hatenablog.jp/entry/2021/01/14/090000\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eDockerでよく利用されているAlpineは他のLinuxディストリビューションと比べて、どれだけ軽量なのか - プログラミングは芸術だ！\u003c/a\u003e  \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e 環境変数のタイムゾーンを設定する\u003c/li\u003e\u003cli\u003e nginxの設定ファイル（default.conf）をコンテナ内にバインドマウント\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e※ちなみにnginxは1.18, 1.20などの偶数バージョンが安定バージョンであり、安定バージョンの使用を推奨されています。\u003cbr\u003e公式ドキュメント：\u003ca href=\"https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/#stablevsmainline\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eInstalling NGINX Open Source\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h833dd2537f\"\u003e 設定ファイル（default.conf）\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003e./docker/web/default.conf\u003c/code\u003eを作成します。  \u003cbr\u003eLaravel公式に用意されているnginxの設定例をべースに使います。\u003cbr\u003e\u003ca href=\"https://readouble.com/laravel/8.x/ja/deployment.html\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eLaravel 8.x デプロイ\u003c/a\u003e \u003cbr\u003e\u003cbr\u003e\u0026nbsp;\u003ccode\u003eroot\u003c/code\u003e と\u003ccode\u003efastcgi_pass\u003c/code\u003eの設定のみ、このプロジェクトに合わせて書き換えています。   \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eserver {\n\u0026nbsp;\u0026nbsp;listen 80;\n\u0026nbsp;\u0026nbsp;server_name example.com;\n\u0026nbsp;\u0026nbsp;root /app/public;\u0026nbsp;\u0026nbsp;// 書き換え\n\n\u0026nbsp;\u0026nbsp;add_header X-Frame-Options \"SAMEORIGIN\";\n\u0026nbsp;\u0026nbsp;add_header X-XSS-Protection \"1; mode=block\";\n\u0026nbsp;\u0026nbsp;add_header X-Content-Type-Options \"nosniff\";\n\n\u0026nbsp;\u0026nbsp;index index.php;\n\n\u0026nbsp;\u0026nbsp;charset utf-8;\n\n\u0026nbsp;\u0026nbsp;location / {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;try_files $uri $uri/ /index.php?$query_string;\n\u0026nbsp;\u0026nbsp;}\n\n\u0026nbsp;\u0026nbsp;location = /favicon.ico { access_log off; log_not_found off; }\n\u0026nbsp;\u0026nbsp;location = /robots.txt\u0026nbsp;{ access_log off; log_not_found off; }\n\n\u0026nbsp;\u0026nbsp;error_page 404 /index.php;\n\n\u0026nbsp;\u0026nbsp;location ~ \\.php$ {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;fastcgi_pass app:9000;\u0026nbsp;\u0026nbsp;// 書き換え\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;include fastcgi_params;\n\u0026nbsp;\u0026nbsp;}\n\n\u0026nbsp;\u0026nbsp;location ~ /\\.(?!well-known).* {\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;deny all;\n\u0026nbsp;\u0026nbsp;}\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003eroot\u003c/code\u003e \u003c/li\u003e\u003c/ul\u003e\u003cp\u003eリクエストのルートディレクトリです。\u003cbr\u003e\u003ccode\u003eroot /app/public;\u003c/code\u003e と書いたので、 \u003ccode\u003elocalhost:8081\u003c/code\u003e（docker-compose.ymlで設定したポート番号）にアクセスすると \u003ccode\u003e/app/public\u003c/code\u003eを見に行きます。   \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003efastcgi_pas\u003c/code\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eFastCGIサーバーのアドレスです。\u003cbr\u003e※FastCGI：Webサーバ上で動くプログラムを一度起動したらしばらく待機させることによって、プログラムの開始と終了にかかる手間を減らし、動きを速くしたりWebサーバの負荷を軽減することができる仕組み。\u003cbr\u003e\u003ccode\u003eapp:9000;\u003c/code\u003e と書いたので、appコンテナの9000番ポートを指定しています。  \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf271decc8d\"\u003e nginxコンテナを起動する\u003c/h2\u003e\u003cp\u003enginxのコンテナの準備が出来たので、また実際に起動してみます。\u003cbr\u003e\u003cbr\u003edocker-sompose.ymlのあるディレクトリで以下のコマンドを実行します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose up -d --build\n\n$ docker-compose ps\nNAME\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;COMMAND\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;SERVICE\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;STATUS\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;PORTS\ndocker_sample-app-1\u0026nbsp;\u0026nbsp;\"docker-php-entrypoi…\"\u0026nbsp;\u0026nbsp;app\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;9000/tcp\ndocker_sample-web-1\u0026nbsp;\u0026nbsp;\"/docker-entrypoint.…\"\u0026nbsp;\u0026nbsp;web\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;0.0.0.0:8081-\u0026gt;80/tcp\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eapi（PHPのコンテナ）、web（nginxのコンテナ）の2つが起動できました。\u003cbr\u003e\u003cbr\u003eまたdocker_sample-web-1の \u003ccode\u003ePORTS\u003c/code\u003e が \u003ccode\u003e0.0.0.0:8081-\u0026gt;80/tcp\u003c/code\u003e となっており、ホスト上の8081番ポートをコンテナの80番ポートへ割り当てられていることも確認できます。   \u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h8f15037b6a\"\u003e コンテナの動作確認\u003c/h3\u003e\u003cp\u003e\u003cbr\u003enginxのバージョンを確認します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec web nginx -v\nnginx version: nginx/1.20.2\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eコンテナの中に入ってみます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec web bash\nOCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: \"bash\": executable file not found in $PATH: unknown\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eするとエラーになりました。\u003cbr\u003eAlpineをベースとすると \u003ccode\u003ebash\u003c/code\u003e は使えず、 \u003ccode\u003eash\u003c/code\u003e や \u003ccode\u003esh\u003c/code\u003e は使えるようです。    \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec web ash\n[web]:/ $ pwd\n/\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e無事コンテナの中に入れました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h88903227dd\"\u003e webサーバーとしての動作確認\u003c/h3\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e リクエストに対してファイルを返しブラウザで表示できる\u003c/li\u003e\u003cli\u003e nginxのコンテナからPHPのコンテナへphpを実行させることができる\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e上記2点を確認します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ mkdir src/public\n$ touch src/public/test.php\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003etest.phpを以下のように編集します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;?php\u0026nbsp;\n\necho 'test.phpです';\nphpinfo();\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003ccode\u003ehttp://localhost:8081/test.php\u003c/code\u003e にアクセスすると以下のように表示され、webサーバーが正しく動作していることが確認できます。  \u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/b84369391f704cafb9636049a0ac8e40/testphp.jpeg\" alt=\"\"\u003e\u003cbr\u003e試しに作成したファイルは不要なので消しておきます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ rm -rf src/*\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h92f102c3c7\"\u003e MySQLのコンテナ（データベース）\u003c/h1\u003e\u003cp\u003eデータベースのMySQLコンテナを作成します。\u003cbr\u003e\u003cbr\u003e以下の流れで説明します。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e docker-compose.ymlへの記述\u003c/li\u003e\u003cli\u003e MySQLコンテナ用のDockerfile\u003c/li\u003e\u003cli\u003e MySQLコンテナ用の設定ファイル（my.conf）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h6d7ad88963\"\u003e docker-compose.yml（MySQL）\u003c/h2\u003e\u003cp\u003e既に作成しているdocker-compose.ymlに、MySQLのコンテナについての部分を追記します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eservices:\n\t\n// 中略\n\n\u0026nbsp;db:\u0026nbsp;\u0026nbsp;// サービス名\n\u0026nbsp;\u0026nbsp;build:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;context: .\n\u0026nbsp;\u0026nbsp;\u0026nbsp;dockerfile: ./docker/db/Dockerfile\n\u0026nbsp;\u0026nbsp;ports:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- 3306:3306\n\u0026nbsp;\u0026nbsp;environment:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;MYSQL_DATABASE: database\n\u0026nbsp;\u0026nbsp;\u0026nbsp;MYSQL_USER: user\n\u0026nbsp;\u0026nbsp;\u0026nbsp;MYSQL_PASSWORD: password\n\u0026nbsp;\u0026nbsp;\u0026nbsp;MYSQL_ROOT_PASSWORD: password\n\u0026nbsp;\u0026nbsp;\u0026nbsp;TZ: 'Asia/Tokyo'\n\u0026nbsp;\u0026nbsp;volumes:\n\u0026nbsp;\u0026nbsp;\u0026nbsp;- mysql-volume:/var/lib/mysql\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\nvolumes:\n\u0026nbsp;mysql-volume:\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003ebuild:\u003c/code\u003e ・ \u003ccode\u003eports:\u003c/code\u003e   \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;既出の通りです。\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003eenviroment:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003cbr\u003e\u0026nbsp;\u0026nbsp;環境変数の設定です。\u003cbr\u003e\u0026nbsp;\u0026nbsp;※名前やDB名・ユーザー名・パスワードは好きなものを設定します。\u003cbr\u003e\u0026nbsp;\u0026nbsp;※実際のプロジェクト管理では、環境変数は \u003ccode\u003e.env\u003c/code\u003e に書いて \u003ccode\u003e.gitignore\u003c/code\u003e にするなどして、重要な情報が公開されないようにします。   \u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e MYSQL_DATABASE：DB名\u003c/li\u003e\u003cli\u003e MYSQL_USER：ユーザー名\u003c/li\u003e\u003cli\u003e MYSQL_PASSWORD：パスワード\u003c/li\u003e\u003cli\u003e MYSQL_ROO\u003cem\u003eROOT\u003c/em\u003eWORD：ルート権限のパスワード\u003c/li\u003e\u003cli\u003e TZ：時間設定（Time Zone）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u003c/p\u003e\u003cul\u003e\u003cli\u003e \u003ccode\u003evolumes:\u003c/code\u003e  \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u0026nbsp;\u0026nbsp;考え方はPHPやnginxのコンテナ同様ですが、先ほどまではホスト側のディレクトリを書いていたところに \u003ccode\u003emysql-volume\u003c/code\u003e と書いています。  \u003cbr\u003e\u0026nbsp;\u0026nbsp;これにより `mysql-colume` という名前で作成した\u003cstrong\u003e名前付きボリューム\u003c/strong\u003eとコンテナ内を紐づけています。 \u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h755cef0747\"\u003e Docker Volume\u003c/h3\u003e\u003cp\u003e\u0026nbsp;\u003ccode\u003eVolume\u003c/code\u003e  とは、\u003cstrong\u003eコンテナを破棄してもデータを永続的に保存できる\u003c/strong\u003eように、コンテナ外に提供されているデータの保存領域です。 \u003cbr\u003eDockerの管理下でホスト上にストレージ領域を確保しており、Linux なら \u003ccode\u003e/var/lib/docker/volumes/\u003c/code\u003e以下にあります。  \u003cbr\u003e参考記事：\u003ca href=\"unsafe:Volume\"\u003eDocker、ボリューム(Volume)について真面目に調べた - Qiita\u003c/a\u003e \u003cbr\u003e\u003cbr\u003e\u0026nbsp;\u003cstrong\u003eなぜVolumeが必要なのか？\u003c/strong\u003e \u003cbr\u003eコンテナが起動している間はDBのレコードは保存された状態が続きますが、例えば以下のようなコマンドでコンテナを新しく作り直したとするとデータベースの情報はゼロに戻ってしまいます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// コンテナ削除\n$ docker-compose down\n\n// コンテナ起動\n$ docker-compose up -d\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこれでは困るのでコンテナを破棄してもデータを残したい、、、というときにVolumesを使ってデータの永続化を行います。\u003cbr\u003e\u003cbr\u003e※ボリュームには名前付きボリュームと匿名ボリュームがありますが、通常は管理しやすい名前付きボリュームを使うと良いかと思います。\u003cbr\u003e\u003cbr\u003e名前付きボリュームを作成する場合は、データの永続化対象のコンテナに対して \u003ccode\u003evolumes:\u003c/code\u003e オプションでバインドマウントを行うだけでなく、以下のようにdocker-compose.ymlのトップレベルでボリューム名を定義します。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003evolumes:\n\u0026nbsp;- mysql-volume:\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h7541a8019d\"\u003e Dockerfile（MySQL）\u003c/h2\u003e\u003cp\u003e作成するDockerfileの全文はこちらです。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eFROM mysql:8.0\n\nCOPY ./docker/db/my.cnf /etc/my.cnf\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e内容を簡単にまとめると、\u003c/p\u003e\u003cul\u003e\u003cli\u003e 公式のMySQLイメージをベースイメージに使用\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e[Mysql - Official Image | Docker Hub](https://hub.docker.com/_/mysql)\u003c/p\u003e\u003cul\u003e\u003cli\u003e MySQLの設定ファイル（my.cnf）をコンテナ内にバインドマウント\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e※ここで使用しているイメージではM1 Macでは動作しないという情報が見られました。どうやらOracleのMySQLチームがメンテしている \u003ccode\u003emysql/mysql-server\u003c/code\u003e のイメージだと動作するようです。  \u003cbr\u003e\u003ca href=\"https://hub.docker.com/r/mysql/mysql-server\" target=\"_blank\" rel=\"noopener noreferrer\"\u003emysql-server\u0026nbsp;| Docker Hub\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h1fb4ed6e13\"\u003e 設定ファイル（my.conf）\u003c/h2\u003e\u003cp\u003e\u003ccode\u003e./docker/db/my.cnf\u003c/code\u003eを作成します。  \u003cbr\u003e\u003cbr\u003e色んな記事で作成されているmy.cnfを参考にさせていただきながら書きました。\u003cbr\u003e参考記事：\u003ca href=\"https://it-blue-collar-dairy.com/mysqlondocker-compose/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【Docker】docker-composeでmysqlのコンテナを立てる\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e 文字コード\u003c/li\u003e\u003cli\u003e タイムゾーン\u003c/li\u003e\u003cli\u003e ログ\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eの設定を行っています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e[mysqld]\n# character\ncharacter_set_server = utf8mb4\ncollation_server = utf8mb4_0900_ai_ci\n\n# timezone\ndefault-time-zone = SYSTEM\nlog_timestamps = SYSTEM\n\n# Error Log\nlog-error = mysql-error.log\n\n# Slow Query Log\nslow_query_log = 1\nslow_query_log_file = mysql-slow.log\nlong_query_time = 1.0\nlog_queries_not_using_indexes = 0\n\n# General Log\ngeneral_log = 1\ngeneral_log_file = mysql-general.log\n\n[mysql]\ndefault-character-set = utf8mb4\n\n[client]\ndefault-character-set = utf8mb4\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h067ee63297\"\u003e MySQLコンテナを起動する\u003c/h2\u003e\u003cp\u003eMySQLのコンテナの準備が出来たので、また実際に起動してみます。\u003cbr\u003e\u003cbr\u003edocker-sompose.ymlのあるディレクトリで以下のコマンドを実行します。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose up -d --build\n\n$ docker-compose ps\nNAME\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;COMMAND\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;SERVICE\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;STATUS\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;PORTS\ndocker_sample-app-1\u0026nbsp;\u0026nbsp;\"docker-php-entrypoi…\"\u0026nbsp;\u0026nbsp;app\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;9000/tcp\ndocker_sample-db-1\u0026nbsp;\u0026nbsp;\"docker-entrypoint.s…\"\u0026nbsp;\u0026nbsp;db\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;0.0.0.0:3306-\u0026gt;3306/tcp\ndocker_sample-web-1\u0026nbsp;\u0026nbsp;\"/docker-entrypoint.…\"\u0026nbsp;\u0026nbsp;web\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;running\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;0.0.0.0:8081-\u0026gt;80/tcp\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eapi（PHPのコンテナ）、web（nginxのコンテナ）、db（MySQLのコンテナ）の3つが起動できました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h42e7c9d39f\"\u003eコンテナの動作確認\u003c/h3\u003e\u003cp\u003eMySQLのバージョンを確認します。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker compose exec db mysql -V\nmysql\u0026nbsp;Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e※この後Laravelのプロジェクトを作成したら、このDBとLaravelを接続します。\u003cbr\u003eそしてマイグレーションを行ってDBにテーブルを作成してから、MySQLにログインしてDBを使う動作確認をしたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"hd865058a4e\"\u003e Laravelのインストール\u003c/h1\u003e\u003ch2 id=\"h6742e995c9\"\u003e Laravelプロジェクトの作成\u003c/h2\u003e\u003cp\u003e\u003cbr\u003eLEMP環境が構築できたので、Laravelのアプリケーションを作っていきます。\u003cbr\u003e\u003cbr\u003eappコンテナに入り、Laravelをインストールします。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker compose exec app bash\n[app]:/app$ composer create-project --prefer-dist \"laravel/laravel=8.*\" .\n[app]:/app$ php artisan -v\nLaravel Framework 8.81.0\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eコンテナ内の/app配下にLaravelのプロジェクトが新規作成され、ホスト側の/src配下にも同じくLaravelのプロジェクトが出来ました。\u003cbr\u003e\u003cbr\u003e\u003ccode\u003elocalhost:8081\u003c/code\u003eにアクセスして、ブラウザでもLaravelのウェルカムページが表示できることを確認します。  \u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6328bcf6dfe64db7aff89f42adf30e00/laravel.jpeg\" alt=\"\"\u003e\u003c/p\u003e\u003ch2 id=\"h33b0e81c46\"\u003e DB接続\u003c/h2\u003e\u003cp\u003eappコンテナ（Laravel）からdbコンテナ（MySQL）へ接続する設定を行います。\u003cbr\u003e\u003cbr\u003eLaravelではデータベースへの接続設定を \u003ccode\u003e.env\u003c/code\u003e ファイルに定義しているので、 \u003ccode\u003e/src/.env\u003c/code\u003e のDBの部分を以下のように修正します。   \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eDB_CONNECTION=mysql\nDB_HOST=db\u0026nbsp;\u0026nbsp;// MySQLコンテナのサービス名\nDB_PORT=3306\nDB_DATABASE=database\nDB_USERNAME=root\nDB_PASSWORD=passwor\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e  \u003ccode\u003eDB_HOST\u003c/code\u003eはMySQLコンテナのサービス名を指定します。 \u003c/li\u003e\u003cli\u003e その他の項目もMySQLコンテナで設定した値（今回はdocker-compose.ymlのenviromentで定義）と同じ値を指定します。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eDBに接続出来ているか確認する為、以下のコマンドを実行してマイグレーションを行います。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker compose exec app bash\n[app]:/app$ php artisan migrate\nMigration table created successfully.\nMigrating: 2014_10_12_000000_create_users_table\nMigrated:\u0026nbsp;2014_10_12_000000_create_users_table (55.42ms)\nMigrating: 2014_10_12_100000_create_password_resets_table\nMigrated:\u0026nbsp;2014_10_12_100000_create_password_resets_table (51.11ms)\nMigrating: 2019_08_19_000000_create_failed_jobs_table\nMigrated:\u0026nbsp;2019_08_19_000000_create_failed_jobs_table (45.12ms)\nMigrating: 2019_12_14_000001_create_personal_access_tokens_table\nMigrated:\u0026nbsp;2019_12_14_000001_create_personal_access_tokens_table (75.74ms)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf98e955142\"\u003e MySQLを使ってみる\u003c/h2\u003e\u003cp\u003eMySQLのコンテナに入ってDBを確認してみます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e$ docker-compose exec db bash\n[db]:/$ mysql -u root -p\n// パスワードを求められるので入力\n[db] mysql\u0026gt; use database;\n[db] mysql\u0026gt; show tables;\n+------------------------+\n| Tables_in_database\u0026nbsp;\u0026nbsp;\u0026nbsp;|\n+------------------------+\n| failed_jobs\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;|\n| migrations\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;|\n| password_resets\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;|\n| personal_access_tokens |\n| users\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;|\n+------------------------+\n5 rows in set (0.00 sec)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e先ほどマイグレーションを実行したので、Laravelのデフォルトで用意されているマイグレーションファイル通りにテーブルが作成されていることが確認できました。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h9b4c4b9dd7\"\u003e 最後に\u003c/h2\u003e\u003cp\u003eこれでDocker（Docker Compose）を使ったLEMP環境の構築が完了です。\u003cbr\u003e\u003cbr\u003e今回作成した環境は非常にシンプルなものなので、業務で使うとなるともっと設定を細やかに行ったり、開発環境・ステージング環境・本番環境それぞれの設定ファイルを用意して設定を切り替えたりといった作業が必要になるかと思いますが、仕組みが分かればあとは全てこの延長にあるのかなと思います。\u003cbr\u003e\u003cbr\u003eまたいずれ環境ごとの設定ファイル切り替えだったり、あとはNodeのコンテナを使ってNext.jsの環境構築もやってみたいです。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3937880ed1\"\u003e 参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://yutaro-blog.net/2021/04/29/docker-laravel-vuejs-2/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://yutaro-blog.net/2021/04/29/docker-laravel-vuejs-2/\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://yutaro-blog.net/2021/04/30/docker-laravel-vuejs-3/#index_id11\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://yutaro-blog.net/2021/04/30/docker-laravel-vuejs-3/#index_id11\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/ucan-lab/items/56c9dc3cf2e6762672f4\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com/ucan-lab/items/56c9dc3cf2e6762672f4\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"docker","createdAt":"2022-02-12T02:32:18.767Z","updatedAt":"2022-02-12T10:02:36.384Z","publishedAt":"2022-02-12T02:32:18.767Z","revisedAt":"2022-02-12T10:02:36.384Z","tag":"Docker"},{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"},{"id":"php","createdAt":"2022-01-07T13:16:36.618Z","updatedAt":"2022-02-12T02:31:46.498Z","publishedAt":"2022-01-07T13:16:36.618Z","revisedAt":"2022-01-07T13:16:36.618Z","tag":"PHP"}],"image":"docker"},{"id":"nextjs-router-query","createdAt":"2022-02-12T10:12:00.712Z","updatedAt":"2022-02-12T10:24:05.297Z","publishedAt":"2022-01-25T10:12:00.000Z","revisedAt":"2022-02-12T10:21:40.124Z","title":"Next.jsのrouter.queryでURLの動的パラメータを取得するときの注意","body":"\u003cp\u003e業務で、useEffect内でNext.jsのuseRouterを使ってクエリパラメータを取得しようとした際、意図する通りの挙動をしておらず戸惑ったので備忘録としてまとめておきます。\u003cbr\u003e\u003cbr\u003e通常\u003cstrong\u003epages/blogs/[id].tsx\u003c/strong\u003eのようなファイルにおいてAPIからデータを取得したい場合、\u003ccode\u003egetStaticPaths\u003c/code\u003e・\u003ccode\u003egetStaticProps\u003c/code\u003eを使うかと思いますが、今回は画面描画してからバックグラウンドでAPIリクエストを行ってデータ取得する必要があり、そこで見つけたのが\u003ccode\u003euseRouter\u003c/code\u003eの\u003ccode\u003erouter.query\u003c/code\u003eでした。 \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h5752334b14\"\u003e useRouterとは\u003c/h2\u003e\u003cp\u003eそもそもuseRouterとは、Next.jsが用意しているhooksの一つで、routeに関する色んな情報を持つrouterオブジェクトへのアクセスを提供するものです。\u003cbr\u003e\u003c/p\u003e\u003cblockquote\u003e アプリの関数コンポーネント内の\u003ccode\u003erouter\u003c/code\u003eオブジェクトにアクセスする場合は、\u003ccode\u003euseRouter\u003c/code\u003eフックを使用できます。   \u003cbr\u003e\u003ccode\u003euseRouter\u003c/code\u003eはReactフックです。  \u003cbr\u003e\u0026nbsp;\u003ca href=\"https://nextjs.org/docs/api-reference/next/router#userouter\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://nextjs.org/docs/api-reference/next/router#userouter\u003c/a\u003e \u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003erouterオブジェクトはいくつもの便利なメソッドやプロパティを持ちますが、その中のひとつにqueryがあります。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h6a9e501b40\"\u003e router.queryの使い方\u003c/h2\u003e\u003cp\u003e\u0026nbsp;\u003ccode\u003erouter.query\u003c/code\u003e とするだけで、オブジェクト形式で動的ルーティングの中身を取得できます。  \u003cbr\u003e\u003cbr\u003eちなみに以下の例のようにクエリパラメータが数字の場合も、string型で取得されます。\u003cbr\u003e \u003c/p\u003e\u003cpre\u003e\u003ccode\u003eimport { useRouter } from 'next/router'\n\n// 関数コンポーネント内にて\n\u0026nbsp;const router = useRouter()\n\u0026nbsp;console.log(router.query)\n\u0026nbsp;console.log(router.query.id)\n\n// 出力結果(localhost:3000/blogs/1 の場合)\n// { id: '1' }\n// 1\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h970271505b\"\u003e useEffect内でrouter.queryを使ってみる\u003c/h2\u003e\u003cp\u003e\u003ccode\u003epages/blogs/[id].tsx\u003c/code\u003eの\u003ccode\u003euseEffect\u003c/code\u003e内で\u003ccode\u003erouter.query\u003c/code\u003eを使ってみます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst router = useRouter()\n\nuseEffect(() =\u0026gt; {\n\u0026nbsp;const routeId = router.query.id\n\u0026nbsp;console.log(routeId)\n}, [])\n\n// undefined \u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e出力されたのは \u003ccode\u003eundefinde\u003c/code\u003e でした。  \u003cbr\u003e\u003cbr\u003eどうやら、router.queryの取得は\u003ccode\u003euseEffect\u003c/code\u003eの発火タイミングより後のようです。\u003cbr\u003e\u003cbr\u003e【注】ただし、チームの中には上記のコードでもundefindeにならずqueryが取れている方もいましたし、私の環境でも時によってはqueryが取れることもありました。いずれにせよ不安定なものと思われるので、以下の対処をしておくのが無難なのかなと思います。\u003cbr\u003e（ご存じの方はぜひご指導・ご指摘ください…！）\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hc1efd68684\"\u003e useEffectの依存配列にrouterを指定する\u003c/h3\u003e\u003cp\u003e依存配列に\u003ccode\u003erouter\u003c/code\u003eを入れてみました。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst router = useRouter()\u0026nbsp;\n\nuseEffect(() =\u0026gt; {\n\u0026nbsp;const routeId = router.query.id\n\u0026nbsp;console.log(routeId)\n}, [router])\n\n// 出力結果(localhost:3000/blogs/1 の場合)\n// undefined\n// 1\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eすると、一度\u003ccode\u003eundefinde\u003c/code\u003eと出た後に\u003ccode\u003equery\u003c/code\u003eが取れてコンソールに出力されました。\u003cbr\u003e\u003cbr\u003eこれで目的を果たせる場合もあるかもしれません。\u003cbr\u003e\u003cbr\u003eしかし今回私が実装したかった要件は、取得したルートパラメーターを使ったパスでAPIへリクエストを送るというものです。\u003cbr\u003eundefinedを取得してしまうと \u003ccode\u003e'/api/blogs/undefined'\u003c/code\u003eのパスにリクエストを送ってしまい、これは不都合でした。  \u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2f530575d0\"\u003e isReadyを使ってrouter情報が準備されているか判別する\u003c/h3\u003e\u003cp\u003e辿り着いたコードは以下の通りです。\u003cbr\u003e \u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst router = useRouter()\n\nuseEffect(() =\u0026gt; {\n\u0026nbsp;if (router.isReady) {\n\u0026nbsp;\u0026nbsp;const routeId = router.query.id\n\u0026nbsp;\u0026nbsp;console.log(routeId)\n\u0026nbsp;}\n}, [router])\n\n// 出力結果(localhost:3000/blogs/1 の場合)\n// 1\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003erouterオブジェクトの持つ \u003ccode\u003eisReady\u003c/code\u003e というboolean値が最適でした。  \u003cbr\u003e\u003c/p\u003e\u003cblockquote\u003e \u003ccode\u003eisReady\u003c/code\u003e：\u003ccode\u003eboolean\u003c/code\u003e　ルーターフィールドがクライアント側で更新され、使用できる状態になっているかどうか。\u003ccode\u003euseEffect\u003c/code\u003eメソッド内でのみ使用する必要があり、サーバーで条件付きでレンダリングするためには使用しないでください。    \u003cbr\u003e\u0026nbsp;\u003ca href=\"https://nextjs.org/docs/api-reference/next/router#router-object\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://nextjs.org/docs/api-reference/next/router#router-object\u003c/a\u003e \u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf6e0a9e212\"\u003e なぜundefindeが取得されていたのか\u003c/h2\u003e\u003cp\u003equeryの取得タイミングはuseEffectの発火よりも後なのだということは何となく察しましたが、どういう仕組みなのか気になります。\u003cbr\u003e\u003cbr\u003eNext.jsのドキュメントのダイナミックルーティングについての箇所に、以下のように書かれていました。\u003cbr\u003e\u003c/p\u003e\u003cblockquote\u003e Pages that are statically optimized by [Automatic Static Optimization](https://nextjs.org/docs/advanced-features/automatic-static-optimizat\u003ca href=\"https://nextjs.org/docs/advanced-features/automatic-static-optimization\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eAutomatic Static Optimization\u003c/a\u003e \u003cbr\u003e After hydration, Next.js will trigger an update to your application to provide the route parameters in the \u003ccode\u003equery\u003c/code\u003e object.  \u003c/blockquote\u003e\u003cp\u003e\u003cbr\u003ePre-renderingの間はqueryは空のオブジェクトであり、hydrationのプロセスが終わった段階でqueryオブジェクトが提供されると書いてあります。\u003cbr\u003e\u003cbr\u003egetStaticPropsやgetSererSidePropsの処理が終わるまでは、queryは空なのですね。\u003cbr\u003e\u003cbr\u003ehydrationという単語は初めて知りましたが、Next.jsの公式の図を見るとイメージは湧きました。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/a9c4b88b0bb24532bb598719b0bf4137/pre-rendering.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3937880ed1\"\u003e 参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://zenn.dev/kiyokiyoabc/articles/d3a8464367094a\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://zenn.dev/kiyokiyoabc/articles/d3a8464367094a\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/luvmini511/articles/1523113e0dec58\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://zenn.dev/luvmini511/articles/1523113e0dec58\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"}],"image":"react"},{"id":"notion-blog","createdAt":"2022-02-12T11:09:01.126Z","updatedAt":"2022-02-12T11:09:56.858Z","publishedAt":"2022-01-09T11:09:01.000Z","revisedAt":"2022-02-12T11:09:56.858Z","title":"Notion BlogをヘッドレスCMSとして、Next.jsで個人ブログを作ってみた","body":"\u003ch2 id=\"h8d027c8ed3\"\u003eはじめに\u003c/h2\u003e\u003cp\u003e年末年始1週間の自由研究として、Next.jsを使って何か作ってみたい…ということで、NotionをヘッドレスCMSとした個人ブログを作ってみました。\u003cbr\u003e\u003cbr\u003eせっかくなので制作日記として、\u003c/p\u003e\u003cul\u003e\u003cli\u003e 作ったものを紹介\u003c/li\u003e\u003cli\u003e Notion Blogについて\u003c/li\u003e\u003cli\u003e Next.js（React）を使って自分で実装した機能\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eなどまとめておきたいと思います。\u003cbr\u003e\u003cbr\u003e※ヘッドレスCMSとは…従来型のCMS（WordPress等）は入稿画面・DB・表示画面をまとめて管理するのに対し、ここから表示画面を除いたもの。ヘッドレスCMSでは、API経由で取得したコンテンツを基にフロントエンド部分は自前で実装する必要がある。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he961b4efa4\"\u003e制作物について\u003c/h2\u003e\u003cp\u003e実際に作ったものがこちらです。\u003cbr\u003e\u003ca href=\"https://hinako-blog.vercel.app/blog\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHinako Blog | My Profile\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h0d376e5d4e\"\u003e構成\u003c/h3\u003e\u003cp\u003e構成を簡単に説明すると、\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eNotion上にブログ記事を保管するDBを作り、Notionで記事を執筆\u003c/li\u003e\u003cli\u003eNext.jsのgetStaticPropsでNotionのAPIを叩いてブログコンテンツを取得\u003c/li\u003e\u003cli\u003eNext.jsでレスポンスを成形してビューに表示\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eという感じです。\u003cbr\u003e\u003cbr\u003eNotionのAPIを叩いてレスポンスを成形する部分は、Notion Blog（詳しくは後述）というOSSのテンプレートをベースに使わせていただきました。\u003cbr\u003eデプロイはVercelで行いました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"had81f6e58c\"\u003e実装した機能\u003c/h3\u003e\u003cul\u003e\u003cli\u003eMITライセンスのOSSとして公開されているNotion Blog（Vercel社のJJ Kasperさん作）をベースに使用\u003c/li\u003e\u003cli\u003eDBにcategoryのカラムを追加し、NotionのAPIからのレスポンスの成形やビューへの表示をカスタマイズ\u003c/li\u003e\u003cli\u003eフロント側での「カテゴリーの選択」「投稿した月の選択」「フリーキーワードによる検索」によるリアルタイム検索機能\u003c/li\u003e\u003cli\u003e記事のカテゴリーに応じてReact iconsでアイコンを表示する\u003c/li\u003e\u003cli\u003eCSS Modules\u003c/li\u003e\u003cli\u003eUIパーツのコンポーネント化\u003c/li\u003e\u003cli\u003epropsやstateの値により、条件付きレンダリングを行ったりCSSを動的に切り替える\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h5043d0744e\"\u003eNotion Blogについて\u003c/h2\u003e\u003cp\u003eベースに使用したNotion Blogというのは、NotionのAPIを叩いてNotionからコンテンツを取得しNext.jsでビューを作ったテンプレートです。\u003cbr\u003e\u003cbr\u003eGitHub：\u003ca style=\"color:#4aac00\" href=\"https://github.com/ijjk/notion-blog\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://github.com/ijjk/notion-blog\u003c/a\u003e\u003cbr\u003e公式のサンプルページ：\u003ca style=\"color:#4aac00\" href=\"https://notion-blog.vercel.app/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://notion-blog.vercel.app/\u003c/a\u003e\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/007ccf5040c24c7dad664d036d40997e/notion-blog.png\" alt=\"\"\u003e\u003cbr\u003eこんな感じでシンプルで綺麗なUIをしています。\u003cbr\u003eコードをいじったりしなくても、DeployボタンからVercelに連携し、NotionのDBのID・Tokenを環境変数に設定してVercelでデプロイするだけで、このテンプレート通りの個人ブログが出来るというものです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h0893011e20\"\u003eNotion Blogでブログコンテンツを取得する仕組み\u003c/h3\u003e\u003cp\u003eあらかじめNotionで記事を登録するDB（Page, Slug, Published, Date, Authorsの5つの要素を持つインラインテーブル）を作り、このテーブルに記事を入れておきます。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/2df6468fd6054e47b8f1f212f7e5fa3a/table.png\" alt=\"\"\u003e\u003cbr\u003e画像引用：\u003ca style=\"color:#4aac00\" href=\"https://github.com/ijjk/notion-blog#manually-creating-the-table\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://github.com/ijjk/notion-blog#manually-creating-the-table\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eNotion Blogのソースを見ると、Next.jsのgetStaticPropsでNotionのAPIを叩いてデータベースのコンテンツを取得しています。\u003cbr\u003e使っているのは非公式のAPIで「\u003ca style=\"color:#4aac00\" href=\"https://www.notion.so/api/v3%E3%80%8D\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://www.notion.so/api/v3」\u003c/a\u003e\u0026nbsp;というエンドポイントを叩いているようです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h814caf386c\"\u003eNotion Blogを使った理由\u003c/h3\u003e\u003cp\u003eNotion 公式のAPI（ベータ版）も2021年5月に公開され、OSSとして公開されているテンプレートで公式APIが使われているものもある中で、Notion Blogを選んだ理由は以下の通りです。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e公式のNotion APIはコードブロックに対応していない（もしアップデートを見落としていたらすみません。）\u003c/li\u003e\u003cli\u003e公式のNotion APIでは、コンテンツを取得するだけでなくAPIを使ってNotionのDBへ追加・更新・削除する機能もあるが、これらの機能は不要と思った。\u003c/li\u003e\u003cli\u003eNotion Blogでは、決められた5つのカラムを持つテーブルをNotionで作るだけでテンプレート通りに表示される。簡単！はやい！\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003eざっくりいうと、\u003cstrong\u003eとりあえず最速・簡単な方法で小さく作って、残った時間でカスタマイズしてみよう\u003c/strong\u003eという感じです。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2c8c89326b\"\u003eNotion Blogのセットアップ方法\u003c/h3\u003e\u003cp\u003eセットアップ方法は、公式サンプルのページに動画付きで分かりやすく書かれているので省略します。\u003cbr\u003e\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://notion-blog.vercel.app/blog/my-first-post\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://notion-blog.vercel.app/blog/my-first-post\u003c/a\u003e\u003cbr\u003eDeployボタンからコードを目にすることも無くデプロイすることも出来るようですが、今回はAPIから受け取るレスポンスの成形やUIはカスタマイズする前提だったので、git cloneして編集したうえでデプロイしました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h1d7f1fe064\"\u003eNotion Blogを使ってみて\u003c/h3\u003e\u003cul\u003e\u003cli\u003eテンプレートのコードを読んで\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eAPIへのリクエストを行うメソッドのファイル切り分け・ディレクトリ構成が分かりやすく、カスタマイズしやすかったです。\u003cbr\u003eNext.jsのダイナミックルーティングを使う際に、ヘッダのメタ情報を出しわける書き方も初めて見て勉強になりました。\u003cbr\u003e\u003cbr\u003eここからは、ブログ記事をブラウザで表示した時の見え方についてです。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e画像・動画の挿入\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e簡単に挿入できるものの、画像のアスペクト比が若干おかしくなっていました…。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/be464a17a7d74abe9afdcd84d268199b/%E7%94%BB%E5%83%8F%E5%8B%95%E7%94%BB.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e動画はNotionで見たまま反映され、再生速度の調整まで出来るのでこれはスゴイ！感激でした。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/f1847b01ffc84d62a89559fd86c389ce/%E5%8B%95%E7%94%BB.png\" alt=\"\"\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eコードブロックの挿入\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e公式APIでは対応していないコードブロックも、非公式APIを使っているNotion Blogでは表示できました。\u003cbr\u003e文字色のCSSなんかも自由にカスタマイズできます。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/20ed291c84c841a8a67807a6c96c2514/%E3%82%B3%E3%83%BC%E3%83%89%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003eただしNotion Blogで使っているのは非公式APIなので、\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e動作が不安定（実際、稀にコンテンツが取得できないという事が起こりました。）\u003c/li\u003e\u003cli\u003e今後このAPIが使えなくなる可能性もある\u003c/li\u003e\u003cli\u003e\u003cbr\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eというデメリットはあると思われます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hafa005fc12\"\u003e自分で実装した機能\u003c/h2\u003e\u003cp\u003e自分で追加実装した機能や、その他使用技術について書いていきます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h604b8042b8\"\u003e検索機能\u003c/h3\u003e\u003cp\u003eカテゴリーで絞り込み・投稿月で絞りこみ・フリーキーワード検索の機能を実装しました。\u003cbr\u003e\u003cbr\u003eページ上部\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/5d8f8a862a3344fc8fe16447103ba0f6/%E3%83%9A%E3%83%BC%E3%82%B8%E4%B8%8A%E9%83%A8.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003eフッター\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/2cd3e007541943cb82954cf062c40479/%E3%83%95%E3%83%83%E3%82%BF%E3%83%BC.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003e【実装手順】\u003cbr\u003e①　APIから取得したブログコンテンツに存在するカテゴリーを配列に格納して、記事が存在する分のカテゴリーボタンを表示。投稿月についても同様。\u003cbr\u003e②　ボタンを押したときや検索欄に入力をした際に発火する絞り込み処理を実装。\u003cbr\u003e\u003cbr\u003eフロント側で保持している記事データに対して絞り込みを行い表示を切り替える機能なので、リロードなく瞬時に表示が切り替わります。\u003cbr\u003e検索機能の書き方は非常に勉強になったので、別記事にまとめようと思います。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hc06cf54a32\"\u003eReact Icons\u003c/h3\u003e\u003cp\u003e記事のカテゴリーに応じてアイコンを表示しました。\u003cbr\u003e\u003cimg src=\"https://images.microcms-assets.io/assets/bb9889e81cb24134954870eb1f2ba680/6d8cb6b91d2740649bcd296b5d054bf6/react-icon.png\" alt=\"\"\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003eアイコンといえばFontAwesomeと思っていましたが、React用のライブラリがありました。\u003cbr\u003e\u003ca href=\"https://react-icons.github.io/react-icons/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eReact Icons\u003c/a\u003e\u003cbr\u003e\u003cbr\u003eこのライブラリをインストールすると、Font Awesome や Material、Typicons、Codicons（VSCode のアイコン）など色んな種類のアイコンを簡単に利用することができます。\u003cbr\u003e使い方は以下の記事を参考にさせて頂きました。\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/taichifukumoto/articles/how-to-use-react-icons\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eReact でアイコンを使うなら React Icons がおすすめ\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h5a4cb7eb5d\"\u003eCSS Modules\u003c/h3\u003e\u003cp\u003eCSSは、Notion BlogでCSS Modulesが使われていたので、そのままCSS Modulesを使いました。\u003cbr\u003e\u003cstrong\u003e\u003ccode\u003e.module.css\u003c/code\u003e\u003c/strong\u003e\u0026nbsp;で定義したクラス名がそのまま付与されるのではなく、実際はユニークなクラス名が自動的に生成されて付与されることも検証ツールで確認できて、勉強になりました。\u003cbr\u003e\u003cbr\u003eReactのプロジェクト下でのCSSといえば代表的な選択肢は、CSS Modules、styled-component、Tailwindあたりなのかと思いますが、それぞれの違いやメリットデメリットについては正直勉強不足です。。\u003cbr\u003e\u003ca href=\"https://kenzoblog.vercel.app/posts/css-manage\" target=\"_blank\" rel=\"noopener noreferrer\"\u003estyled-components, CSS Modules について調べたのでまとめる\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e業務ではTailwindを使っており、今回初めてCSS Modulesを使い、両者の個人的な感想を書いておきます。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eTailwind\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eファイルの行き来をせずスタイルを確認できて便利。小規模なプロダクトに向いていそう。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eCSS Modules\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eコンポーネント単位でスタイルをまとめるという思想なので、コンポーネント指向のReactとの相性は良い（のだと思う）。\u003cbr\u003eスタイルの共通化がしやすくスッキリ整理整頓されている感じで、使いやすかった。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hf32963c38a\"\u003e全体の感想\u003c/h2\u003e\u003cp\u003e長くなってきたので細かい実装については書きませんが、「実装したい機能がある→どうやったら実現できるか調べる」というプロセスでReact・JavaScriptの書き方も色々勉強になりました。\u003cbr\u003e\u003cbr\u003e今回NotionをヘッドレスCMSとして使ってみて、フロントエンドを自前で作るという事は見た目を自由に作れるだけでなく、SG・SSRを使って機能性の高いサイトを作ることが出来ることが大きなメリットだと感じました。\u003cbr\u003e先輩に良いアドバイスもいただいたので、今度はまた他のヘッドレスCMSのサービスを使って個人ブログを作ってみたいなと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"unsafe:[object Object]\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHome | My Notion Blog\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/st43/articles/7982e6d371f8b8#notion-api%E3%81%A7%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%93%E3%81%A8%E4%B8%80%E8%A6%A7\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e現在のNotion API（2021/7/13）で何がどこまでできるか\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://zenn.dev/st43/articles/9a714916c50b80#%E3%81%BE%E3%81%A8%E3%82%81\" target=\"_blank\" rel=\"noopener noreferrer\"\u003enotion-blogで無料の個人ブログをつくってみました\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"}],"image":"notion"},{"id":"react-typescript","createdAt":"2022-02-12T10:20:56.912Z","updatedAt":"2022-02-17T13:33:23.975Z","publishedAt":"2022-01-16T10:20:56.000Z","revisedAt":"2022-02-12T10:21:12.181Z","title":"React×TypeScript　基本の型定義","body":"\u003ch2 id=\"h04bc4be39a\"\u003e はじめに\u003c/h2\u003e\u003cp\u003e業務でフロント側はReact（Next.js）, TypeScriptを使っているのですが、配属当初の私はReactにもTypeScriptにも触れたことが無く、何が分からないのか分からない状態でした。\u003cbr\u003e\u003cbr\u003eTypeScriptの基礎を学んでもReact特有の型定義があり戸惑いましたが、ようやく理解して書けるようになって来たな…ということで、辞書代わりにまとめておきます。\u003cbr\u003e（誤りのご指摘・アドバイスがあればぜひお願いします！）\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h2e4995e418\"\u003e 基礎編\u003c/h1\u003e\u003cp\u003eまずは基本の型定義を一通り挙げます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hd817cee2b9\"\u003e 関数コンポーネント\u003c/h2\u003e\u003cp\u003e関数コンポーネントでは、普通の関数と同じように引数（props）に型付けします。\u003cbr\u003e\u003cbr\u003e戻り値はJSX要素を返せば型推論されるので、明らかな場合は型付けしなくてOKです。\u003cbr\u003e\u003cbr\u003e※以下の例では、propsは分割代入の書き方で受け取るものとします。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h480940b7cc\"\u003e 引数（props）なしの場合\u003c/h3\u003e\u003cp\u003epropsを受け取らない場合は、JavaScriptで記述するときと変わりません。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// ノーマルの関数コンポーネント（引数なしの場合）\nconst App = () =\u0026gt; \u0026lt;div\u0026gt;なまえ\u0026lt;/div\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h40e5e6f6fd\"\u003e ひとつのpropsを受け取る\u003c/h3\u003e\u003cpre\u003e\u003ccode\u003e// 引数に型付けする\nconst App = ({ name }: { name: string }) =\u0026gt; \u0026lt;div\u0026gt;{name}\u0026lt;/div\u0026gt;\n\n// 型エイリアスを使っても良い\ntype Props = { name: string }\nconst App = ({ name }: Props) =\u0026gt; \u0026lt;div\u0026gt;{name}\u0026lt;/div\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e型注釈を直接つけても、型エイリアスを使ってもOKです。\u003cbr\u003e\u003cbr\u003eプロジェクト内で合わせておけば良いかと思います。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h2ac392abf5\"\u003e 複数のpropsを受け取る\u003c/h3\u003e\u003cp\u003epropsを複数受け取る場合は、型注釈を直接つけるよりも型エイリアスを付けた方が分かりやすいでしょう。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// 引数が複数なら、型エイリアスを使う方が見やすい\ntype Props = {\n\u0026nbsp;name: srting\n\u0026nbsp;onClick: () =\u0026gt; void\n\u0026nbsp;children: ReactNode\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h5f171d61d9\"\u003e propsの型いろいろ\u003c/h3\u003e\u003cp\u003e以下のように色々な型の値をpropsとして受け取ることができます。\u003cbr\u003eここはほとんどTypeScriptの基本通りです。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// propsとして受け取る値の型定義色々\ntype Props = {\n\u0026nbsp;str: string\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// 文字列\n\u0026nbsp;num: number\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// 数値\n\u0026nbsp;bool: boolean\u0026nbsp;\u0026nbsp;\u0026nbsp;// 真偽値\n\u0026nbsp;strArr: string[]\u0026nbsp;\u0026nbsp;// 配列\n\u0026nbsp;obj: {\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// オブジェクト\n\u0026nbsp;\u0026nbsp;str: string\n\u0026nbsp;}\n\u0026nbsp;objArr: {\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// オブジェクトの配列\n\u0026nbsp;\u0026nbsp;str: string\n\u0026nbsp;\u0026nbsp;num: number\n\u0026nbsp;}[]\n\u0026nbsp;func: () =\u0026gt; void\u0026nbsp;\u0026nbsp;// 関数\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"ha7733746f8\"\u003e children\u003c/h3\u003e\u003cp\u003echildrenはコンポーネントのタグで囲った子要素をpropsとして受け取るときに使います。\u003cbr\u003e\u003cbr\u003eよく使うのはReactNodeで、これはコンポーネントタグで囲ったJSX要素をまるっと受け取る場合に使います。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// 共通レイアウトのコンポーネント\nconst MainLayout = ({ children }: { children: React.ReactNode }) =\u0026gt; {\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;Header /\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;{children}\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;Footer /\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026lt;/\u0026gt;\n\u0026nbsp;)\n}\n\n// 呼び出し側\nconst MenuPage = () =\u0026gt; {\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;MainLayout\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;// この中にページの内容を書く\n\u0026nbsp;\u0026nbsp;\u0026lt;/MainLayout\u0026gt;\n\u0026nbsp;)\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eもし特定の文字列や数値しか受け取らないというような場合は、ReactNodeではなく特定の型に制限することもできます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// Buttonコンポーネント\nconst Button = ({ children }: { children: string }) =\u0026gt; {\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;button\u0026gt;{children}\u0026lt;/button\u0026gt;\n\u0026nbsp;)\n}\n\n// 呼び出し側\nconst App = () =\u0026gt; {\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;\u0026gt;\n// フォームの記述があるとする\n\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;Button\u0026gt;送信\u0026lt;/Button\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;Button\u0026gt;戻る\u0026lt;/Button\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026lt;/\u0026gt;\n\u0026nbsp;)\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eちなみにReactNodeは以下の通りのUnion型で定義されています。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype ReactNode = ReactChild | ReactFragment | ReactPortal | boolean | null | undefined;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h31df23c0b3\"\u003e propsのデフォルト値を指定する\u003c/h3\u003e\u003cp\u003eコンポーネントの利用箇所ごとにpropsに渡す値を指定してもよいのですが、デフォルト値を指定することもできます。\u003cbr\u003eよく指定される値がある時や、値が無かった場合の値を決めておきたい場合に有効です。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst Name = ({ name = \"ゲスト\" }: { name?: string }) =\u0026gt; \u0026lt;div\u0026gt;{name}さん\u0026lt;/div\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h5be2f009d7\"\u003e オプショナルなprops（undefined許容）\u003c/h3\u003e\u003cp\u003e\u003ccode\u003e?\u003c/code\u003e を付けることでオプショナルな型定義が出来ます。  \u003cbr\u003e以下のように書いた場合、name・emailの型は\u003ccode\u003estring | undefined\u003c/code\u003eとなります。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype Props = {\n\u0026nbsp;name?: string\n\u0026nbsp;email?: string\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eこの場合はundefinedの可能性を考慮してpropsの初期値を設定するか、値の有無による条件分岐を行います。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// nameは初期値を設定、emailはpropsの値が渡された場合のみ表示する\nconst Button = ({ name = 'ゲスト', email }: Props) =\u0026gt; {\n\u0026nbsp;return (\n\u0026nbsp;\u0026nbsp;\u0026lt;div\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;{name}さん\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;{email \u0026amp;\u0026amp; (\n\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026lt;p\u0026gt;email:{email}\u0026lt;/p\u0026gt;\n\u0026nbsp;\u0026nbsp;\u0026nbsp;)}\n\u0026nbsp;\u0026nbsp;\u0026lt;/div\u0026gt;\n\u0026nbsp;)\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h61a1261837\"\u003e 戻り値の型付け\u003c/h3\u003e\u003cp\u003eJSX要素を返せば型を指定していなくても推論してくれますが、明示しておけば正しい値が返されなかった場合エラーを表示してくれます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst App = ({ name }: { name: string }): JSX.Element =\u0026gt; \u0026lt;div\u0026gt;{name}\u0026lt;/div\u0026gt;;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h40fc68507d\"\u003e React.FC / VFC\u003c/h3\u003e\u003cp\u003eReact.FC / VFC については、TypeSctriptを導入するのであれば不要と考えられるのでここでは取り上げません。（今の私の業務では使っていないのですが、もしなにか誤りやアドバイスがあれば是非ご教授ください…！）\u003cbr\u003e参考記事：\u003ca href=\"https://kray.jp/blog/dont-have-to-use-react-fc-and-react-vfc/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【検証】React.FC と React.VFC はべつに使わなくていい説\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h2e72b92d37\"\u003e useState　状態変数の型\u003c/h2\u003e\u003ch3 id=\"hde697c111e\"\u003e 型推論に任せる\u003c/h3\u003e\u003cp\u003euseStateフックでは初期値を与えれば状態変数の型を推論してくれます。\u003cbr\u003eなので極力初期値を与えて、推論させるようにします。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// プリミティブ値\nconst [name, setName] = useState(\"\")\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// string型\nconst [count, setCount] = useState(0)\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// number型\nconst [isChecked, setIsCheked] = useState(false)\u0026nbsp;\u0026nbsp;// boolean型\n\n// 配列\nconst [colors, setColors] = useState([\"red\", \"blue\"])\u0026nbsp;\u0026nbsp;// string型の配列\nconst [numbers, setNumbers] = useState([1, 2, 3])\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// number型の配列\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h6b88d1350c\"\u003e ジェネリック型で指定する\u003c/h3\u003e\u003cul\u003e\u003cli\u003e 基本の指定方法\u003c/li\u003e\u003c/ul\u003e\u003cp\u003euseStateの状態変数に対して明示的に型を指定する場合は、ジェネリック型 \u003ccode\u003e\u0026lt;T\u0026gt;\u003c/code\u003e を使います。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// useStateのジェネリック型\u0026lt;T\u0026gt;に明示的に型を指定する\nconst [name, setName] = useState\u0026lt;string\u0026gt;(\"\")\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// string型\nconst [count, setCount] = useState\u0026lt;number\u0026gt;(0)\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;// number型\nconst [isChecked, setIsChecked] = useState\u0026lt;boolean\u0026gt;(false)\u0026nbsp;\u0026nbsp;// boolean型\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e 別途定義した型をジェネリック型で指定する\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e別途定義したオブジェクトを初期値にしたり、別途定義した型をジェネリック型で指定することもできます。\u003cbr\u003e（型や初期値を複数のコンポーネントで使い回す場合や情報量が多くなる場合は、別ファイルに切り出しても良いかと思います。）\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003econst initialUser = {\n\u0026nbsp;number: 1,\n\u0026nbsp;name: '名前',\n\u0026nbsp;email: 'test@mail.com'\n}\n\ntype User = {\n\u0026nbsp;number: number\n\u0026nbsp;name: string\n\u0026nbsp;email: string\n}\n\nconst [user, setUser] = useState\u0026lt;User\u0026gt;(initialUser)\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e ユニオン型でnullを含める \u003c/li\u003e\u003c/ul\u003e\u003cp\u003e値がnullの可能性があるときや、型は定めておきたいが初期値は後から決まるといった場合は、ユニオン型でnullを含めます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// nullを含む場合はユニオン型を用いる\nconst [count, setCount] = useState\u0026lt;number | null\u0026gt;(null)\u0026nbsp;\u0026nbsp;// number型もしくはnull型\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003e 型アサーションを使う\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e状態変数の初期値が決まらないけれどnullは許可しないという場合には、型アサーションを使うことができます。\u003cbr\u003e\u003cbr\u003eまず、以下の書き方ではエラーが出ます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype User = {\n\u0026nbsp;number: number\n\u0026nbsp;name: string\n\u0026nbsp;email: string\n}\n\nconst [user, setUser] = useState\u0026lt;User\u0026gt;({})\nuser[name] = 'ゲスト'\n\n// userは「空のオブジェクト型」とTypeScriptは認識するのでコンパイルエラーになる\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eそこで有効なのが型アサーションです。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype User = {\n\u0026nbsp;number: number\n\u0026nbsp;name: string\n\u0026nbsp;email: string\n}\n\nconst [user, setUser] = useState\u0026lt;User\u0026gt;({} as User)\n\n// 型アサーションを使えばコンパイルエラーが出ない\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eただし型アサーションはTypeScriptに型を偽っているだけなので、もし必要なプロパティを忘れていてもコンパイラエラーが指摘してくれないので、なるべく初期値を設定して型アサーションを使わずに済む実装にした方がベターです。\u003cbr\u003e\u003cbr\u003eもし全てのプロパティが任意ならば、初期値に空オブジェクトを与えても問題ないので型アサーションは必要ありません。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype User = {\u0026nbsp;\n\u0026nbsp;name?: string\n\u0026nbsp;email?: string\n\u0026nbsp;age?: number\n}\n\nconst [user, setUser] = useState\u0026lt;User\u0026gt;({})\n\n// userはUser型のうち任意のプロパティを持つ（空オブジェクトの可能性もある）\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h6553d2c03c\"\u003e useEffect\u003c/h2\u003e\u003cp\u003euseEffectの戻り値は \u003ccode\u003eundefined\u003c/code\u003e もしくはクリーンアップ関数と決められており、戻り値を処理しないため型は必要ありません。  \u003cbr\u003e\u003cbr\u003eただし関数や値を返してしまうとエラーになるので、アロー関数の書き方に注意が必要です。\u003cbr\u003e\u003cbr\u003e以下の書き方では、アロー関数式\u003ccode\u003e=\u0026gt;\u003c/code\u003eの本体に波括弧\u003ccode\u003e{}\u003c/code\u003eなしに1行で書いた文が戻り値になってしまいます。   \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003euseEffect(() =\u0026gt;\u0026nbsp;\n\u0026nbsp;setTimeout(() =\u0026gt;\u0026nbsp;\n\u0026nbsp;\u0026nbsp;// 処理\n\u0026nbsp;, 1000);\n, []);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e以下のように、本体を \u003ccode\u003e{}\u003c/code\u003e で囲むようにしてください。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003euseEffect(() =\u0026gt; {\n\u0026nbsp;setTimeout(() =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// 処理\n\u0026nbsp;}, 1000);\n}, []);\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h7cf02dc148\"\u003e イベントオブジェクトの型\u003c/h2\u003e\u003cp\u003eonClickやonChangeといったイベントハンドラで扱うイベントにも型があります。\u003cbr\u003e\u003cbr\u003eイベントオブジェクトの型を知りたいときは、VSCodeがヒントをくれます。\u003cbr\u003e\u003cbr\u003e例えばonClickなら、以下の状態でonClickの上にマウスをホバーさせると型情報を表示してくれます。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;button onClick={}\u0026gt;\u0026lt;/button\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e以下のように要素のイベント属性に直接イベントハンドラを書く場合は、引数のイベントの型は推論されるので注釈が要りません。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e\u0026lt;button onClick={(event) =\u0026gt; //処理 }\u0026gt;\u0026lt;/button\u0026gt;\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003eイベントハンドラの関数を別途定義する場合は、通常の関数と同様に型付けが必要になります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h745a3f474e\"\u003e onClickイベント\u003c/h3\u003e\u003cp\u003e引数のイベントと戻り値に型付けをします。（戻り値は推論させてもOKです）\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// Buttonクリックの場合\nconst onClickButton = ( event: React.MouseEvent\u0026lt;HTMLButtonElement, MouseEvent\u0026gt; ):void =\u0026gt; {\n\u0026nbsp;// 処理\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hc860cddeda\"\u003e onChangeイベント\u003c/h3\u003e\u003cpre\u003e\u003ccode\u003e// Inputの場合\nconst onChangeInput = ( event: React.ChangeEvent\u0026lt;HTMLInputElement\u0026gt;):void =\u0026gt; {\n\u0026nbsp;// 処理\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h0591b223f6\"\u003e 複数種類の要素にイベントを適用する\u003c/h3\u003e\u003cp\u003e上記の例を見ると、ジェネリック型の部分に \u003ccode\u003eHTMLButtonElement\u003c/code\u003e \u003ccode\u003eHTMLInputElement\u003c/code\u003e とあるように特定のHTML要素のための型であることがわかります。   \u003cbr\u003e\u003cbr\u003eもしDivタグ・Buttonタグ・Inputタグなどに同じイベントハンドラ関数を指定したい場合、通常は \u003ccode\u003eHTMLButtonElement | HTMLInputElement | 続く...\u003c/code\u003e と使いたい要素分の型を記述する必要があります。  \u003cbr\u003e\u003cbr\u003eそんな時は、色んなHTML要素に共通して使える \u003ccode\u003eHTMLElement\u003c/code\u003e 型を使うこともできます。  \u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003etype Props = {\n\u0026nbsp;onClick: (event: React.MouseEvent\u0026lt;HTMLElement, MouseEvent\u0026gt;) =\u0026gt; void\n}\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e以下の記事に詳しくまとめられており、非常に分かりやすかったです。\u003cbr\u003e\u003cbr\u003e個人的には、精度を高めるためには面倒でも使う要素分だけ指定する方が良いのかな…？とも思いますが、 \u003ccode\u003eHTMLButtonElem ent\u003c/code\u003e  も\u003ccode\u003e HTMLInputElement\u003c/code\u003e も\u003ccode\u003eHTMLElement\u003c/code\u003e 型を継承しているんだと知り、勉強になりました。\u003cbr\u003e\u003ca href=\"https://qiita.com/Takepepe/items/f1ba99a7ca7e66290f24\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eany型で諦めない React.EventCallback - Qiita\u003c/a\u003e \u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hadc4cddfcc\"\u003e 【番外編】Axios\u003c/h2\u003e\u003cp\u003eAxiosを使って非同期通信を行う際に返されるレスポンスやエラーにも型があります。\u003cbr\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eimport { AxiosError, AxiosResponse } from 'axios'\n\naxios\n\u0026nbsp;.get('/url')\n\u0026nbsp;.then((response: AxiosResponse) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// 成功時の処理\n\u0026nbsp;})\n\u0026nbsp;.catch((error: AxiosError) =\u0026gt; {\n\u0026nbsp;\u0026nbsp;// エラー時の処理\n\u0026nbsp;})\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h691cb018bd\"\u003e おわりに\u003c/h2\u003e\u003cp\u003e正直はじめは、何か書くたびにエラーが出るしコード量が増えて余計にわけわからんと思いました。\u003cbr\u003e\u003cbr\u003eでも慣れてくると、型が明示してあると処理の流れを追わなくてもどういう値が入って来るのかパッと見でも分かりやすいし、エディタの補完が効くのは便利で間違いがあれば気付けてTypeScript良いなと思うようになりました。\u003cbr\u003e\u003cbr\u003e今後もより実用的でスマートな型の活用法を学んでいきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3937880ed1\"\u003e 参考記事\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://github.com/typescript-cheatsheets/react\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://github.com/typescript-cheatsheets/react\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/sangotaro/items/3ea63110517a1b66745b#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com/sangotaro/items/3ea63110517a1b66745b#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/FumioNonaka/items/4361d1cdf34ffb5a5338#%E3%83%95%E3%83%83%E3%82%AF\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://qiita.com/FumioNonaka/items/4361d1cdf34ffb5a5338#%E3%83%95%E3%83%83%E3%82%AF\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"typescript","createdAt":"2022-01-07T13:18:58.358Z","updatedAt":"2022-02-17T03:22:47.524Z","publishedAt":"2022-01-07T13:18:58.358Z","revisedAt":"2022-02-17T03:22:47.524Z","tag":"TypeScript"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"}],"image":"typescript"},{"id":"cors","createdAt":"2022-02-12T11:27:21.400Z","updatedAt":"2022-02-12T11:40:40.611Z","publishedAt":"2021-12-29T11:27:21.000Z","revisedAt":"2022-02-12T11:40:40.611Z","title":"同一オリジンポリシーとCORS","body":"\u003ch2 id=\"hd92040d0df\"\u003eきっかけ\u003c/h2\u003e\u003cp\u003e業務で、Next.jsのフロント側からLaravelのAPIを叩いた時に\u003cstrong\u003eCORSエラー\u003c/strong\u003eというのが出ました。\u003cbr\u003e\u003cbr\u003eエラー解消法はすぐに見つかったものの、セキュリティやその対策の仕組みについてはきちんと理解して実装したいと思い、色々調べたのでまとめておきます。\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"he84d5455fa\"\u003e同一オリジンポリシー\u003c/h1\u003e\u003cp\u003eCORSについて理解するためには、前提として「同一オリジンポリシー」について知る必要があります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h19b65993c4\"\u003eオリジンとは\u003c/h3\u003e\u003cp\u003eドメイン＋プロトコル＋ポート番号 を合わせたもの。\u003cbr\u003e\u003cbr\u003e【例】\u003cbr\u003e・ドメイン (domain)：yahoo.co.jp\u003cbr\u003e・オリジン (origin)：\u0026nbsp;\u003ca style=\"color:#4aac00\" href=\"https://yahoo.co.jp/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003ehttps://yahoo.co.jp:443\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"ha2aa5c29c6\"\u003e「同一オリジンである」とは\u003c/h3\u003e\u003cp\u003eドメイン・プロトコル・ポート番号の全てが一致している場合のこと。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h583e348ae7\"\u003e同一オリジンポリシー（Same-Origin Policy）とは\u003c/h3\u003e\u003cp\u003eMDNには以下のように書いてあります。\u003cbr\u003e\u003c/p\u003e\u003cblockquote\u003e\u003cstrong\u003e同一オリジンポリシー\u003c/strong\u003eは重要なセキュリティの仕組みであり、ある\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Glossary/Origin\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eオリジン\u003c/a\u003eによって読み込まれた文書やスクリプトが、他のオリジンにあるリソースにアクセスできる方法を制限するものです。\u003cbr\u003e\u003ca style=\"color:#4aac00\" href=\"https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e同一オリジンポリシー - ウェブセキュリティ | MDN\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003c/blockquote\u003e\u003cp\u003e要するに、別のオリジンへのアクセスに制限をかけることで、XSSやCSRFといった攻撃を防ぐことを目的とするセキュリティの仕組みです。\u003cbr\u003e\u003cbr\u003eXSSとCSRFについてそれぞれの詳しい攻撃手法はここでは取り上げませんが、対策を講じる上での要点を挙げておきます。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hafaeffc4cb\"\u003eXSS (Cross Site Scripting)\u003c/h3\u003e\u003cp\u003eユーザーが 意図しない不正なスクリプトが\u0026nbsp;Webサーバーに送られ、Webサーバーからのレスポンスを受け取ってしまった結果\u003cstrong\u003eクライアント側 (Web ブラウザ)\u003c/strong\u003e\u0026nbsp;で実行される攻撃。\u003cbr\u003e\u003cbr\u003eブラウザ上で出来ることは何でも悪用対象になるので、CSRFより攻撃範囲が広い。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hc9f9aae59b\"\u003e\u003cstrong\u003eCSRF (Cross-Site Request Forgeries)\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003eユーザーが意図しない不正なスクリプトがWebサーバーに送られ、\u0026nbsp;\u003cstrong\u003eWeb アプリケーション (Web サーバー)\u003c/strong\u003e\u0026nbsp;上で実行される攻撃。通称「しーさーふ」。\u003cbr\u003e\u003cbr\u003e悪用内容はサーバー側で用意された処理に限定されるが、\u0026nbsp;\u003cstrong\u003eサーバーにリクエストが到達するだけで攻撃が成立する\u003c/strong\u003eので、XSS対策はできていてもCSRF対策は出来ていないということもあり得る。\u003cbr\u003e\u003cbr\u003e\u003cbr\u003eJavaScript の組み込み API でありAjax 通信を実現する\u0026nbsp;\u003ccode\u003eXMLHttpRequest (XHR)\u003c/code\u003e\u0026nbsp;や\u0026nbsp;\u003ccode\u003eFetch API\u003c/code\u003e\u0026nbsp;などは、これらの脆弱性を回避するため\u003cstrong\u003e同一オリジンポリシー\u003c/strong\u003e（別のオリジンへのアクセスに制限をかける仕組み）に従っています。\u003cbr\u003eXSSとCSRFについての詳細は、以下の記事が分かりやすく勉強になりました。\u003cbr\u003e\u003ca href=\"https://qiita.com/att55/items/a50ca43adde206017525\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eXSS と CSRF って結局何が違うのか？ - Qiita\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e\u003ch1 id=\"h027a034520\"\u003eCORS\u003c/h1\u003e\u003cp\u003e同一オリジンポリシーについて抑えたところで、CORSについて見ていきます。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"hac1783c7e1\"\u003eCORSとは\u003c/h2\u003e\u003cp\u003e読み方：コルス or シーオーアールエス\u003cbr\u003e\u003cstrong\u003eC\u003c/strong\u003eross-\u003cstrong\u003eO\u003c/strong\u003erigin\u0026nbsp;\u003cstrong\u003eR\u003c/strong\u003eesource\u0026nbsp;\u003cstrong\u003eS\u003c/strong\u003eharing の略で、日本語訳すると「\u003cstrong\u003eオリジン間リソース共有\u003c/strong\u003e」。\u003cbr\u003e\u003cbr\u003eCORSは、あるオリジンで動いているWebアプリケーションから別のオリジンのサーバーへのアクセスを許可する仕組みです。\u003cbr\u003e\u003cbr\u003e同一オリジンポリシーにより別のオリジンにはアクセスが出来ないという規制があるが、Web開発・制作では異なるオリジンにアクセスしたいケースもある…　\u003cbr\u003eそこで、同一オリジンポリシーの制約を回避・緩和してくれるのがCORSです。\u003cbr\u003e\u003cbr\u003e歴史をたどるとCORSが必要になった経緯がさらによく分かります。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h3aecdd16f5\"\u003e同一オリジンポリシーはあるが、CORSはない場合…（過去のブラウザ）\u003c/h3\u003e\u003cp\u003e出来たこと\u003c/p\u003e\u003cul\u003e\u003cli\u003e同一オリジンポリシーによりJavaScriptの安全性は確保される。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e生まれた課題\u003c/p\u003e\u003cul\u003e\u003cli\u003eAjaxの普及・発展により、異なるオリジン（主に異なるホスト）のAPIを呼び出したいという動機が生まれた。\u003c/li\u003e\u003cli\u003eJSONPなど同一オリジンポリシーの範囲内で異なるオリジンのAPIを呼び出す方法が考案されたが、裏技のようなものであって安全性には課題が残っていた。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"h510870a262\"\u003eそこで生まれたCORS\u003c/h3\u003e\u003cp\u003e上記のような課題を解決するため生まれたCORSは、以下の機能を提供します。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eクロスオリジンのアクセスを許可\u003c/li\u003e\u003cli\u003eオリジン単位でのアクセス制御が可能（例：オリジンA・オリジンBとの通信のみ許可する）\u003c/li\u003e\u003cli\u003eHTTPヘッダを用いてアクセス制御を行う\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h922d87a02b\"\u003eCORSはどうやってクロスオリジン通信を許可するのか\u003c/h2\u003e\u003cp\u003e以下のように事前に通信を行う双方で設定を行っておくことで、クロスオリジンの通信が可能になります。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eクライアントサイド\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eHTTPリクエストヘッダに\u003ccode\u003eOriginヘッダ\u003c/code\u003eを付ける。\u003cbr\u003e\u003cbr\u003e・XHRの場合：自動でOriginヘッダが付くので何もしなくて良い\u003cbr\u003e・FetchAPIの場合：mode: cors を付与する\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eサーバーサイド\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eHTTPレスポンスヘッダに以下を付ける。\u003cbr\u003e※レスポンスヘッダを付ける方法は環境によって様々です。\u003cbr\u003eLaravelの場合は、Laravel7.0以降は\u003cstrong\u003e\u003ccode\u003econfig/cors.php\u003c/code\u003e\u003c/strong\u003e\u0026nbsp;を使ってCORSの設定ができます。\u003cbr\u003e\u003cbr\u003e\u003cstrong\u003e＊必須＊\u003c/strong\u003e\u003cbr\u003e・\u003ccode\u003eAccess-Control-Allow-Origin: アクセス元のオリジン\u003c/code\u003e\u003cbr\u003e\u003cstrong\u003e＊必要な場合のみ＊\u003c/strong\u003e\u003cbr\u003e・Access-Control-Allow-Credentials: true（Cookieを送信する場合は必要）\u003cbr\u003e・Access-Control-Allow-Headers\u003cbr\u003e・Access-Control-Request-Method\u003cbr\u003e・Access-Control-Max-Age\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h6562eef876\"\u003eCORSによるアクセス制御の流れ\u003c/h2\u003e\u003cp\u003e実際にCORSがアクセス制御を行う流れを、ブラウザの検証ツールのネットワークを観察して確認します。\u003cbr\u003e\u003cbr\u003e【前提】\u003cbr\u003e・フロント側（Next.js）をlocalhost:3001、API（Laravel）をlocalhost:8080で開発中。\u003cbr\u003e・localhost:3001のフロント側から、localhost:8080/logoutというURLにアクセスしてAPIをたたき、クロスオリジンの通信を発生させる。\u003cbr\u003e・リクエストはXHRにより行うので、リクエストヘッダには自動的にOriginヘッダが付く。\u003cbr\u003e・localhost:3001からのリクエストがあった場合は、レスポンスヘッダにAccess-Control-Allow-Originを載せるように、事前にAPI側で設定している。\u003cbr\u003e\u003cbr\u003e【実際の流れ】\u003cbr\u003e1.　ブラウザでlocalhost:3001にアクセスする。\u003cbr\u003e2.　localhots:3001からlocalhost:8080/logoutへHTTPリクエストを送る。\u003cbr\u003e　\u0026lt;ポイント\u0026gt; リクエストヘッダのOriginという項目に、リクエスト元のドメイン情報が載せられる。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003eOrigin: http://localhost:3001\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e3.　レスポンスが返ってきたら、localhost:3001はlocalhost:8080からのレスポンスヘッダを見て、レスポンスを受け取るかどうか判断する。\u003cbr\u003e　\u0026lt;ポイント\u0026gt;　レスポンスヘッダに\u0026nbsp;\u003ccode\u003eAccess-Control-Allow-Origin\u003c/code\u003e\u0026nbsp;という項目があり、自分のドメイン情報（localhost:3001）が載せられていればレスポンスを受け取る。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e// レスポンスヘッダに以下の記載があれば、レスポンスを受け取る\nAccess-Control-Allow-Origin：http://localhost:3001\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"h5d7a611c3a\"\u003e\u003cbr\u003eCORSエラーを起こしてみる\u003c/h3\u003e\u003cp\u003e上記の例では、事前にAPI側（Laravelのconfig/cors.php）でlocalhost:3001からのリクエストに対してAccess-Control-Allow-Originを返す設定をしていた為、クロスオリジンの通信が成立していました。\u003cbr\u003e\u003cbr\u003e試しにAPI側で設定を行っている箇所を削除してみると、レスポンスヘッダに\u0026nbsp;\u003ccode\u003eAccess-Control-Allow-Origin：http://localhost:3001\u003c/code\u003e\u0026nbsp;が無いので、CORSエラーが起こります。\u003cbr\u003e\u003cbr\u003eここでのエラーは、リクエスト自体は送っているけれど、レスポンスが返って来た時にそれを受け取らず\u003cstrong\u003eレスポンスエラー\u003c/strong\u003eということになっています。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h119f62b8ee\"\u003eプリフライトリクエスト\u003c/h2\u003e\u003ch3 id=\"hf8c9fef3ec\"\u003e無条件でリクエストが飛んでも大丈夫なのか？\u003c/h3\u003e\u003cp\u003eCORSの設定をしていないとエラーが発生して通信は成立しませんでしたが、そのエラーはあくまで\u003cstrong\u003eレスポンスを受け取らない\u003c/strong\u003eというものでした。\u003cbr\u003e\u003cbr\u003eしかし、そもそもリクエストが飛んで良いのか？という懸念が残ります。\u003cbr\u003e\u003cbr\u003e代表的なリスクがCSRFです。\u003cbr\u003e\u0026nbsp;\u003cstrong\u003eCSRFではレスポンスを受け取る必要は無く、リクエストが送信できれば攻撃できます。\u003c/strong\u003e\u003cbr\u003e\u003cbr\u003eこのようなリスク対策として、プリフライトリクエストが生まれました。\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"hbcb48602bc\"\u003eプリフライトリクエストの考え方\u003c/h3\u003e\u003cul\u003e\u003cli\u003e元々CORSが無いときにできていたクロスオリジンのリクエストに対して、大幅なリスク増にならない条件であれば、XHR等で無条件にクロスオリジンのリクエストを送信できるようにした。\u003c/li\u003e\u003cli\u003e「大幅なリスク増にならない」条件を単純リクエストとして定義した。\u003c/li\u003e\u003cli\u003e単純リクエストの要件を超える場合は、実際のリクエストを送る前にプリフライトリクエストを送り、実際のリクエストを送信して問題無いか事前に確認する。\u003c/li\u003e\u003cli\u003eプリフライトリクエストを挟むことで、プリフライトリクエストを送信した結果Access-Control-Allow-OriginのHTTPヘッダがついたレスポンスが返されなければ、実際のリクエストは送信しない、というように悪意あるリクエストを防ぐ。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch3 id=\"he303012d4a\"\u003e単純リクエスト（Simple Request）の要件\u003c/h3\u003e\u003cp\u003e以下の要件を全て満たす場合のみ、単純リクエストとなります。\u003cbr\u003e\u003c/p\u003e\u003cul\u003e\u003cli\u003eメソッドは「GET, POST, HEAD」のいずれか\u003c/li\u003e\u003cli\u003e設定できるリクエストヘッダは以下のいずれか\u003cul\u003e\u003cli\u003eAccept\u003c/li\u003e\u003cli\u003eAccept-Language\u003c/li\u003e\u003cli\u003eContent-Language\u003c/li\u003e\u003cli\u003eContent-Type（条件付き）\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003eContent-Typeについては以下のいずれかを満たすこと\u003cul\u003e\u003cli\u003eapplication/x-www-form-urlencoded\u003c/li\u003e\u003cli\u003emultipart/form-data（ファイルアップロードに使う）\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003etext/plain（滅多に使わない）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"ha214098e44\"\u003eまとめ\u003c/h2\u003e\u003cul\u003e\u003cli\u003eXSSやCSRFなどの対策として、他のオリジンへのアクセスを制限する「同一オリジンポリシー」という仕組みがある。\u003c/li\u003e\u003cli\u003e他のオリジンへアクセスしたい、でも安全性も保ちたい、、を叶えるためCORSが生まれた。\u003c/li\u003e\u003cli\u003e通常のCORSはレスポンスが届いたときにレスポンスを受け取るかどうかの制御を行うので、リクエスト自体は無条件に飛んでしまう。そこで不正なリクエストが送られてしまうリスク対策として、プリフライトリクエストが生まれた。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"h3bcda3e6b0\"\u003e最後に\u003c/h2\u003e\u003cp\u003eエラーが解消されて動けばOKではなく、きちんと仕組みを調べてみてかなり理解が深まったかなと思います。（もし誤りがあれば是非ご指摘いただけると幸いです…！！）\u003cbr\u003e\u003cbr\u003eこれまでHTTPリクエストヘッダやレスポンスヘッダをまじまじと見たことも無かったので、Ajax通信を行っている箇所で検証ツールを確認してみると面白かったです。\u003cbr\u003e確かにOriginやAccess-Control-Allow-Originがあったり、プリフライトリクエストが送られてレスポンスが返って来てから本番のリクエストが送られているのが確認できて、勉強になりました。\u003cbr\u003eセキュリティ対策についてしっかり理解できていなくても動くアプリを作ることが出来てしまうというのは怖いことだなと思うので、これからもセキュリティの勉強はしていきたいと思います。\u003cbr\u003e\u003c/p\u003e\u003ch2 id=\"he45680f0bc\"\u003e参考記事\u003c/h2\u003e\u003cp\u003e\u003cbr\u003e\u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTTP/CORS\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eオリジン間リソース共有 (CORS) - HTTP | MDN\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://labor.ewigleere.net/2020/10/13/cors_preflight_request_verification/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eCORS の挙動の観察と preflight request の検証\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://it-web-life.com/javascript_cors_preflight/\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e【CORS】JavaScriptにおけるCORSやPreflightを理解する\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://programmer-life.work/html_css/html-request\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eHTTPリクエストとは？HTTPリクエストを目で確認したい | Programmer LifeHTTPリクエストとは？HTTPリクエストを目...\u003c/a\u003e\u003cbr\u003e\u003cbr\u003e\u003ca href=\"https://qiita.com/att55/items/2154a8aad8bf1409db2b\" target=\"_blank\" rel=\"noopener noreferrer\"\u003eなんとなく CORS がわかる...はもう終わりにする。 - Qiita\u003c/a\u003e\u003cbr\u003e\u003c/p\u003e","tags":[{"id":"web","createdAt":"2022-01-07T13:19:12.628Z","updatedAt":"2022-02-12T02:32:09.404Z","publishedAt":"2022-01-07T13:19:12.628Z","revisedAt":"2022-01-07T13:19:12.628Z","tag":"Web"}],"image":"other"}],"tags":[{"id":"laravel","createdAt":"2022-01-07T13:17:32.553Z","updatedAt":"2022-02-12T02:31:33.697Z","publishedAt":"2022-01-07T13:17:32.553Z","revisedAt":"2022-01-07T13:17:38.700Z","tag":"Laravel"},{"id":"php","createdAt":"2022-01-07T13:16:36.618Z","updatedAt":"2022-02-12T02:31:46.498Z","publishedAt":"2022-01-07T13:16:36.618Z","revisedAt":"2022-01-07T13:16:36.618Z","tag":"PHP"},{"id":"react","createdAt":"2022-01-07T13:17:54.189Z","updatedAt":"2022-02-12T02:31:51.382Z","publishedAt":"2022-01-07T13:17:54.189Z","revisedAt":"2022-01-07T13:17:54.189Z","tag":"React"},{"id":"nextjs","createdAt":"2022-01-07T13:18:14.144Z","updatedAt":"2022-02-12T02:31:58.832Z","publishedAt":"2022-01-07T13:18:14.144Z","revisedAt":"2022-01-07T13:18:14.144Z","tag":"Next.js"},{"id":"typescript","createdAt":"2022-01-07T13:18:58.358Z","updatedAt":"2022-02-17T03:22:47.524Z","publishedAt":"2022-01-07T13:18:58.358Z","revisedAt":"2022-02-17T03:22:47.524Z","tag":"TypeScript"},{"id":"javascript","createdAt":"2022-01-07T13:18:33.680Z","updatedAt":"2022-01-07T13:18:33.680Z","publishedAt":"2022-01-07T13:18:33.680Z","revisedAt":"2022-01-07T13:18:33.680Z","tag":"JavaScript"},{"id":"web","createdAt":"2022-01-07T13:19:12.628Z","updatedAt":"2022-02-12T02:32:09.404Z","publishedAt":"2022-01-07T13:19:12.628Z","revisedAt":"2022-01-07T13:19:12.628Z","tag":"Web"},{"id":"docker","createdAt":"2022-02-12T02:32:18.767Z","updatedAt":"2022-02-12T10:02:36.384Z","publishedAt":"2022-02-12T02:32:18.767Z","revisedAt":"2022-02-12T10:02:36.384Z","tag":"Docker"},{"id":"microcms","createdAt":"2022-02-17T12:48:01.991Z","updatedAt":"2022-02-17T12:48:13.704Z","publishedAt":"2022-02-17T12:48:01.991Z","revisedAt":"2022-02-17T12:48:01.991Z","tag":"microCMS"},{"id":"git","createdAt":"2022-02-17T13:32:37.262Z","updatedAt":"2022-02-17T13:32:43.655Z","publishedAt":"2022-02-17T13:32:37.262Z","revisedAt":"2022-02-17T13:32:37.262Z","tag":"Git"}]},"__N_SSG":true},"page":"/","query":{},"buildId":"EwuWiZmkeG3lYlO_XC9fM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>